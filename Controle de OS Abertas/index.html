<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìã Controle de OS Abertas</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script>
        (function(){
            try {
                var raw = localStorage.getItem('authUser');
                var auth = raw ? JSON.parse(raw) : null;
                // Mant√©m o usu√°rio atual acess√≠vel e controla exibi√ß√£o da tela de login dentro do pr√≥prio index
                window.NormaQCurrentUser = auth || null;
                var requireLogin = !auth;
                window.NormaQRequireLogin = requireLogin;
                // Usa uma classe na raiz para controlar visibilidade via CSS
                document.documentElement.classList.toggle('require-login', requireLogin);
            } catch (e) {
                window.NormaQCurrentUser = null;
                window.NormaQRequireLogin = true;
                document.documentElement.classList.add('require-login');
            }
        })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        :root {
            --primary-color: #FCB026;
            --primary-dark: #E5B000;
            --primary-light: #FED033;
            --white: #FFFFFF;
            --light-gray: #F5F5F5;
            --dark-gray: #333333;
            --medium-gray: #666666;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --success-dark: #1e7e34;
            --roxo: #6f42c1; /* NOVA COR: Concluindo */
            --marrom: #8B4513; /* NOVA COR: Em Atendimento */
            --preto: #000000; /* NOVA COR: Cancelado */
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light-gray);
            color: var(--dark-gray);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 28px;
            flex: 1;
            width: 100%;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: var(--white);
            padding: 20px 0;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
        }
        
        .logo {
            height: 60px;
            margin-right: 15px;
            background-color: white;
            padding: 5px;
            border-radius: 5px;
        }
        
        .header-title {
            font-size: 28px;
            font-weight: 700;
        }
        
        .header-subtitle {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .datetime-container {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            text-align: right;
        }
        
        .current-time {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .current-date {
            font-size: 16px;
            margin-bottom: 3px;
        }
        
        .current-day {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .tabs-container {
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            margin-bottom: 20px;
            width: 100%;
        }
        
        .tabs {
            display: flex;
            background-color: var(--primary-color);
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            color: var(--white);
            font-weight: 600;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .tab:hover {
            background-color: var(--primary-dark);
        }
        
        .tab.active {
            background-color: var(--white);
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }
        
        .tab-content {
            display: none;
            padding: 32px;
            animation: fadeIn 0.5s ease;
            width: 100%;
        }
        
        .tab-content.active {
            display: block;
        }

        .custom-select-wrapper {
            position: relative;
            display: inline-block;
            width: 200px;
        }

        .custom-select {
            display: none;
        }

        .select-selected {
            background-color: #f1f1f1;
            padding: 8px 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
        }

        .select-selected:after {
            position: absolute;
            content: "";
            top: 14px;
            right: 10px;
            width: 0;
            height: 0;
            border: 6px solid transparent;
            border-color: #333 transparent transparent transparent;
        }

        .select-selected.select-arrow-active:after {
            border-color: transparent transparent #333 transparent;
            top: 7px;
        }

        .select-items {
            position: absolute;
            background-color: #f1f1f1;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 99;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
        }

        .select-hide {
            display: none;
        }

        .select-items div {
            padding: 8px 16px;
            cursor: pointer;
        }

        .select-items div:hover {
            background-color: #ddd;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--light-gray);
            border-radius: 8px;
            width: 100%;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-label {
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 14px;
        }
        
        .filter-select, .filter-input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .filter-multiselect {
            position: relative;
        }
        
        .filter-multiselect select {
            width: 100%;
            height: 40px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
        }
        
        .filter-multiselect select:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .filter-multiselect select option {
            padding: 8px;
        }
        
        .filter-multiselect select[multiple] {
            height: auto;
            min-height: 80px;
            background-image: none;
            padding: 8px;
        }
        
        .filter-multiselect select[multiple] option {
            padding: 5px 8px;
            margin: 2px 0;
            border-radius: 3px;
        }
        
        .filter-multiselect select[multiple] option:checked {
            background-color: var(--primary-color);
            color: white;
        }
        
        .totals-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 15px;
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            align-items: center;
        }
        /* Wrapper √† direita para agrupar total geral e indicador */
        .totals-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .total-item {
            text-align: center;
            flex: 1;
            padding: 10px;
            border-right: 1px solid #eee;
        }
        
        .total-item:last-child {
            border-right: none;
        }
        
        .total-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .total-label {
            font-size: 14px;
            color: var(--medium-gray);
        }
        
        .total-geral-os {
            background-color: var(--primary-color);
            color: var(--white);
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-left: 20px;
        }

        /* Indicador inline por aba (lado direito dos totais) */
        .update-indicator-inline {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 14px;
            padding: 6px 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #0066cc;
            white-space: nowrap;
        }
        .update-indicator-inline::before {
            content: "üîÑ";
            font-size: 14px;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            background-color: var(--white);
            max-height: 500px;
            overflow-y: auto;
            width: 100%;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        th, td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        th {
            background-color: var(--primary-color);
            color: var(--white);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
        }
        
        th.sortable:hover {
            background-color: var(--primary-dark);
        }
        
        th.sort-asc::after {
            content: " ‚ñ≤";
            font-size: 10px;
        }
        
        th.sort-desc::after {
            content: " ‚ñº";
            font-size: 10px;
        }
        
        tr:hover {
            background-color: rgba(252, 176, 38, 0.05);
        }
        
        .col-revenda { width: 80px; min-width: 80px; }
        .col-nro-os { width: 100px; min-width: 100px; }
        .col-situacao { width: 90px; min-width: 90px; }
        .col-tipo { width: 90px; min-width: 90px; }
        .col-emissao { width: 90px; min-width: 90px; }
        .col-dias { width: 70px; min-width: 70px; }
        .col-dias-aberto { width: 80px; min-width: 80px; }
        .col-status { width: 120px; min-width: 120px; }
        .col-cliente { width: 180px; min-width: 180px; }
        .col-chassi { width: 140px; min-width: 140px; }
        .col-consultor { width: 150px; min-width: 150px; }
        .col-observacao { width: 200px; min-width: 200px; }
        .col-acao-atualizacao { width: 200px; min-width: 200px; }
        .col-escalonamento { width: 120px; min-width: 120px; }
        .col-acao { width: 100px; min-width: 100px; }
        .col-selecao { width: 50px; min-width: 50px; }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
            text-align: center;
            min-width: 60px;
        }
        
        .status-aberta {
            background-color: var(--warning);
            color: var(--dark-gray);
        }
        
        .status-fechada {
            background-color: var(--success);
            color: var(--white);
        }
        
        .dias-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            color: var(--white);
            display: inline-block;
            text-align: center;
            min-width: 50px;
        }
        
        .dias-0-10 { background-color: #28a745; }
        .dias-11-15 { background-color: #ffc107; color: #333; }
        .dias-16-20 { background-color: #fd7e14; }
        .dias-21-30 { background-color: #dc3545; }
        .dias-30-plus { background-color: #6f42c1; }
        
        .status-os-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-align: center;
            display: inline-block;
            min-width: 100px;
            cursor: pointer;
        }
        
        .status-sem-status { background-color: #e9ecef; color: #495057; }
        .status-pendente-peca { background-color: #dc3545; color: white; }
        .status-pendente-programacao { background-color: #dc3545; color: white; }
        .status-pendente-submissao { background-color: #dc3545; color: white; }
        .status-programado { background-color: #fd7e14; color: white; }
        .status-submissao-aprovada { background-color: #28a745; color: white; }
        .status-submissao-processamento { background-color: #ffc107; color: #333; }
        .status-em-negociacao { background-color: #17a2b8; color: white; }
        .status-servico-concluido { background-color: var(--success-dark); color: white; }
        .status-concluindo { background-color: var(--roxo); color: white; } /* NOVO STATUS */
        .status-em-atendimento { background-color: var(--marrom); color: white; } /* NOVO STATUS */
        .status-cancelado { background-color: var(--preto); color: white; } /* NOVO STATUS */
        
        /* Controle de Colunas */
        .column-toggle {
            cursor: pointer;
            font-size: 12px;
            margin-left: 5px;
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }
        
        .column-toggle:hover {
            opacity: 1;
        }
        
        .column-hidden {
            display: none !important;
        }
        
        /* Novos controles de colunas */
        .table-controls {
            margin-bottom: 15px;
            display: flex;
            justify-content: flex-end;
        }
        
        .columns-control-btn {
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 12px;
        }
        
        .columns-control-btn:hover {
            background-color: var(--primary-dark);
        }
        
        .columns-menu {
            position: absolute;
            background: var(--white);
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 15px;
            z-index: 1000;
            min-width: 250px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .columns-menu h4 {
            margin-bottom: 10px;
            color: var(--dark-gray);
            font-size: 14px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        .column-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .column-item:last-child {
            border-bottom: none;
        }
        
        .column-item label {
            cursor: pointer;
            flex: 1;
            margin-left: 8px;
        }
        
        .column-item input[type="checkbox"] {
            cursor: pointer;
        }
        
        .download-matrix-btn {
            background-color: var(--success);
            color: var(--white);
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 12px;
            margin-top: 10px;
            width: 100%;
        }
        
        .download-matrix-btn:hover {
            background-color: var(--success-dark);
        }
        
        .escalonamento-badge {
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            background-color: #e9ecef;
            color: #495057;
            display: inline-block;
            text-align: center;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 12px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: var(--white);
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        
        .btn-success {
            background-color: var(--success);
            color: var(--white);
        }
        
        .btn-success:hover {
            background-color: #218838;
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: var(--dark-gray);
        }

        .btn-secondary {
            background-color: #6c757d;
            color: #fff;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .btn-warning:hover {
            background-color: #e0a800;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 11px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: var(--white);
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: modalFadeIn 0.3s ease;
        }
        
        .modal-wide {
            max-width: 800px;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--medium-gray);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }
        
        .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid rgba(252, 176, 38, 0.3);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
           100% { transform: rotate(360deg); }
        }
        
        /* Estilos para Gerenciamento de Status */
        .status-management {
            padding: 20px;
        }
        
        .status-management h2 {
            color: var(--primary-color);
            margin-bottom: 30px;
            font-size: 24px;
        }
        
        .status-management h3 {
            color: var(--dark-gray);
            margin-bottom: 20px;
            font-size: 18px;
        }
        
        .status-form {
            background: var(--white);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            align-items: flex-end;
        }
        
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .form-row .form-group:last-child {
            flex: 0 0 auto;
        }
        
        .status-list {
            background: var(--white);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .status-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }

        .status-color-preview {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 10px;
        }

        .status-name {
            flex-grow: 1;
        }

        .status-actions button {
            margin-left: 5px;
        }
        
        .btn-edit {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-add-custom {
            background: var(--success);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .btn-edit-status {
            background: var(--warning);
            color: var(--dark-gray);
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-edit:hover {
            background: var(--primary-dark);
        }
        
        .btn-delete:hover {
            background: #c82333;
        }
        
        .btn-add-custom:hover {
            background: #218838;
        }
        
        .btn-edit-status:hover {
            background: #e0a800;
        }
        

        
        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .status-form-modern {
            background: var(--white);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .status-form-modern h3 {
            color: var(--primary-color);
            font-size: 20px;
            margin-bottom: 25px;
            font-weight: 600;
            border-bottom: 2px solid var(--primary-light);
            padding-bottom: 10px;
        }
        
        .form-group-modern {
            margin-bottom: 20px;
        }
        
        .form-group-modern label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-gray);
            font-size: 14px;
        }
        
        .form-input-modern {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: var(--white);
        }
        
        .form-input-modern:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(252, 176, 38, 0.1);
        }
        
        .color-picker-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .color-preview {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 2px solid #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }
        
        .color-presets {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        .color-preset {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }
        
        .color-preset:hover {
            transform: scale(1.1);
            border-color: var(--white);
        }
        
        .color-preset.active {
            border-color: var(--primary-color);
            transform: scale(1.1);
        }
        
        .btn-modern {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary-modern {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: var(--white);
        }
        
        .btn-primary-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(252, 176, 38, 0.3);
        }
        
        .btn-secondary-modern {
            background: var(--light-gray);
            color: var(--dark-gray);
        }
        
        .btn-secondary-modern:hover {
            background: #dee2e6;
        }
        
        .status-preview {
            background: var(--white);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            border: 2px dashed #e9ecef;
            text-align: center;
        }
        
        .status-preview-text {
            font-size: 14px;
            color: var(--dark-gray);
            margin-bottom: 10px;
        }
        
        .preview-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
        }
        
        .status-list-modern {
            background: var(--white);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .status-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .status-list-header h3 {
            color: var(--primary-color);
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }
        
        .search-container {
            position: relative;
            width: 250px;
        }
        
        .search-input {
            width: 100%;
            padding: 10px 16px 10px 40px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(252, 176, 38, 0.1);
        }
        
        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }
        
        .status-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .status-card {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            cursor: grab;
        }
        
        .status-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-color: var(--primary-light);
        }
        
        .status-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .status-card-color {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            margin-right: 12px;
            border: 2px solid var(--white);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .status-card-name {
            flex: 1;
            font-weight: 600;
            font-size: 16px;
            color: var(--dark-gray);
        }
        
        .status-card-actions {
            display: flex;
            gap: 8px;
        }
        
        .status-card-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 10px;
            background: #f8f9fa;
            color: #6c757d;
        }
        
        .status-card.system {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-color: #dee2e6;
        }
        
        .status-card.custom {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-left: 4px solid var(--primary-color);
        }
        
        .btn-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .btn-edit-icon {
            background: var(--primary-light);
            color: var(--primary-color);
        }
        
        .btn-edit-icon:hover {
            background: var(--primary-color);
            color: var(--white);
        }
        
        .btn-delete-icon {
            background: #fff5f5;
            color: #e53e3e;
        }
        
        .btn-delete-icon:hover {
            background: #e53e3e;
            color: var(--white);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-state p {
            font-size: 16px;
            margin: 0;
        }
        
        .system-statuses {
            margin-top: 30px;
            padding-top: 25px;
            border-top: 2px solid #e9ecef;
        }
        
        .system-statuses h4 {
            color: var(--dark-gray);
            font-size: 18px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .drag-handle {
            position: absolute;
            top: 12px;
            right: 12px;
            color: #6c757d;
            opacity: 0.5;
            cursor: grab;
            transition: opacity 0.2s ease;
        }
        
        .status-card:hover .drag-handle {
            opacity: 1;
        }
        
        @media (max-width: 1024px) {
            .status-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .status-cards {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .status-management-modern {
                padding: 20px;
            }
            
            .status-header h2 {
                font-size: 24px;
            }
            
            .status-form-modern,
            .status-list-modern {
                padding: 20px;
            }
            
            .color-presets {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .status-list-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            
            .search-container {
                width: 100%;
            }
        }
        
        .footer {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
            color: var(--white);
            text-align: center;
            padding: 30px 20px;
            border-radius: 0 0 10px 10px;
            width: 100%;
            /* Volta ao comportamento n√£o fixo */
            box-shadow: none;
            margin-top: 20px;
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .footer-main {
            font-size: 14px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .footer-sub {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .footer-contact {
            font-size: 12px;
            opacity: 0.8;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .footer-divider {
            margin: 0 10px;
            opacity: 0.6;
        }
        
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }
        
        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }
        .success-message .message-text { font-weight: 600; }

        /* Ajuste para evitar sobreposi√ß√£o do rodap√© fixo */
        /* Removido padding extra, rodap√© n√£o √© fixo */
        body { padding-bottom: 0; }

        /* Layout moderno para Transfer√™ncia */
        #transferencia-escalonamento .tabs { gap: 8px; }
        #transferencia-escalonamento .tab { border-radius: 8px; padding: 10px 14px; transition: transform .2s ease, box-shadow .2s ease; }
        #transferencia-escalonamento .tab.active { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(0,0,0,0.08); }
        #transferencia-escalonamento .filters { margin: 10px 0 16px; }
        #transferencia-escalonamento .filter-group { display: flex; align-items: center; gap: 10px; }
        #transferencia-escalonamento table { border-radius: 10px; overflow: hidden; box-shadow: 0 6px 18px rgba(0,0,0,0.06); }
        #transferencia-escalonamento thead { background: linear-gradient(135deg, #f6f7fb, #eef0f6); }
        #transferencia-escalonamento tbody tr { transition: background .2s ease; }
        #transferencia-escalonamento tbody tr:hover { background: rgba(0,0,0,0.03); }

        /* Anima√ß√£o sutil para linhas novas */
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(6px);} to { opacity: 1; transform: translateY(0);} }
        .row-animate { animation: fadeInUp .25s ease; }
        
        .observacao-text, .acao-atualizacao-text {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
        }
        
        .observacao-text.expanded, .acao-atualizacao-text.expanded {
            white-space: normal;
            overflow: visible;
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 100;
            max-width: 400px;
        }
        
        .table-row-count {
            text-align: center;
            padding: 10px;
            background-color: var(--light-gray);
            font-weight: 600;
            border-radius: 0 0 8px 8px;
        }
        
        .batch-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding: 15px;
            background-color: var(--light-gray);
            border-radius: 8px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .selected-count {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .update-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 2px8px rgba(0,0,0,0.1);
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 8px;
            background-color: var(--light-gray);
            border-radius: 4px;
        }
        
        .os-info {
            flex: 1;
            font-size: 12px;
        }
        
        .select-all-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .update-tab-section {
            background-color: var(--white);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px8px rgba(0,0,0,0.1);
        }
        
        .update-tab-section h2 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .update-tab-section h2::before {
            content: "üìã";
            font-size: 20px;
        }
        
        .update-tab-section h3 {
            color: var(--dark-gray);
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .update-tab-section p {
            margin-bottom: 15px;
            color: var(--medium-gray);
        }
        
        .base-selection {
            background-color: var(--light-gray);
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .os-list-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 15px;
        }
        
        .empty-state {
            text-align: center;
            padding: 30px;
            color: var(--medium-gray);
        }
        
        .os-checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .os-checkbox-item:last-child {
            border-bottom: none;
        }
        
        .os-checkbox-item:hover {
            background-color: rgba(252, 176, 38, 0.05);
        }
        
        .os-details {
            flex: 1;
            font-size: 12px;
        }
        
        .os-number {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .individual-search {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: flex-end;
        }
        
        .individual-search .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .individual-form {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background-color: var(--light-gray);
            border-radius: 6px;
        }
        
        .info-message {
            background-color: #d1ecf1;
            color: #0c5460;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid #17a2b8;
        }

        .debug-info {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 12px;
            font-family: monospace;
        }
        
        .status-column-hidden {
            display: none !important;
        }
        
        .status-filter-disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .status-update-disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .batch-status-section {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }
        
        .batch-status-select {
            min-width: 200px;
        }
        
        /* Estilos para o Dashboard - ATUALIZADOS */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .dashboard-card {
            background-color: var(--white);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        
        .dashboard-card.wide {
            grid-column: span 2;
        }
        
        @media (max-width: 1200px) {
            .dashboard-card.wide {
                grid-column: span 1;
            }
        }
        
        .dashboard-card h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .dashboard-chart {
            height: auto;
            min-height: 280px;
            position: relative;
            flex: 1;
            margin-bottom: 16px;
        }
        
        .dashboard-filters {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--light-gray);
            border-radius: 8px;
        }
        
        /* Novos estilos para os totais no dashboard */
        .dashboard-totals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .dashboard-total-card {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: var(--white);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .dashboard-total-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .dashboard-total-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* Estilos para a aba de Alertas */
        .alert-config {
            background-color: var(--white);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .alert-config h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .alert-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .alert-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .alert-item:last-child {
            border-bottom: none;
        }
        
        .alert-info {
            flex: 1;
        }
        
        .alert-actions {
            display: flex;
            gap: 10px;
        }
        
        .alert-status {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .alert-active {
            background-color: var(--success);
            color: white;
        }
        
        .alert-inactive {
            background-color: var(--medium-gray);
            color: white;
        }

        /* Novos estilos para o modal de senha */
        .password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .password-modal-content {
            background-color: var(--white);
            padding: 40px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .password-title {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 24px;
        }

        .password-input {
            width: 100%;
            padding: 15px;
            margin: 15px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
            letter-spacing: 2px;
        }

        .password-input:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .password-error {
            color: var(--danger);
            margin: 10px 0;
            font-size: 14px;
            display: none;
        }

        .password-hint {
            font-size: 12px;
            color: var(--medium-gray);
            margin-top: 10px;
        }

        .tab-disabled {
            opacity: 0.6;
            pointer-events: none;
            background-color: #f8f9fa;
        }

        /* Filtro de valor para o dashboard */
        .valor-filter {
            background-color: var(--primary-light);
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .valor-filter label {
            font-weight: 600;
            margin-right: 10px;
            color: var(--dark-gray);
        }

        .valor-filter select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
        }
        
        /* NOVO: Estilo para a data de atualiza√ß√£o */
        .update-indicator {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 6px;
            padding: 10px 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #0066cc;
        }
        
        .update-indicator::before {
            content: "üîÑ";
            font-size: 16px;
        }
  /* ===== Tela de Login integrada ===== */
  .auth-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: none; z-index: 10000; }
  .auth-card { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 10001; }
  .auth-card .card { width: 380px; background: rgba(255,255,255,0.95); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); padding: 24px; text-align: center; }
  .auth-card .logo { width: 160px; height: auto; margin: 8px auto 16px auto; display: block; }
  .auth-card h1 { font-size: 22px; margin: 8px 0 16px; color: var(--primary-color); }
  .auth-card label { display:block; text-align:left; font-weight:600; font-size: 13px; margin-top:12px; }
  .auth-card input { width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; font-size:14px; margin-top:6px; }
  .auth-card .btn { width:100%; padding:10px; border:none; border-radius:6px; cursor:pointer; font-weight:700; font-size:14px; margin-top:12px; }
  .auth-card .btn-primary { background: var(--primary-color); color: var(--white); }
  .auth-card .btn-primary:hover { background: var(--primary-dark); }
  .auth-card .feedback { font-size:13px; margin-top:10px; display:none; }
  .auth-card .feedback.error { color: var(--danger); }
  .auth-card .loading { display: none; text-align: center; margin: 10px 0; }
  .auth-card .spinner { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary-color); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; margin-right: 10px; }
  .require-login .auth-overlay, .require-login .auth-card { display: flex; }
  @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
  .logout-fab { position: fixed; right: 16px; bottom: 16px; background: var(--danger); color: #fff; border: none; padding: 10px 14px; border-radius: 20px; font-weight: 700; cursor: pointer; box-shadow: 0 6px 20px rgba(0,0,0,0.2); display: none; z-index: 9999; }
  :not(.require-login) .logout-fab { display: inline-block; }
</style>
</head>
<body>
    <!-- Tela de Login integrada -->
    <div id="auth-overlay" class="auth-overlay"></div>
    <div id="auth-card" class="auth-card">
      <div class="card">
        <img src="Nova pasta/Imagem5.png" alt="Logo" class="logo" />
        <h1>NORMAQ</h1>
        <p style="font-size:12px;color:#555;margin-bottom:8px;">Autentica√ß√£o Requerida</p>

        <label for="auth-user">Usu√°rio ou E-mail</label>
        <input id="auth-user" type="text" placeholder="Digite seu usu√°rio ou e-mail" />

        <label for="auth-pass">Senha</label>
        <input id="auth-pass" type="password" placeholder="Digite sua senha" />

        <div class="loading" id="auth-loading">
          <div class="spinner"></div>
          <span>Autenticando...</span>
        </div>

        <button class="btn btn-primary" id="auth-btn-login">Acessar Sistema</button>
        <div style="display:flex; gap:10px; margin-top:8px;">
          <button class="btn" id="auth-btn-info" style="background:#6c757d;color:#fff;">Informa√ß√µes</button>
          <button class="btn" id="auth-btn-reset" style="background:#6c757d;color:#fff;">Resetar Senha</button>
        </div>
        <div id="auth-feedback" class="feedback error"></div>

        <div id="auth-reset-card" style="display:none; margin-top:10px; padding:14px; border:1px solid #eee; border-radius:8px; background:#fafafa; text-align:left;">
          <h3 style="margin:0 0 8px; font-size:16px; color:#333;">Solicitar redefini√ß√£o de senha</h3>
          <label for="auth-reset-email">E-mail cadastrado</label>
          <input id="auth-reset-email" type="email" placeholder="Digite seu e-mail" />
          <button class="btn btn-primary" id="auth-reset-send">Enviar link de redefini√ß√£o</button>
          <div id="auth-reset-feedback" class="feedback"></div>
          <p style="font-size:12px; color:#777;">Voc√™ receber√° um e-mail com um link v√°lido por 30 minutos.</p>
        </div>
      </div>
    </div>
    <!-- Modal de Informa√ß√µes -->
    <div id="auth-info-modal" class="modal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:10002;">
      <div class="modal-content" style="background:#fff; padding:24px; border-radius:10px; width:520px; max-width:90vw; box-shadow:0 10px 30px rgba(0,0,0,0.25);">
        <div class="modal-header" style="display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:12px;">
          <div class="modal-title" style="font-size:18px; font-weight:700; color: var(--primary-color);">Informa√ß√µes de Acesso</div>
          <button class="close" id="auth-info-close" style="background:none; border:none; font-size:22px; cursor:pointer; color:#888;">√ó</button>
        </div>
        <div>
          <p>Para problemas de acesso:<br/>Entre em contato com o administrador do sistema:</p>
          <div style="background:#f7f7f7; padding:12px 14px; border-radius:8px; margin:10px 0;">
            <strong>Thiago Carmo ‚Äì Especialista em Dados e Desenvolvedor</strong><br/>
            <span>üìû (81) 99514-3900</span>
          </div>
          <a style="background:#25D366; color:#fff; border:none; padding:10px 16px; border-radius:8px; font-weight:700; cursor:pointer; display:inline-block; text-decoration:none;" target="_blank" href="https://wa.me/5581995143900">Abrir WhatsApp</a>
          <div style="margin-top:16px;">
            <strong>Hor√°rio de atendimento:</strong><br/>
            <span>Segunda a sexta: 8h √†s 18h</span><br/>
            <span>S√°bado: 8h √†s 12h</span>
          </div>
          <div style="text-align:right; margin-top:16px;">
            <button class="btn" id="auth-info-close-bottom" style="background:#6c757d;color:#fff;">Fechar</button>
          </div>
        </div>
      </div>
    </div>
    <style>
      html.require-login body { overflow: hidden; }
      .auth-overlay { background: none; }
      .auth-overlay::before {
        content: '';
        position: absolute;
        inset: 0;
        background-image: url('./Nova%20pasta/Trator_JCB.jpg');
        background-size: cover;
        background-position: center;
        filter: none;
        opacity: 1;
        pointer-events: none;
      }
    </style>

    <script>
      // L√≥gica de autentica√ß√£o integrada (RPC + fallback)
      (function(){
        const SUPABASE_URL = 'https://jnbirdxgllehrikluftu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpuYmlyZHhnbGxlaHJpa2x1ZnR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMDcxNTgsImV4cCI6MjA3NjU4MzE1OH0.OG4LjCJFAvOl0IOIrPlL3wZ4f7EeDcO-rUZ3dDIOqi4';
        const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const els = {
          user: document.getElementById('auth-user'),
          pass: document.getElementById('auth-pass'),
          btn: document.getElementById('auth-btn-login'),
          infoBtn: document.getElementById('auth-btn-info'),
          resetBtn: document.getElementById('auth-btn-reset'),
          infoModal: document.getElementById('auth-info-modal'),
          infoClose: document.getElementById('auth-info-close'),
          infoCloseBottom: document.getElementById('auth-info-close-bottom'),
          feedback: document.getElementById('auth-feedback'),
          loading: document.getElementById('auth-loading')
        };

        function setLoading(on){
          els.loading.style.display = on ? 'block' : 'none';
          els.btn.disabled = !!on;
        }

        function showFeedback(msg, isError=true){
          els.feedback.textContent = msg;
          els.feedback.className = 'feedback ' + (isError ? 'error' : 'success');
          els.feedback.style.display = 'block';
        }

        const DEFAULT_FIRST_PASSWORD = 'NMQ@123';

        async function doLogin(){
          els.feedback.style.display = 'none';
          const login = (els.user.value||'').trim();
          const senha = (els.pass.value||'').trim();
          if (!login || !senha) { showFeedback('Informe usu√°rio/e-mail e senha.', true); return; }
          setLoading(true);
          try {
            // Busca por usu√°rio/email; se n√£o achar, tenta aproxima√ß√£o por ilike
            let userRow = null;
            const sel = 'id, nome_completo, email, usuario, is_admin, senha, tipo_usuario';
            // 1) usuario == login
            const { data: byUser, error: errUser } = await client
              .from('usuarios_auth')
              .select(sel)
              .eq('usuario', login)
              .limit(1);
            if (!errUser && byUser && byUser.length > 0) {
              userRow = byUser[0];
            }
            // 2) email == login
            if (!userRow) {
              const { data: byEmail, error: errEmail } = await client
                .from('usuarios_auth')
                .select(sel)
                .eq('email', login)
                .limit(1);
              if (!errEmail && byEmail && byEmail.length > 0) {
                userRow = byEmail[0];
              }
            }
            // 3) usuario ilike %login% (aceita prefixos como "adm thiago.carmo")
            if (!userRow) {
              const { data: byUserLike, error: errLike } = await client
                .from('usuarios_auth')
                .select(sel)
                .ilike('usuario', `%${login}%`)
                .limit(1);
              if (!errLike && byUserLike && byUserLike.length > 0) {
                userRow = byUserLike[0];
              }
            }

            if (!userRow) {
              const loginLower = login.toLowerCase();
              const isThiagoLogin = (
                loginLower === 'thiago.carmo' ||
                loginLower === 'thiago.carmo@normaq.com.br' ||
                loginLower.includes('thiago.carmo')
              );
              if (isThiagoLogin && senha === 'NMQ@2025') {
                const authUser = {
                  id: 0,
                  nome_completo: 'Thiago Carmo',
                  email: 'thiago.carmo@normaq.com.br',
                  usuario: 'thiago.carmo',
                  is_admin: true,
                  tipo_usuario: 'Administrador',
                  primeiro_login: false
                };
                localStorage.setItem('authUser', JSON.stringify(authUser));
                window.NormaQCurrentUser = authUser;
                document.documentElement.classList.remove('require-login');
                setLoading(false);
                showFeedback('Login efetuado com sucesso!', false);
                // Registra o login na fonte de logs (fallback localStorage para garantir)
                try {
                  const payload = {
                    usuario: authUser.usuario,
                    nome_completo: authUser.nome_completo,
                    tipo_usuario: authUser.tipo_usuario,
                    pagina: 'login',
                    created_at: new Date().toISOString()
                  };
                  const local = JSON.parse(localStorage.getItem('pageVisits') || '[]');
                  local.push(payload);
                  localStorage.setItem('pageVisits', JSON.stringify(local));
                } catch(_) {}
                if (window.applyUserAccessControl) window.applyUserAccessControl();
                if (window.checkPrimeiroLoginThenShowModal) window.checkPrimeiroLoginThenShowModal();
                return;
              }
              showFeedback('Usu√°rio/E-mail n√£o encontrado.', true); setLoading(false); return;
            }

            const senhaBanco = (userRow.senha || '').trim();
            let senhaOk = false;
            // Compatibilidade especial solicitada
            if ((userRow.usuario && userRow.usuario.includes('thiago.carmo')) && senha === 'NMQ@2025') {
              senhaOk = true;
            } else {
              try {
                const bcryptLib = (window.bcrypt || (window.dcodeIO && window.dcodeIO.bcrypt));
                if (senhaBanco.startsWith('$2a$') || senhaBanco.startsWith('$2b$') || senhaBanco.startsWith('$2y$')) {
                  senhaOk = bcryptLib ? bcryptLib.compareSync(senha, senhaBanco) : false;
                } else {
                  senhaOk = (senhaBanco === senha);
                }
              } catch (cmpErr) {
                console.warn('Falha ao comparar senha:', cmpErr);
                senhaOk = false;
              }
            }

            if (!senhaOk) { showFeedback('Senha incorreta.', true); setLoading(false); return; }

            // Determina se √© primeiro login pela senha padr√£o
            let isFirst = false;
            try {
              const bcryptLib = (window.bcrypt || (window.dcodeIO && window.dcodeIO.bcrypt));
              if (senhaBanco.startsWith('$2a$') || senhaBanco.startsWith('$2b$') || senhaBanco.startsWith('$2y$')) {
                isFirst = bcryptLib ? bcryptLib.compareSync(DEFAULT_FIRST_PASSWORD, senhaBanco) : false;
              } else {
                isFirst = (senhaBanco === DEFAULT_FIRST_PASSWORD);
              }
            } catch (_) { isFirst = false; }

            const authUser = {
              id: userRow.id,
              nome_completo: userRow.nome_completo,
              email: userRow.email,
              usuario: userRow.usuario,
              is_admin: !!userRow.is_admin,
              tipo_usuario: userRow.tipo_usuario || (userRow.is_admin ? 'Administrador' : 'Usu√°rio'),
              primeiro_login: isFirst
            };
            localStorage.setItem('authUser', JSON.stringify(authUser));
            window.NormaQCurrentUser = authUser;
            document.documentElement.classList.remove('require-login');
            setLoading(false);
            showFeedback('Login efetuado com sucesso!', false);
            // Registra o login na fonte de logs (fallback localStorage para garantir)
            try {
              const payload = {
                usuario: authUser.usuario,
                nome_completo: authUser.nome_completo,
                tipo_usuario: authUser.tipo_usuario,
                pagina: 'login',
                created_at: new Date().toISOString()
              };
              const local = JSON.parse(localStorage.getItem('pageVisits') || '[]');
              local.push(payload);
              localStorage.setItem('pageVisits', JSON.stringify(local));
            } catch(_) {}
            // Ajusta acesso √†s tabs conforme perfil e for√ßa troca de senha, se necess√°rio
            if (window.applyUserAccessControl) window.applyUserAccessControl();
            if (window.checkPrimeiroLoginThenShowModal) window.checkPrimeiroLoginThenShowModal();
          } catch (err) {
            console.error('Erro login:', err);
            showFeedback('Erro inesperado ao autenticar.', true);
            setLoading(false);
          }
        }

        async function requestPasswordReset(){
          const emailEl = document.getElementById('auth-reset-email');
          const email = ((emailEl && emailEl.value) || '').trim();
          const resetFeedback = document.getElementById('auth-reset-feedback');
          resetFeedback.style.display = 'none';
          if (!email) { showFeedback('Informe seu e-mail para reset.', true); return; }
          try {
            const { data: users, error } = await client.from('usuarios_auth').select('id, email, nome_completo').eq('email', email).limit(1);
            if (error) { showFeedback('Erro ao buscar usu√°rio.', true); return; }
            if (!users || users.length === 0) { resetFeedback.textContent = 'E-mail n√£o encontrado.'; resetFeedback.className = 'feedback error'; resetFeedback.style.display = 'block'; return; }
            const u = users[0];
            const token = Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2);
            const expiracao = new Date(Date.now() + 30*60*1000).toISOString();
            const { error: insErr } = await client.from('reset_senha_tokens').insert({ usuario_id: u.id, token, expiracao, usado: false });
            if (insErr) { resetFeedback.textContent = 'Erro ao gerar token. Verifique pol√≠ticas RLS.'; resetFeedback.className = 'feedback error'; resetFeedback.style.display = 'block'; return; }
            const link = window.location.origin + '/resetar-senha.html?token=' + encodeURIComponent(token) + '&uid=' + encodeURIComponent(u.id);
            try {
              await emailjs.send('service_erkwc1t','template_d1ec1cc', { to_email: u.email, to_name: u.nome_completo || u.email, reset_link: link });
              resetFeedback.textContent = 'Link de redefini√ß√£o enviado para seu e-mail.';
              resetFeedback.className = 'feedback success';
              resetFeedback.style.display = 'block';
            } catch (mailErr) {
              resetFeedback.textContent = 'Falha ao enviar e-mail. Copie este link: ' + link;
              resetFeedback.className = 'feedback error';
              resetFeedback.style.display = 'block';
            }
          } catch (err) {
            resetFeedback.textContent = 'Erro inesperado no reset.';
            resetFeedback.className = 'feedback error';
            resetFeedback.style.display = 'block';
          }
        }

        if (window.NormaQRequireLogin) {
          const enter = (ev)=>{ if (ev.key==='Enter') doLogin(); };
          els.user.addEventListener('keydown', enter);
          els.pass.addEventListener('keydown', enter);
          els.btn.addEventListener('click', doLogin);
          // Info modal
          els.infoBtn.addEventListener('click', ()=>{ els.infoModal.style.display = 'flex'; });
          els.infoClose.addEventListener('click', ()=>{ els.infoModal.style.display = 'none'; });
          els.infoCloseBottom.addEventListener('click', ()=>{ els.infoModal.style.display = 'none'; });
          // Reset card
          els.resetBtn.addEventListener('click', ()=>{
            const card = document.getElementById('auth-reset-card');
            card.style.display = card.style.display === 'none' ? 'block' : 'none';
          });
          document.getElementById('auth-reset-send').addEventListener('click', requestPasswordReset);
        }
      })();
    </script>
    <button id="btn-logout" class="logout-fab" title="Sair">Sair</button>
    <script>
      (function(){
        const btnLogout = document.getElementById('btn-logout');
        if (btnLogout) {
          btnLogout.addEventListener('click', function(){
            try { localStorage.removeItem('authUser'); } catch(e){}
            window.NormaQCurrentUser = null;
            document.documentElement.classList.add('require-login');
          });
        }
      })();
    </script>
    <header>
        <div class="header-content">
            <div class="logo-container">
                <img src="./Nova pasta/Imagem5.png" alt="Logo" class="logo">
                <div>
                    <h1 class="header-title">Controle de OS Abertas</h1>
                    <p class="header-subtitle">Sistema de gerenciamento de Ordens de Servi√ßo</p>
                </div>
            </div>
            <div class="user-info-container" id="user-info-container" style="margin-left: 20px; padding: 8px 16px; background: rgba(255,255,255,0.1); border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; gap: 12px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span class="user-welcome" style="color: white; font-size: 14px;">Ol√°,</span>
                    <span class="user-name" id="user-name" style="color: white; font-weight: 600; font-size: 14px;">Usu√°rio</span>
                </div>
                <span style="color: rgba(255,255,255,0.5); font-size: 14px;">|</span>
                <div class="datetime-container" style="display: flex; flex-direction: column; align-items: flex-start; line-height: 1;">
                    <div class="current-time" id="current-time" style="font-size: 12px; color: rgba(255,255,255,0.9); margin: 0;">14:13</div>
                    <div class="current-date" id="current-date" style="font-size: 11px; color: rgba(255,255,255,0.8); margin: 0;">24/10/2025</div>
                    <div class="current-day" id="current-day" style="font-size: 11px; color: rgba(255,255,255,0.8); margin: 0;">Sexta-feira</div>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container">
        <div id="error-message" class="error-message" style="display: none;"></div>
        <div id="success-message" class="success-message" style="display: none;">
            <span id="success-message-text" class="message-text"></span>
            <div class="update-indicator-inline">Dados atualizados em: <span id="success-last-update-time">‚Äî</span></div>
        </div>
        <div id="debug-info" class="debug-info" style="display: none;"></div>
        
        <div class="tabs-container">
            <div class="tabs">
                <div class="tab active" data-tab="externa">OS Externa</div>
                <div class="tab" data-tab="interna">OS Interna</div>
                <div class="tab" data-tab="garantia">OS Garantia</div>
                <div class="tab" data-tab="atualizacao">Atualiza√ß√£o</div>
                <div class="tab" data-tab="atualizar-valores">Atualizar Valores (CSV)</div>
                <div class="tab" data-tab="importacao">Importa√ß√£o de Dados</div>
                <div class="tab" data-tab="dashboard">Dashboard</div>
                <div class="tab" data-tab="alerta" id="alerta-tab">Alerta</div>
                <div class="tab" data-tab="gerenciar-status">Gerenciar Status</div>
                <div class="tab" data-tab="transferencia-escalonamento">Transferencia de Escalonamento</div>
                <div class="tab" data-tab="logs-status" id="tab-logs-status">Log de Altera√ß√£o de Status</div>
                <div class="tab" data-tab="cadastro-usuarios" id="tab-cadastro-usuarios">Cadastrar Usu√°rios</div>
            </div>
            
            <!-- Aba OS Externa -->
            <div class="tab-content active" id="externa">
                <div class="filters">
                    <div class="filter-group">
                        <label class="filter-label">Revenda</label>
                        <div class="filter-multiselect">
                            <select class="filter-select" id="filter-revenda-externa" multiple>
                                <option value="1">Recife</option>
                                <option value="2">Natal</option>
                                <option value="3">Fortaleza</option>
                                <option value="4">Petrolina</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-group"><label class="filter-label">Nro. OS</label><input type="text" class="filter-input" id="filter-nro-os-externa" placeholder="N√∫mero da OS"></div>
                    <div class="filter-group"><label class="filter-label">Situa√ß√£o OS</label><select class="filter-select" id="filter-situacao-externa"><option value="">Todos</option><option value="Aberta" selected>Aberta</option><option value="Fechada">Fechada</option></select></div>
                    <div class="filter-group"><label class="filter-label">Dias</label><select class="filter-select" id="filter-dias-externa"><option value="">Todos</option><option value="0-10">0-10 dias</option><option value="11-15">11-15 dias</option><option value="16-20">16-20 dias</option><option value="21-30">21-30 dias</option><option value="30+">30+ dias</option></select></div>
                    <div class="filter-group"><label class="filter-label">Status</label><select class="filter-select" id="filter-status-externa"><option value="">Todos</option><option value="Sem Status">Sem Status</option><option value="Pendente de Pe√ßa">Pendente de Pe√ßa</option><option value="Pendente de Programa√ß√£o">Pendente de Programa√ß√£o</option><option value="Pendente Submiss√£o">Pendente Submiss√£o</option><option value="Programado">Programado</option><option value="Submiss√£o Aprovada">Submiss√£o Aprovada</option><option value="Submiss√£o em Processamento">Submiss√£o em Processamento</option><option value="Em Negocia√ß√£o">Em Negocia√ß√£o</option><option value="Servi√ßo Conclu√≠do">Servi√ßo Conclu√≠do</option><option value="Concluindo">Concluindo</option><option value="Em Atendimento">Em Atendimento</option><option value="Cancelado">Cancelado</option></select></div>
                    <div class="filter-group"><label class="filter-label">Escalonamento</label><select class="filter-select" id="filter-escalonamento-externa"><option value="">Todos</option><option value="Isabelle">Isabelle</option><option value="Ana Leya">Ana Leya</option><option value="Bruna">Bruna</option><option value="Wanderley">Wanderley</option><option value="Graziela">Graziela</option><option value="Johnny">Johnny</option><option value="Ant√¥nio Gustavo">Ant√¥nio Gustavo</option></select></div>
                </div>
                
                <!-- Totais para OS Externa - CORRIGIDO -->
                <div class="totals-container" id="totals-externa">
                    <div class="total-item">
                        <div class="total-value" id="total-pecas-externa">R$ 0,00</div>
                        <div class="total-label">Total Pe√ßas</div>
                    </div>
                    <div class="total-item">
                        <div class="total-value" id="total-servico-externa">R$ 0,00</div>
                        <div class="total-label">Total Servi√ßo</div>
                    </div>
                    <div class="total-item">
                        <div class="total-value" id="total-os-externa">R$ 0,00</div>
                        <div class="total-label">Total OS</div>
                    </div>
                    <div class="total-geral-os" id="total-geral-externa">Total Geral de OS: 0</div>
                </div>
                
                <div class="table-controls">
                    <button class="columns-control-btn" id="columns-control-btn-externa">üìã Controle de Colunas</button>
                </div>
                <!-- Cards de alerta por usu√°rio (Externa) -->
                <div id="externa-alert-cards" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:12px; margin:12px 0;"></div>
                <div class="table-container">
                    <table id="table-externa">
                        <thead>
                            <tr>
                                <th class="col-revenda sortable" data-column="revenda">Revenda</th>
                                <th class="col-nro-os sortable" data-column="nro-os">Nro. OS</th>
                                <th class="col-situacao sortable" data-column="situacao">Situa√ß√£o OS</th>
                                <th class="col-tipo sortable" data-column="tipo">Tipo OS</th>
                                <th class="col-emissao sortable" data-column="emissao">Emiss√£o</th>
                                <th class="col-dias sortable" data-column="dias">Dias</th>
                                <th class="col-dias-aberto sortable" data-column="dias-aberto">Dias em Aberto</th>
                                <th class="col-status sortable" data-column="status">Status</th>
                                <th class="col-cliente sortable" data-column="cliente">Cliente</th>
                                <th class="col-chassi sortable" data-column="chassi">Chassi</th>
                                <th class="col-consultor sortable" data-column="consultor">Consultor</th>
                                <th class="col-total-pecas sortable" data-column="total-pecas">Total Pe√ßas</th>
                                <th class="col-total-servico sortable" data-column="total-servico">Total Servi√ßo</th>
                                <th class="col-total-os sortable" data-column="total-os">Total OS</th>
                                <th class="col-observacao sortable" data-column="observacao">Observa√ß√£o</th>
                                <th class="col-acao-atualizacao sortable" data-column="acao-atualizacao">A√ß√£o/Atualiza√ß√£o</th>
                                <th class="col-escalonamento sortable" data-column="escalonamento">Escalonamento</th>
                                <th class="col-acao">A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-externa"></tbody>
                    </table>
                    <div id="count-externa" class="table-row-count"></div>
                </div>
            </div>
            
            <!-- Aba OS Interna -->
            <div class="tab-content" id="interna">
                <div class="filters">
                    <div class="filter-group">
                        <label class="filter-label">Revenda</label>
                        <div class="filter-multiselect">
                            <select class="filter-select" id="filter-revenda-interna" multiple>
                                <option value="1">Recife</option>
                                <option value="2">Natal</option>
                                <option value="3">Fortaleza</option>
                                <option value="4">Petrolina</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-group"><label class="filter-label">Nro. OS</label><input type="text" class="filter-input" id="filter-nro-os-interna" placeholder="N√∫mero da OS"></div>
                    <div class="filter-group"><label class="filter-label">Situa√ß√£o OS</label><select class="filter-select" id="filter-situacao-interna"><option value="">Todos</option><option value="Aberta" selected>Aberta</option><option value="Fechada">Fechada</option></select></div>
                    <div class="filter-group"><label class="filter-label">Dias</label><select class="filter-select" id="filter-dias-interna"><option value="">Todos</option><option value="0-10">0-10 dias</option><option value="11-15">11-15 dias</option><option value="16-20">16-20 dias</option><option value="21-30">21-30 dias</option><option value="30+">30+ dias</option></select></div>
                    <div class="filter-group"><label class="filter-label">Status</label><select class="filter-select" id="filter-status-interna"><option value="">Todos</option><option value="Sem Status">Sem Status</option><option value="Pendente de Pe√ßa">Pendente de Pe√ßa</option><option value="Pendente de Programa√ß√£o">Pendente de Programa√ß√£o</option><option value="Pendente Submiss√£o">Pendente Submiss√£o</option><option value="Programado">Programado</option><option value="Submiss√£o Aprovada">Submiss√£o Aprovada</option><option value="Submiss√£o em Processamento">Submiss√£o em Processamento</option><option value="Em Negocia√ß√£o">Em Negocia√ß√£o</option><option value="Servi√ßo Conclu√≠do">Servi√ßo Conclu√≠do</option><option value="Concluindo">Concluindo</option><option value="Em Atendimento">Em Atendimento</option><option value="Cancelado">Cancelado</option></select></div>
                    <div class="filter-group"><label class="filter-label">Escalonamento</label><select class="filter-select" id="filter-escalonamento-interna"><option value="">Todos</option><option value="Isabelle">Isabelle</option><option value="Ana Leya">Ana Leya</option><option value="Bruna">Bruna</option><option value="Wanderley">Wanderley</option><option value="Graziela">Graziela</option><option value="Johnny">Johnny</option><option value="Ant√¥nio Gustavo">Ant√¥nio Gustavo</option></select></div>
                </div>
                
                <!-- Totais para OS Interna - CORRIGIDO -->
                <div class="totals-container" id="totals-interna">
                    <div class="total-item">
                        <div class="total-value" id="total-pecas-interna">R$ 0,00</div>
                        <div class="total-label">Total Pe√ßas</div>
                    </div>
                    <div class="total-item">
                        <div class="total-value" id="total-servico-interna">R$ 0,00</div>
                        <div class="total-label">Total Servi√ßo</div>
                    </div>
                    <div class="total-item">
                        <div class="total-value" id="total-os-interna">R$ 0,00</div>
                        <div class="total-label">Total OS</div>
                    </div>
                    <div class="total-geral-os" id="total-geral-interna">Total Geral de OS: 0</div>
                </div>
                
                <div class="table-controls">
                    <button class="columns-control-btn" id="columns-control-btn-interna">üìã Controle de Colunas</button>
                </div>
                <!-- Cards de alerta por usu√°rio (Interna) -->
                <div id="interna-alert-cards" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:12px; margin:12px 0;"></div>
                <div class="table-container">
                    <table id="table-interna">
                        <thead>
                            <tr>
                                <th class="col-revenda sortable" data-column="revenda">Revenda</th>
                                <th class="col-nro-os sortable" data-column="nro-os">Nro. OS</th>
                                <th class="col-situacao sortable" data-column="situacao">Situa√ß√£o OS</th>
                                <th class="col-tipo sortable" data-column="tipo">Tipo OS</th>
                                <th class="col-emissao sortable" data-column="emissao">Emiss√£o</th>
                                <th class="col-dias sortable" data-column="dias">Dias</th>
                                <th class="col-dias-aberto sortable" data-column="dias-aberto">Dias em Aberto</th>
                                <th class="col-status sortable" data-column="status">Status</th>
                                <th class="col-cliente sortable" data-column="cliente">Cliente</th>
                                <th class="col-chassi sortable" data-column="chassi">Chassi</th>
                                <th class="col-consultor sortable" data-column="consultor">Consultor</th>
                                <th class="col-total-pecas sortable" data-column="total-pecas">Total Pe√ßas</th>
                                <th class="col-total-servico sortable" data-column="total-servico">Total Servi√ßo</th>
                                <th class="col-total-os sortable" data-column="total-os">Total OS</th>
                                <th class="col-observacao sortable" data-column="observacao">Observa√ß√£o</th>
                                <th class="col-acao-atualizacao sortable" data-column="acao-atualizacao">A√ß√£o/Atualiza√ß√£o</th>
                                <th class="col-escalonamento sortable" data-column="escalonamento">Escalonamento</th>
                                <th class="col-acao">A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-interna"></tbody>
                    </table>
                    <div id="count-interna" class="table-row-count"></div>
                </div>
            </div>
            
            <!-- Aba OS Garantia -->
            <div class="tab-content" id="garantia">
                <div class="filters">
                    <div class="filter-group">
                        <label class="filter-label">Revenda</label>
                        <div class="filter-multiselect">
                            <select class="filter-select" id="filter-revenda-garantia" multiple>
                                <option value="1">Recife</option>
                                <option value="2">Natal</option>
                                <option value="3">Fortaleza</option>
                                <option value="4">Petrolina</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-group"><label class="filter-label">Nro. OS</label><input type="text" class="filter-input" id="filter-nro-os-garantia" placeholder="N√∫mero da OS"></div>
                    <div class="filter-group"><label class="filter-label">Situa√ß√£o OS</label><select class="filter-select" id="filter-situacao-garantia"><option value="">Todos</option><option value="Aberta" selected>Aberta</option><option value="Fechada">Fechada</option></select></div>
                    <div class="filter-group"><label class="filter-label">Dias</label><select class="filter-select" id="filter-dias-garantia"><option value="">Todos</option><option value="0-25">0-25 dias</option><option value="26-35">26-35 dias</option><option value="36-50">36-50 dias</option><option value="51-90">51-90 dias</option><option value="90+">90+ dias</option></select></div>
                        <div class="filter-group"><label class="filter-label">Status</label><select class="filter-select" id="filter-status-garantia"><option value="">Todos</option><option value="Sem Status">Sem Status</option><option value="Pendente de Pe√ßa">Pendente de Pe√ßa</option><option value="Pendente de Programa√ß√£o">Pendente de Programa√ß√£o</option><option value="Pendente Submiss√£o">Pendente Submiss√£o</option><option value="Programado">Programado</option><option value="Submiss√£o Aprovada">Submiss√£o Aprovada</option><option value="Submiss√£o em Processamento">Submiss√£o em Processamento</option><option value="Em Negocia√ß√£o">Em Negocia√ß√£o</option><option value="Servi√ßo Conclu√≠do">Servi√ßo Conclu√≠do</option><option value="Concluindo">Concluindo</option><option value="Em Atendimento">Em Atendimento</option><option value="Cancelado">Cancelado</option></select></div>
                    <div class="filter-group"><label class="filter-label">Escalonamento</label><select class="filter-select" id="filter-escalonamento-garantia"><option value="">Todos</option><option value="Fl√°via">Fl√°via</option><option value="Giovana">Giovana</option><option value="Wanderley">Wanderley</option><option value="Graziela">Graziela</option><option value="Johnny">Johnny</option><option value="Ant√¥nio Gustavo">Ant√¥nio Gustavo</option></select></div>
                </div>
                
                <!-- Totais para OS Garantia - CORRIGIDO -->
                <div class="totals-container" id="totals-garantia">
                    <div class="total-item">
                        <div class="total-value" id="total-pecas-garantia">R$ 0,00</div>
                        <div class="total-label">Total Pe√ßas</div>
                    </div>
                    <div class="total-item">
                        <div class="total-value" id="total-servico-garantia">R$ 0,00</div>
                        <div class="total-label">Total Servi√ßo</div>
                    </div>
                    <div class="total-item">
                        <div class="total-value" id="total-os-garantia">R$ 0,00</div>
                        <div class="total-label">Total OS</div>
                    </div>
                    <div class="total-geral-os" id="total-geral-garantia">Total Geral de OS: 0</div>
                </div>
                
                <div class="table-controls">
                    <button class="columns-control-btn" id="columns-control-btn-garantia">üìã Controle de Colunas</button>
                </div>
                <!-- Cards de alerta por usu√°rio (Garantia) -->
                <div id="garantia-alert-cards" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:12px; margin:12px 0;"></div>
                <div class="table-container">
                    <table id="table-garantia">
                        <thead>
                            <tr>
                                <th class="col-revenda sortable" data-column="revenda">Revenda</th>
                                <th class="col-nro-os sortable" data-column="nro-os">Nro. OS</th>
                                <th class="col-situacao sortable" data-column="situacao">Situa√ß√£o OS</th>
                                <th class="col-tipo sortable" data-column="tipo">Tipo OS</th>
                                <th class="col-emissao sortable" data-column="emissao">Emiss√£o</th>
                                <th class="col-dias sortable" data-column="dias">Dias</th>
                                <th class="col-dias-aberto sortable" data-column="dias-aberto">Dias em Aberto</th>
                                <th class="col-status sortable" data-column="status">Status</th>
                                <th class="col-cliente sortable" data-column="cliente">Cliente</th>
                                <th class="col-chassi sortable" data-column="chassi">Chassi</th>
                                <th class="col-consultor sortable" data-column="consultor">Consultor</th>
                                <th class="col-total-pecas sortable" data-column="total-pecas">Total Pe√ßas</th>
                                <th class="col-total-servico sortable" data-column="total-servico">Total Servi√ßo</th>
                                <th class="col-total-os sortable" data-column="total-os">Total OS</th>
                                <th class="col-observacao sortable" data-column="observacao">Observa√ß√£o</th>
                                <th class="col-acao-atualizacao sortable" data-column="acao-atualizacao">A√ß√£o/Atualiza√ß√£o</th>
                                <th class="col-escalonamento sortable" data-column="escalonamento">Escalonamento</th>
                                <th class="col-acao">A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-garantia"></tbody>
                    </table>
                    <div id="count-garantia" class="table-row-count"></div>
                </div>
            </div>
            
            <!-- ABA Atualiza√ß√£o -->
            <div class="tab-content" id="atualizacao">
            <div class="update-tab-section">
                <h2>Atualiza√ß√£o em Lote</h2>
                <p>Selecione o tipo de OS para atualizar:</p>
                <div class="base-selection">
                    <div class="form-group">
                        <label class="form-label">Tipo OS</label>
                        <select class="form-select" id="batch-tipo">
                            <option value="Externa">OS Externa</option>
                            <option value="Interna">OS Interna</option>
                            <option value="Garantia">OS Garantia</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Situa√ß√£o OS</label>
                        <select class="form-select" id="batch-situacao">
                            <option value="Aberta" selected>Aberta</option>
                            <option value="Fechada">Fechada</option>
                        </select>
                    </div>
                </div>
                <div class="batch-actions">
                    <button class="btn btn-primary" id="btn-carregar-os">Carregar OS Abertas</button>
                    <span class="selected-count" id="selected-count">0 OS selecionadas</span>
                    <button class="btn btn-success" id="btn-fechar-os" disabled>Fechar Selecionadas</button>
                    <div class="batch-status-section">
                        <div class="form-group" style="margin-bottom: 0;">
                            <select class="form-select batch-status-select" id="batch-status">
                                <option value="">Atualizar Status para...</option>
                                <option value="Sem Status">Sem Status</option>
                                <option value="Pendente de Pe√ßa">Pendente de Pe√ßa</option>
                                <option value="Pendente de Programa√ß√£o">Pendente de Programa√ß√£o</option>
                                <option value="Pendente Submiss√£o">Pendente Submiss√£o</option>
                                <option value="Programado">Programado</option>
                                <option value="Submiss√£o Aprovada">Submiss√£o Aprovada</option>
                                <option value="Submiss√£o em Processamento">Submiss√£o em Processamento</option>
                                <option value="Em Negocia√ß√£o">Em Negocia√ß√£o</option>
                                <option value="Servi√ßo Conclu√≠do">Servi√ßo Conclu√≠do</option>
                                <option value="Concluindo">Concluindo</option>
                                <option value="Em Atendimento">Em Atendimento</option>
                                <option value="Cancelado">Cancelado</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <select class="form-select batch-status-select" id="batch-filter-status">
                                <option value="">Filtrar por Status...</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <select class="form-select batch-status-select" id="batch-filter-escalonamento">
                                <option value="">Filtrar por Escalonamento...</option>
                            </select>
                        </div>
                        <button class="btn btn-warning" id="btn-atualizar-status" disabled>Atualizar Status</button>
                    </div>
                    <button class="btn btn-warning" id="btn-limpar-selecao">Limpar</button>
                    <div class="form-group" style="margin-left: 12px; display: flex; gap: 8px; align-items: center;">
                        <input type="text" class="filter-input" id="batch-multi-os" placeholder="Digite v√°rios n√∫meros de OS separados por ;">
                        <button class="btn btn-warning" id="btn-carregar-os-lista">Carregar OS</button>
                    </div>
                </div>
                    <div class="select-all-container">
                        <input type="checkbox" id="select-all-os">
                        <label for="select-all-os">Selecionar Todas</label>
                    </div>
                    <div id="batch-os-list" class="os-list-container">
                        <div class="empty-state">Clique em "Carregar OS Abertas"</div>
                    </div>
                </div>
                <div class="update-tab-section">
                    <h2>Atualiza√ß√£o Individual</h2>
                    <p>Atualize uma OS espec√≠fica:</p>
                    <div class="individual-search">
                        <div class="form-group"><label class="form-label">N√∫mero da OS</label><input type="text" class="filter-input" id="individual-nro-os" placeholder="Digite o n√∫mero"></div>
                        <button class="btn btn-primary" id="btn-buscar-os">Buscar OS</button>
                    </div>
                    <div id="individual-os-form" class="individual-form">
                        <div class="info-message">OS encontrada! Preencha para atualizar.</div>
                        <div class="form-group">
                            <label class="form-label">Situa√ß√£o OS</label>
                            <select class="form-select" id="individual-situacao">
                                <option value="Aberta">Aberta</option>
                                <option value="Fechada">Fechada</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="individual-status">
                                <option value="Sem Status">Sem Status</option>
                                <option value="Pendente de Pe√ßa">Pendente de Pe√ßa</option>
                                <option value="Pendente de Programa√ß√£o">Pendente de Programa√ß√£o</option>
                                <option value="Pendente Submiss√£o">Pendente Submiss√£o</option>
                                <option value="Programado">Programado</option>
                                <option value="Submiss√£o Aprovada">Submiss√£o Aprovada</option>
                                <option value="Submiss√£o em Processamento">Submiss√£o em Processamento</option>
                                <option value="Em Negocia√ß√£o">Em Negocia√ß√£o</option>
                                <option value="Servi√ßo Conclu√≠do">Servi√ßo Conclu√≠do</option>
                                <option value="Concluindo">Concluindo</option>
                                <option value="Em Atendimento">Em Atendimento</option>
                                <option value="Cancelado">Cancelado</option>
                            </select>
                        </div>
                        <div class="form-group"><label class="form-label">Observa√ß√£o</label><textarea class="form-textarea" id="individual-observacao" placeholder="..."></textarea></div>
                        <div class="form-group"><label class="form-label">A√ß√£o / Atualiza√ß√£o</label><textarea class="form-textarea" id="individual-acao-atualizacao" placeholder="..."></textarea></div>
                        <button class="btn btn-success" id="btn-atualizar-individual">Atualizar OS</button>
                    </div>
                </div>
            </div>

            <!-- Aba: Atualizar Valores (CSV) -->
            <div class="tab-content" id="atualizar-valores">
                <div class="filters" style="gap: 16px; align-items: flex-end;">
                    <div style="flex: 1;">
                        <label for="csv-valores-file">Arquivo CSV com colunas-chave e valores</label>
                        <input type="file" id="csv-valores-file" accept=".csv" />
                        <small>Colunas esperadas: Chave ou Numero OS; Tipo; Revenda; Total Pecas; Total Servico; Total OS</small>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button id="btn-validar-csv-valores" class="btn-primary">Validar CSV</button>
                        <button id="btn-aplicar-csv-valores" class="btn-warning" disabled>Aplicar Atualiza√ß√£o</button>
                    </div>
                </div>
                <div id="csv-valores-status" class="status-box" style="margin-top: 12px;">
                    <div id="csv-valores-resumo">Nenhum arquivo carregado.</div>
                    <div id="csv-valores-detalhes" style="margin-top: 8px;"></div>
                </div>
                <div style="margin-top: 16px;">
                    <details>
                        <summary>Instru√ß√µes</summary>
                        <ul>
                            <li>Somente atualiza: Total Pecas, Total Servico e Total OS.</li>
                            <li>Correspond√™ncia prioriza "Chave"; caso ausente, usa "Numero OS" + "Tipo" (e Revenda, se fornecida).</li>
                            <li>Ap√≥s aplicar, as listas e totais s√£o atualizados nas abas Externa, Interna e Garantia, e o Dashboard √© recarregado.</li>
                        </ul>
                    </details>
                </div>
            </div>
            
            <!-- Aba: Importa√ß√£o de Dados -->
            <div class="tab-content" id="importacao">
                <h2>Importa√ß√£o de Dados para Base_OS</h2>
                <div class="filters" style="gap: 16px; align-items: flex-end;">
                    <div style="flex: 1;">
                        <label for="import-csv-file">Arquivo CSV</label>
                        <input type="file" id="import-csv-file" accept=".csv" />
                        <small>Voc√™ pode tamb√©m colar os dados abaixo. Delimitador aceito: ; ou ,</small>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button id="btn-parse-import" class="btn-primary">Validar Importa√ß√£o</button>
                        <button id="btn-save-import" class="btn-success" disabled>Salvar na Base</button>
                        <button id="btn-clear-import" class="btn-warning" disabled>Limpar</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Colar CSV ou tabela</label>
                    <textarea id="import-paste" class="form-textarea" rows="8" placeholder="Cole aqui com cabe√ßalhos nas colunas:\nChave; Tipo; Revenda; Numero OS; Situacao OS; Emissao; Dias; Cliente; Chassi; Modelo; Descricao Modelo; Consultor; Observacao; Total Pecas; Total Servico; Total OS; Acao / Atualizacao; status"></textarea>
                </div>
                <div id="import-status" class="status-box" style="margin-top: 12px;">
                    <div id="import-resumo">Aguardando arquivo ou colagem.</div>
                    <div id="import-detalhes" style="margin-top: 8px;"></div>
                </div>
                <div style="margin-top:16px; display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <div>
                        <h3>Registros v√°lidos (novo)</h3>
                        <div id="import-list-valid" class="table-container" style="max-height:280px; overflow:auto; border:1px solid #eee;"></div>
                    </div>
                    <div>
                        <h3>Duplicatas (n√£o ser√£o importadas)</h3>
                        <div id="import-list-duplicadas" class="table-container" style="max-height:280px; overflow:auto; border:1px solid #eee;"></div>
                    </div>
                </div>
                <details style="margin-top:16px;">
                    <summary>Instru√ß√µes</summary>
                    <ul>
                        <li>Somente o administrador (usu√°rio: thiago.carmo) visualiza esta aba.</li>
                        <li>Chaves esperadas conforme a Base_OS. Mapeamentos aceitos: "Chave"‚Üí"Cahve" e "status"‚Üí"Status".</li>
                        <li>Duplicidade √© verificada por par "Cahve"+"Tipo" tanto contra o arquivo quanto contra a Base.</li>
                    </ul>
                </details>
            </div>
            
            <!-- Nova Aba: Dashboard - ATUALIZADA -->
            <div class="tab-content" id="dashboard">
                <!-- NOVO: Indicador de data/hora da √∫ltima atualiza√ß√£o -->
                <div class="update-indicator" id="update-indicator">
                    Dados atualizados em: <span id="last-update-time">Carregando...</span>
                </div>
                <div id="manual-update-control" style="display:none; margin-top:8px; display:flex; gap:8px; align-items:center;">
                    <input type="datetime-local" id="manual-update-input" style="padding:6px;">
                    <button id="manual-update-save" class="btn-primary">Salvar</button>
                </div>
                <div id="dashboard-notification-cards" class="dashboard-grid"></div>
                
                <div class="dashboard-filters">
                    <div class="filter-group">
                        <label class="filter-label">Revenda</label>
                        <select class="filter-select" id="dashboard-filter-revenda">
                            <option value="">Todas</option>
                            <option value="1">Recife</option>
                            <option value="2">Natal</option>
                            <option value="3">Fortaleza</option>
                            <option value="4">Petrolina</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Situa√ß√£o OS</label>
                        <select class="filter-select" id="dashboard-filter-situacao">
                            <option value="Aberta" selected>Aberta</option>
                            <option value="Fechada">Fechada</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Status</label>
                        <select class="filter-select" id="dashboard-filter-status">
                            <option value="">Todos</option>
                            <option value="Sem Status">Sem Status</option>
                            <option value="Pendente de Pe√ßa">Pendente de Pe√ßa</option>
                            <option value="Pendente de Programa√ß√£o">Pendente de Programa√ß√£o</option>
                            <option value="Pendente Submiss√£o">Pendente Submiss√£o</option>
                            <option value="Programado">Programado</option>
                            <option value="Submiss√£o Aprovada">Submiss√£o Aprovada</option>
                            <option value="Submiss√£o em Processamento">Submiss√£o em Processamento</option>
                            <option value="Em Negocia√ß√£o">Em Negocia√ß√£o</option>
                            <option value="Servi√ßo Conclu√≠do">Servi√ßo Conclu√≠do</option>
                            <option value="Concluindo">Concluindo</option>
                            <option value="Em Atendimento">Em Atendimento</option>
                            <option value="Cancelado">Cancelado</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Escalonamento</label>
                        <select class="filter-select" id="dashboard-filter-escalonamento">
                            <option value="">Todos</option>
                            <option value="Isabelle, Ana Leya, Bruna">Isabelle, Ana Leya, Bruna</option>
                            <option value="Wanderley">Wanderley</option>
                            <option value="Graziela">Graziela</option>
                            <option value="Johnny">Johnny</option>
                            <option value="Ant√¥nio Gustavo">Ant√¥nio Gustavo</option>
                            <option value="Giovana e Fl√°via">Giovana e Fl√°via</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Tipo de OS</label>
                        <select class="filter-select" id="dashboard-filter-tipo">
                            <option value="">Todas</option>
                            <option value="Externa">Externa</option>
                            <option value="Interna">Interna</option>
                            <option value="Garantia">Garantia</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <button class="btn btn-primary" id="btn-aplicar-filtros-dashboard" style="margin-top: 25px;">Aplicar Filtros</button>
                    </div>
                </div>

                <!-- Totais do Dashboard - NOVA POSI√á√ÉO -->
                <div class="dashboard-totals-grid">
                    <div class="dashboard-total-card">
                        <div class="dashboard-total-value" id="dashboard-total-pecas">R$ 0,00</div>
                        <div class="dashboard-total-label">Total Pe√ßas</div>
                    </div>
                    <div class="dashboard-total-card">
                        <div class="dashboard-total-value" id="dashboard-total-servico">R$ 0,00</div>
                        <div class="dashboard-total-label">Total Servi√ßo</div>
                    </div>
                    <div class="dashboard-total-card">
                        <div class="dashboard-total-value" id="dashboard-total-os">R$ 0,00</div>
                        <div class="dashboard-total-label">Total OS</div>
                    </div>
                    <div class="dashboard-total-card">
                        <div class="dashboard-total-value" id="dashboard-total-geral">0</div>
                        <div class="dashboard-total-label">Total Geral de OS</div>
                    </div>
                </div>
                
                <div class="dashboard-grid">
                    <!-- REMOVIDO: Gr√°fico Quantidade Total de OS -->
                    
                    <!-- AJUSTADO: Gr√°fico OS por Status - mais largo -->
                    <div class="dashboard-card wide">
                        <h3>üìà OS por Status</h3>
                        <div class="dashboard-chart">
                            <canvas id="chart-os-status"></canvas>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>üè¢ OS por Revenda</h3>
                        <div class="dashboard-chart">
                            <canvas id="chart-os-revenda"></canvas>
                        </div>
                    </div>
                    
                    <!-- MODIFICADO: Gr√°fico OS por Dias (apenas Garantia) -->
                    <div class="dashboard-card">
                        <h3>üìÖ OS por Dias (Garantia)</h3>
                        <div class="dashboard-chart">
                            <canvas id="chart-os-dias-garantia"></canvas>
                        </div>
                    </div>
                    
                    <!-- NOVO: Gr√°fico OS por Dias (Todas, Externa, Interna) -->
                    <div class="dashboard-card">
                        <h3>üìÖ OS por Dias (Todas, Externa, Interna)</h3>
                        <div class="dashboard-chart">
                            <canvas id="chart-os-dias-todas"></canvas>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>üë• OS por Escalonamento</h3>
                        <div class="dashboard-chart">
                            <canvas id="chart-os-escalonamento"></canvas>
                        </div>
                    </div>
                    <div class="dashboard-card">
                        <h3>üîß OS por Tipo</h3>
                        <div class="dashboard-chart">
                            <canvas id="chart-os-tipo"></canvas>
                        </div>
                    </div>
                    <!-- NOVO GR√ÅFICO: Valores por Tipo de OS -->
                    <div class="dashboard-card">
                        <h3>üí∞ Valores por Tipo de OS</h3>
                        <div class="valor-filter">
                            <label>Filtrar por:</label>
                            <select id="valor-filter-select">
                                <option value="todas">Todas</option>
                                <option value="pecas">Pe√ßas</option>
                                <option value="servicos">Servi√ßos</option>
                            </select>
                        </div>
                        <div class="dashboard-chart">
                            <canvas id="chart-valores-tipo"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Nova Aba: Alerta -->
            <div class="tab-content" id="alerta">
                <div class="alert-config">
                    <h3>Configura√ß√£o de Alertas</h3>
                    <div class="form-group">
                        <label class="form-label">Usu√°rio Respons√°vel</label>
                        <select class="form-select" id="alerta-usuario">
                            <option value="">Selecione um usu√°rio</option>
                            <option value="Isabelle">Isabelle</option>
                            <option value="Ana Leya">Ana Leya</option>
                            <option value="Bruna">Bruna</option>
                            <option value="Wanderley">Wanderley</option>
                            <option value="Graziela">Graziela</option>
                            <option value="Johnny">Johnny</option>
                            <option value="Ant√¥nio Gustavo">Ant√¥nio Gustavo</option>
                            <option value="Giovana">Giovana</option>
                            <option value="Fl√°via">Fl√°via</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">E-mail para Notifica√ß√µes</label>
                        <input type="email" class="filter-input" id="alerta-email" placeholder="Digite o e-mail">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Dias para Alerta de Escalonamento</label>
                        <input type="number" class="filter-input" id="alerta-dias" value="5" min="1" max="30">
                    </div>
            <button class="btn btn-primary" id="btn-configurar-alerta">Configurar Alerta</button>
            <button class="btn btn-secondary" id="btn-testar-alerta" style="margin-left:8px">Enviar e-mail de teste</button>
            <button class="btn btn-secondary" id="btn-importar-alertas" style="margin-left:8px">Importar dados existentes</button>
                </div>
                
                <div class="alert-config">
                    <h3>Alertas Ativos</h3>
                    <div class="alert-list" id="alertas-ativos">
                        <div class="empty-state">Nenhum alerta configurado</div>
                    </div>
                </div>
                
                <div class="alert-config">
                    <h3>Hist√≥rico de Notifica√ß√µes</h3>
                    <div class="alert-list" id="historico-alertas">
                        <div class="empty-state">Nenhuma notifica√ß√£o enviada</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="tab-content" id="gerenciar-status">
            <h2>Gerenciamento de Status</h2>
            <div class="status-management">
                <div class="status-form">
                    <input type="text" id="status-name" placeholder="Nome do Status">
                    <input type="color" id="status-color" value="#007bff">
                    <button onclick="saveStatus()">Salvar</button>
                </div>
                <div id="status-list" class="status-list"></div>
                <h3>Status do Sistema</h3>
                <div id="system-status-list" class="status-list"></div>
            </div>
        </div>

        <!-- ABA: LOG DE ALTERA√á√ÉO DE STATUS -->
        <div class="tab-content" id="logs-status">
            <h2 class="section-title">Log de Altera√ß√£o de Status</h2>
            <div class="filters-row" id="logs-filters" style="gap: 12px; align-items: center;">
                <label>Per√≠odo:
                    <select id="log-range-mode" class="filter-select">
                        <option value="mes_atual" selected>M√™s atual</option>
                        <option value="todos">Todos</option>
                        <option value="janeiro">Janeiro</option>
                        <option value="fevereiro">Fevereiro</option>
                        <option value="mar√ßo">Mar√ßo</option>
                        <option value="abril">Abril</option>
                        <option value="maio">Maio</option>
                        <option value="junho">Junho</option>
                        <option value="julho">Julho</option>
                        <option value="agosto">Agosto</option>
                        <option value="setembro">Setembro</option>
                        <option value="outubro">Outubro</option>
                        <option value="novembro">Novembro</option>
                        <option value="dezembro">Dezembro</option>
                    </select>
                </label>
                <label>Usu√°rio:
                    <select id="log-user-select" class="filter-select">
                        <option value="__all__">Todos</option>
                    </select>
                </label>
                <button id="btn-aplicar-filtros-log" class="primary-btn">Aplicar filtros</button>
            </div>

            <div id="log-summary" class="info-card" style="margin-top: 12px;">
                <p id="log-summary-text">Carregando m√©tricas...</p>
            </div>

            <!-- CARDS DE PRODUTIVIDADE -->
            <div class="productivity-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-top: 16px;">
                <div class="productivity-card" id="card-os-alteradas" style="background: linear-gradient(135deg, #4CAF50, #45a049); color: white; padding: 16px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                    <div style="font-size: 14px; opacity: 0.9;">OS com Altera√ß√£o</div>
                    <div style="font-size: 24px; font-weight: bold; margin: 8px 0;">0</div>
                    <div style="font-size: 12px;">no per√≠odo</div>
                </div>
                
                <div class="productivity-card" id="card-os-sem-alteracao" style="background: linear-gradient(135deg, #f44336, #d32f2f); color: white; padding: 16px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                    <div style="font-size: 14px; opacity: 0.9;">OS sem Altera√ß√£o</div>
                    <div style="font-size: 24px; font-weight: bold; margin: 8px 0;">0</div>
                    <div style="font-size: 12px;">total no per√≠odo</div>
                </div>
                
                <div class="productivity-card" id="card-percentual-processado" style="background: linear-gradient(135deg, #2196F3, #1976D2); color: white; padding: 16px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                    <div style="font-size: 14px; opacity: 0.9;">% Processado</div>
                    <div style="font-size: 24px; font-weight: bold; margin: 8px 0;">0%</div>
                    <div style="font-size: 12px;">efici√™ncia do dia</div>
                </div>
                
                <div class="productivity-card" id="card-visitas-usuario" style="background: linear-gradient(135deg, #9C27B0, #7B1FA2); color: white; padding: 16px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                    <div style="font-size: 14px; opacity: 0.9;">Total de Logins</div>
                    <div style="font-size: 24px; font-weight: bold; margin: 8px 0;">0</div>
                    <div style="font-size: 12px;">tempo logado: 00:00</div>
                </div>

                <div class="productivity-card" id="card-logins-por-usuario" style="background: #ffffff; color: #333; padding: 16px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                    <div style="font-size: 14px; opacity: 0.9;">Logins por Usu√°rio (no per√≠odo)</div>
                    <div id="logins-por-usuario-list" style="margin-top: 8px; display: flex; flex-direction: column; gap: 6px;">
                        <!-- itens preenchidos via JS -->
                    </div>
                </div>
            </div>

            <div class="dashboard-chart" style="margin-top: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items: stretch;">
                <div style="height: 280px; overflow-x: auto; overflow-y: hidden; white-space: nowrap;"><canvas id="chart-logs-status"></canvas></div>
                <div style="height: 280px;"><canvas id="chart-logs-por-usuario"></canvas></div>
            </div>

            <div class="table-container" style="margin-top: 12px;">
                <table class="styled-table" id="log-status-table">
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>Usu√°rio</th>
                            <th>N¬∫ OS</th>
                            <th>Revenda</th>
                            <th>Tipo OS</th>
                            <th>Status Anterior</th>
                            <th>Status Novo</th>
                        </tr>
                    </thead>
                    <tbody id="log-status-tbody">
                        <!-- Preenchido via JS -->
                    </tbody>
                </table>
                <div id="logs-load-more" style="text-align:center; margin-top:8px;">
                    <button class="btn" id="btn-logs-load-more">Carregar mais</button>
                </div>
            </div>
        </div>

        <!-- Aba: Cadastrar Usu√°rios -->
        <div class="tab-content" id="cadastro-usuarios">
            <div class="filters" style="display:block; margin-bottom:16px; background:#fff; padding:24px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.05);">
                <h3 style="margin:0 0 12px 0">Cadastrar Novo Usu√°rio</h3>
                <form id="form-cadastro-usuario" class="filters" style="grid-template-columns: repeat(2, minmax(320px, 1fr)); gap:24px; align-items:start;">
                    <input type="hidden" id="cad-user-id" />
                    <div class="filter-group" style="flex:1; min-width:320px;">
                        <label class="filter-label">Nome Completo *</label>
                        <input type="text" class="filter-input" id="cad-nome-completo" placeholder="Ex.: Jo√£o da Silva" required>
                    </div>
                    <div class="filter-group" style="flex:1; min-width:280px;">
                        <label class="filter-label">Usu√°rio *</label>
                        <input type="text" class="filter-input" id="cad-usuario" placeholder="Ex.: joao.silva" required>
                    </div>
                    <div class="filter-group" style="flex:1; min-width:320px;">
                        <label class="filter-label">E-mail *</label>
                        <input type="email" class="filter-input" id="cad-email" placeholder="email@exemplo.com" required>
                    </div>
                    <div class="filter-group" style="flex:1; min-width:280px;">
                        <label class="filter-label">Tipo de Usu√°rio *</label>
                        <select class="filter-select" id="cad-tipo-usuario" required>
                            <option value="Administrador">Administrador</option>
                            <option value="Gestor">Gestor</option>
                            <option value="Usu√°rio" selected>Usu√°rio</option>
                        </select>
                    </div>
                    <div style="flex-basis:100%; display:flex; gap:8px;">
                        <button type="submit" class="btn btn-success" id="btn-salvar-usuario" style="flex:1;">Cadastrar Usu√°rio</button>
                        <button type="button" class="btn" id="btn-limpar-cadastro">Limpar</button>
                    </div>
                </form>
            </div>

            <div class="filters" style="display:block; background:#fff; padding:24px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.05);">
                <h3 style="margin:0 0 12px 0">Usu√°rios Cadastrados</h3>
                <table id="tabela-usuarios" style="width:100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="text-align:left; padding:8px;">Nome</th>
                            <th style="text-align:left; padding:8px;">Usu√°rio</th>
                            <th style="text-align:left; padding:8px;">E-mail</th>
                            <th style="text-align:left; padding:8px;">Tipo</th>
                            <th style="text-align:left; padding:8px;">Primeiro Login</th>
                            <th style="text-align:left; padding:8px;">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-usuarios">
                        <tr><td colspan="6"><div class="empty-state">Nenhum usu√°rio encontrado</div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    
    <!-- Modal -->
    <div class="modal" id="update-modal">
        <div class="modal-content">
            <div class="modal-header"><h2 class="modal-title">Atualizar OS</h2><button class="close-modal">&times;</button></div>
            <form id="update-form">
                <input type="hidden" id="update-os-id">
                <div class="form-group"><label class="form-label">Nro. OS</label><input type="text" class="form-select" id="update-nro-os" readonly></div>
                <div class="form-group">
                    <label class="form-label" for="update-situacao">Situa√ß√£o OS</label>
                    <select class="form-select" id="update-situacao">
                        <option value="Aberta">Aberta</option>
                        <option value="Fechada">Fechada</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="update-status">Status</label>
                    <select class="form-select" id="update-status">
                        <option value="Sem Status">Sem Status</option>
                        <option value="Pendente de Pe√ßa">Pendente de Pe√ßa</option>
                        <option value="Pendente de Programa√ß√£o">Pendente de Programa√ß√£o</option>
                        <option value="Pendente Submiss√£o">Pendente Submiss√£o</option>
                        <option value="Programado">Programado</option>
                        <option value="Submiss√£o Aprovada">Submiss√£o Aprovada</option>
                        <option value="Submiss√£o em Processamento">Submiss√£o em Processamento</option>
                        <option value="Em Negocia√ß√£o">Em Negocia√ß√£o</option>
                        <option value="Servi√ßo Conclu√≠do">Servi√ßo Conclu√≠do</option>
                        <option value="Concluindo">Concluindo</option>
                        <option value="Em Atendimento">Em Atendimento</option>
                        <option value="Cancelado">Cancelado</option>
                    </select>
                </div>
                <div class="form-group"><label class="form-label" for="update-observacao">Observa√ß√£o</label><textarea class="form-textarea" id="update-observacao"></textarea></div>
                <div class="form-group"><label class="form-label" for="update-acao-atualizacao">A√ß√£o / Atualiza√ß√£o</label><textarea class="form-textarea" id="update-acao-atualizacao"></textarea></div>
                <div class="modal-footer"><button type="button" class="btn close-modal">Cancelar</button><button type="submit" class="btn btn-primary">Salvar</button></div>
            </form>
        </div>
    </div>

    <!-- Modal de Senha para Acesso aos Alertas -->
    <div class="password-modal" id="password-modal">
        <div class="password-modal-content">
            <h2 class="password-title">üîí Acesso Restrito</h2>
            <p>Para acessar a aba de Alertas, digite a senha de administra√ß√£o:</p>
            <form id="password-form">
                <input type="password" class="password-input" id="password-input" placeholder="Digite a senha" autocomplete="off">
                <div class="password-error" id="password-error">Senha incorreta. Tente novamente.</div>
                <div class="modal-footer" style="margin-top: 20px;">
                    <button type="button" class="btn" onclick="fecharModalSenha()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Acessar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal: Trocar Senha no Primeiro Login -->
    <div class="modal" id="modal-change-password" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Definir Nova Senha</h2>
                <button class="close-modal" id="close-change-password">&times;</button>
            </div>
            <form id="form-change-password">
                <div class="form-group">
                    <label class="form-label">Nova Senha</label>
                    <input type="password" class="form-select" id="new-pass" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Confirmar Nova Senha</label>
                    <input type="password" class="form-select" id="new-pass-confirm" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" id="cancel-change-password">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Atualizar Senha</button>
                </div>
                <div id="change-pass-feedback" class="feedback" style="display:none;"></div>
            </form>
        </div>
    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-main">¬© 2025 NORMAQ JCB - Todos os direitos reservados ‚Ä¢ v1.3</div>
            <div class="footer-sub">Desenvolvido por Thiago Carmo ‚Äì Especialista em Dados e Desenvolvedor</strong><br/></div>
            <div class="footer-contact"><span>üìû (81) 99514-3900</span><span class="footer-divider">‚Ä¢</span><span>üìß thiago.carmo@normaq.com.br</span></div>
        </div>
    </footer>

    <script>
        // --- CONFIGURA√á√ÉO ---
        const supabaseUrl = 'https://jnbirdxgllehrikluftu.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpuYmlyZHhnbGxlaHJpa2x1ZnR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMDcxNTgsImV4cCI6MjA3NjU4MzE1OH0.OG4LjCJFAvOl0IOIrPlL3wZ4f7EeDcO-rUZ3dDIOqi4';
        
        // Verifica se a biblioteca Supabase est√° carregada
        if (typeof window.supabase === 'undefined') {
            console.error('Erro: Biblioteca Supabase n√£o carregada!');
            alert('Erro: Biblioteca Supabase n√£o carregada. Verifique a conex√£o com a internet.');
        }
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        console.log('Supabase inicializado:', !!supabase);
        const tabelaBase = 'Base_OS';
        const tabelaStatus = 'status_customizados';

        // =============================================
        // CONFIGURA√á√ÉO DO EMAILJS - CREDENCIAIS INSERIDAS
        // =============================================
        const emailjsConfig = {
            serviceId: 'service_erkwc1t',
            templateId: 'template_d1ec1cc',
            publicKey: 'knjNxsRamdV3bihTc'
        };

        // =============================================
        // CONFIGURA√á√ÉO DE SEGURAN√áA
        // =============================================
        const SENHA_ADMIN = 'NMQ@2025';
        let acessoAlertasLiberado = false;

        // Inicializar EmailJS
        (function() {
            emailjs.init(emailjsConfig.publicKey);
            console.log('EmailJS inicializado com sucesso!');
        })();

        // --- VARI√ÅVEIS GLOBAIS ---
        let currentTab = 'externa';
        let osData = { externa: [], interna: [], garantia: [] };
        const revendasMap = { '1': 'Recife', '2': 'Natal', '3': 'Fortaleza', '4': 'Petrolina' };
        const tiposMap = { 'externa': 'Externa', 'interna': 'Interna', 'garantia': 'Garantia' };

        // Estado da aba Atualizar Valores (CSV)
        const CSV_VAL_REQUIRED = ['Total Pecas', 'Total Servico', 'Total OS'];
        const CSV_VAL_KEY_FIELDS = ['Chave', 'Numero OS'];
        const revendasReverse = { 'Recife':'1', 'Natal':'2', 'Fortaleza':'3', 'Petrolina':'4' };
        let csvValoresState = { records: [], valid: false, headers: [], issues: [] };

        // Cache de usu√°rios para edi√ß√£o
        let usuariosCache = [];

        // Hist√≥rico de escalonamento para detectar mudan√ßas
        let historicoEscalonamento = JSON.parse(localStorage.getItem('historicoEscalonamento')) || {};

        // NOVO: Vari√°vel para controlar a √∫ltima atualiza√ß√£o (persistente)
        const LAST_UPDATE_TIME_KEY = 'NormaQLastUpdateTime';
        let lastUpdateTime = (() => {
            try {
                const t = localStorage.getItem(LAST_UPDATE_TIME_KEY);
                return t ? new Date(t) : null;
            } catch(_) { return null; }
        })();

        // NOVO: Estado de contagem por aba para controlar atualiza√ß√£o somente em aumento (persistente)
        const TAB_UPDATE_STATE_KEY = 'NormaQTabUpdateState';
        const tabUpdateState = (() => {
            try {
                const raw = localStorage.getItem(TAB_UPDATE_STATE_KEY);
                if (raw) {
                    const parsed = JSON.parse(raw);
                    ['externa','interna','garantia'].forEach(tab => {
                        if (!parsed[tab]) parsed[tab] = { initialized: false, lastCount: 0 };
                        if (typeof parsed[tab].initialized !== 'boolean') parsed[tab].initialized = false;
                        if (typeof parsed[tab].lastCount !== 'number') parsed[tab].lastCount = 0;
                    });
                    return parsed;
                }
            } catch(_) {}
            return {
                externa: { initialized: false, lastCount: 0 },
                interna: { initialized: false, lastCount: 0 },
                garantia: { initialized: false, lastCount: 0 }
            };
        })();

        let logsFullData = [];
        let logsRenderedCount = 0;
        const LOGS_CHUNK_SIZE = 300;
        const LOGS_FETCH_LIMIT = 3000;
        const LOGS_PAGE_SIZE = 200;
        let logsOffset = 0;
        let logsHasMore = true;
        const OS_TIPO_CHUNK = 200;

        function formatDateTimeBR(date) {
            return date.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // Atualiza o indicador do Dashboard quando h√° aumento em qualquer aba
        function setDashboardUpdateIndicator(date) {
            lastUpdateTime = date;
            try { localStorage.setItem(LAST_UPDATE_TIME_KEY, date.toISOString()); } catch(_) {}
            const el = document.getElementById('last-update-time');
            if (el) el.textContent = formatDateTimeBR(date);
        }

        // Atualiza o indicador no campo verde (topo √† direita)
        function setSuccessUpdateIndicator(date) {
            const el = document.getElementById('success-last-update-time');
            if (!el) return;
            // Sempre mostra a √∫ltima data/hora conhecida quando fornecida
            el.textContent = date ? formatDateTimeBR(date) : (el.textContent || '‚Äî');
        }

        async function loadManualUpdateTimestamp() {
            try {
                const { data, error } = await supabase.from('app_config').select('value').eq('key', 'last_update_time').limit(1);
                if (!error && Array.isArray(data) && data.length > 0 && (data[0].value || data[0].value === '')) {
                    const d = new Date(data[0].value || localStorage.getItem(LAST_UPDATE_TIME_KEY) || '');
                    if (!isNaN(d)) {
                        setDashboardUpdateIndicator(d);
                        setSuccessUpdateIndicator(d);
                        return true;
                    }
                }
            } catch(_) {}
            try {
                const { data } = await supabase
                    .from('status_logs')
                    .select('created_at')
                    .eq('status_novo', '__last_update__')
                    .order('created_at', { ascending: false })
                    .limit(1);
                if (Array.isArray(data) && data.length > 0 && data[0].created_at) {
                    const d = new Date(data[0].created_at);
                    if (!isNaN(d)) {
                        setDashboardUpdateIndicator(d);
                        setSuccessUpdateIndicator(d);
                        try { localStorage.setItem(LAST_UPDATE_TIME_KEY, d.toISOString()); } catch(_) {}
                        return true;
                    }
                }
            } catch(_) {}
            return false;
        }

        async function saveManualUpdateTimestamp(iso) {
            try {
                const userInfo = getCurrentUserInfo();
                if (!userInfo || userInfo.usuario !== 'thiago.carmo') return 'error';
                const payload = { key: 'last_update_time', value: iso, updated_by: userInfo ? userInfo.id : null, empresa_id: userInfo ? userInfo.empresa_id : null };
                const { error } = await supabase.from('app_config').upsert(payload, { onConflict: 'key' });
                if (error) {
                    try {
                        const logPayload = {
                            usuario: userInfo.usuario,
                            nome_completo: userInfo.nome_completo,
                            tipo_usuario: userInfo.tipo_usuario,
                            os_id: null,
                            nro_os: '0',
                            revenda: null,
                            status_anterior: null,
                            status_novo: '__last_update__',
                            created_at: iso
                        };
                        const { error: logError } = await supabase.from('status_logs').insert(logPayload);
                        if (logError) {
                            try { localStorage.setItem(LAST_UPDATE_TIME_KEY, iso); } catch(_) {}
                            return 'local';
                        }
                        try { localStorage.setItem(LAST_UPDATE_TIME_KEY, iso); } catch(_) {}
                        return 'server';
                    } catch(_) {
                        try { localStorage.setItem(LAST_UPDATE_TIME_KEY, iso); } catch(_) {}
                        return 'local';
                    }
                }
                try { localStorage.setItem(LAST_UPDATE_TIME_KEY, iso); } catch(_) {}
                return 'server';
            } catch(_) {
                try { localStorage.setItem(LAST_UPDATE_TIME_KEY, iso); } catch(_) {}
                return 'local';
            }
        }

        // Avalia aumento de contagem e atualiza indicadores (tab + dashboard)
        function evaluateIncreaseAndUpdateIndicators(tab, newCount) {
            const state = tabUpdateState[tab];
            if (!state) return;
            if (!state.initialized) {
                state.initialized = true;
                state.lastCount = newCount;
                // N√£o sobrescreve o indicador de sucesso na primeira inicializa√ß√£o
                try { localStorage.setItem(TAB_UPDATE_STATE_KEY, JSON.stringify(tabUpdateState)); } catch(_) {}
                return;
            }
            if (typeof newCount === 'number' && newCount > state.lastCount) {
                state.lastCount = newCount;
                const now = new Date();
                setSuccessUpdateIndicator(now);
                setDashboardUpdateIndicator(now);
                try { localStorage.setItem(TAB_UPDATE_STATE_KEY, JSON.stringify(tabUpdateState)); } catch(_) {}
            } else {
                // Atualiza baseline sem alterar timestamps
                state.lastCount = newCount;
                try { localStorage.setItem(TAB_UPDATE_STATE_KEY, JSON.stringify(tabUpdateState)); } catch(_) {}
            }
        }

        // --- FUN√á√ïES DE SEGURAN√áA ---

        function verificarSenha() {
            const passEl = document.getElementById('password-input');
            const senhaDigitada = passEl ? passEl.value : '';
            const errorElement = document.getElementById('password-error');
            
            if (senhaDigitada === SENHA_ADMIN) {
                acessoAlertasLiberado = true;
                const modalEl = document.getElementById('password-modal');
                if (modalEl) modalEl.style.display = 'none';
                const alertaTab = document.getElementById('alerta-tab');
                if (alertaTab) alertaTab.classList.remove('tab-disabled');
                if (passEl) passEl.value = '';
                errorElement.style.display = 'none';
                
                // Agora carrega a aba de alertas
                document.querySelector('.tab.active').classList.remove('active');
                document.querySelector('.tab-content.active').classList.remove('active');
                if (alertaTab) alertaTab.classList.add('active');
                const alertaContent = document.getElementById('alerta');
                if (alertaContent) alertaContent.classList.add('active');
                currentTab = 'alerta';
                
                loadAlertas();
            } else {
                errorElement.style.display = 'block';
                if (passEl) { passEl.value = ''; passEl.focus(); }
            }
        }

        function fecharModalSenha() {
            const modalEl = document.getElementById('password-modal');
            if (modalEl) modalEl.style.display = 'none';
            const passEl = document.getElementById('password-input');
            if (passEl) passEl.value = '';
            const errEl = document.getElementById('password-error');
            if (errEl) errEl.style.display = 'none';
            
            // Volta para a aba anterior
            if (currentTab === 'alerta') {
                document.querySelector('.tab.active').classList.remove('active');
                document.querySelector('.tab-content.active').classList.remove('active');
                const externaTab = document.getElementById('externa-tab');
                const externaContent = document.getElementById('externa');
                if (externaTab) externaTab.classList.add('active');
                if (externaContent) externaContent.classList.add('active');
                currentTab = 'externa';
            }
        }

        function abrirModalSenha() {
            const modalEl = document.getElementById('password-modal');
            if (modalEl) modalEl.style.display = 'flex';
            const passEl = document.getElementById('password-input');
            if (passEl) passEl.focus();
        }

        // --- FUN√á√ïES DE DATA E HORA ---

        function updateDateTime() {
            const now = new Date();
            
            // Formata hora
            const time = now.toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
            
            // Formata data
            const date = now.toLocaleDateString('pt-BR');
            
            // Formata dia da semana
            const days = ['Domingo', 'Segunda-feira', 'Ter√ßa-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'S√°bado'];
            const day = days[now.getDay()];
            
            // Atualiza elementos HTML
            document.getElementById('current-time').textContent = time;
            document.getElementById('current-date').textContent = date;
            document.getElementById('current-day').textContent = day;
        }

        // NOVO: Fun√ß√£o para atualizar o indicador de √∫ltima atualiza√ß√£o
        function updateLastUpdateTime() {
            const now = new Date();
            lastUpdateTime = now;
            const formattedTime = now.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('last-update-time').textContent = formattedTime;
        }

        /**
         * Interpreta a data de forma robusta, for√ßando o formato DD/MM/YYYY se houver barras.
         */
        function parseDate(dateString) {
            if (!dateString) return null;
            
            // Se for formato DD/MM/YYYY
            if (dateString.includes('/')) {
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    // new Date(ano, m√™s-indexado-em-0, dia)
                    // parts[2] = Ano, parts[1] = M√™s (1-12), parts[0] = Dia
                    return new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                }
            }
            
            // Se for formato ISO YYYY-MM-DD (vindo do banco, por exemplo)
            if (dateString.includes('-')) {
                const parts = dateString.split('-');
                if (parts.length === 3) {
                     return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                }
            }

            return new Date(dateString); // Tenta o padr√£o se falhar
        }

        /**
         * Calcula a diferen√ßa em dias inteiros entre a data fornecida e HOJE.
         * Zera as horas para garantir que a conta seja exata em dias.
         */
        function calculateDaysRobust(dateString) {
            const dEmissao = parseDate(dateString);
            if (!dEmissao || isNaN(dEmissao.getTime())) return 0;

            const hoje = new Date();
            
            // Zera as horas para comparar apenas as datas
            dEmissao.setHours(0, 0, 0, 0);
            hoje.setHours(0, 0, 0, 0);

            const diffMs = hoje - dEmissao;
            // Converte de milissegundos para dias
            return Math.floor(diffMs / (1000 * 60 * 60 * 24));
        }

        /**
         * Formata para DD/MM/YYYY para exibi√ß√£o
         */
        function formatDate(dateString) {
             const date = parseDate(dateString);
             if (!date || isNaN(date.getTime())) return dateString || '-';
             return new Intl.DateTimeFormat('pt-BR').format(date);
        }

        /**
         * Calcula os dias em aberto conforme as regras especificadas
         * Se situa√ß√£o = "Aberta": conta da emiss√£o at√© hoje
         * Se situa√ß√£o = "Fechada": usa o valor est√°tico da coluna Dias
         */
        function calcularDiasEmAberto(os) {
            const situacao = os['Situacao OS'] || '';
            const situacaoLower = situacao.toLowerCase();
            
            if (situacaoLower.includes('fechad')) {
                // Se est√° fechada, usa o valor congelado da coluna Dias (com fallback seguro)
                const raw = os.Dias;
                let diasFechado = 0;
                if (raw !== undefined && raw !== null) {
                    const normalized = String(raw).trim();
                    const parsed = parseInt(normalized, 10);
                    if (!isNaN(parsed) && parsed >= 0) {
                        diasFechado = parsed;
                    }
                }
                console.log('OS Fechada:', os['Numero OS'], 'Situa√ß√£o:', situacao, 'Dias:', diasFechado, '(raw:', raw, ')');
                return diasFechado;
            } else {
                // Se est√° aberta, calcula da emiss√£o at√© hoje
                const diasCalculados = calculateDaysRobust(os.Emissao);
                const resultado = (Number.isFinite(diasCalculados) && diasCalculados >= 0) ? diasCalculados : 0;
                console.log('OS Aberta:', os['Numero OS'], 'Emiss√£o:', os.Emissao, 'Dias Calculados:', resultado);
                return resultado;
            }
        }

        /**
         * Retorna a classe CSS para o status - ATUALIZADO COM NOVOS STATUS
         */
        function getStatusClass(status) {
            if (!status) return 'status-sem-status';
            
            const statusMap = {
                'Sem Status': 'status-sem-status',
                'Pendente de Pe√ßa': 'status-pendente-peca',
                'Pendente de Programa√ß√£o': 'status-pendente-programacao',
                'Pendente Submiss√£o': 'status-pendente-submissao',
                'Programado': 'status-programado',
                'Submiss√£o Aprovada': 'status-submissao-aprovada',
                'Submiss√£o em Processamento': 'status-submissao-processamento',
                'Em Negocia√ß√£o': 'status-em-negociacao',
                'Servi√ßo Conclu√≠do': 'status-servico-concluido',
                'Em Atendimento': 'status-em-atendimento', // NOVO STATUS
                'Cancelado': 'status-cancelado' // NOVO STATUS
            };
            
            return statusMap[status] || 'status-sem-status';
        }
        
        async function getStatusColor(status) {
            if (!status) return '#e9ecef'; // Cor padr√£o para 'Sem Status'

            const customStatuses = await loadStatusFromStorage();
            const normalizedStatus = status.toLowerCase().trim();

            const customStatus = customStatuses.find(s => s.name.toLowerCase().trim() === normalizedStatus);

            if (customStatus) {
                return customStatus.color;
            }

            // Cores padr√£o para status do sistema
            const defaultColors = {
                'pendente de pe√ßa': '#dc3545',
                'pendente de programa√ß√£o': '#dc3545',
                'pendente submiss√£o': '#dc3545',
                'programado': '#fd7e14',
                'submiss√£o aprovada': '#28a745',
                'submiss√£o em processamento': '#ffc107',
                'em negocia√ß√£o': '#17a2b8',
                'servi√ßo conclu√≠do': '#28a745',
                'concluindo': '#6f42c1',
                'em atendimento': '#8B4513',
                'cancelado': '#000000'
            };

            return defaultColors[normalizedStatus] || '#e9ecef';
        }

        /**
         * Extrai o status da observa√ß√£o (formato: "[Status: X] resto da observa√ß√£o")
         */
        function extrairStatusDaObservacao(observacao) {
            if (!observacao) return 'Sem Status';
            
            const match = observacao.match(/^\[Status:\s*(.*?)\]\s*(.*)/);
            if (match && match[1]) {
                return match[1];
            }
            return 'Sem Status';
        }

        /**
         * Extrai a observa√ß√£o sem o status
         */
        function extrairObservacaoSemStatus(observacao) {
            if (!observacao) return '';
            
            const match = observacao.match(/^\[Status:\s*(.*?)\]\s*(.*)/);
            if (match && match[2]) {
                return match[2];
            }
            return observacao;
        }

        /**
         * Combina status e observa√ß√£o em uma string
         */
        function combinarStatusEObservacao(status, observacao) {
            if (status === 'Sem Status' || !status) {
                return observacao || '';
            }
            return `[Status: ${status}] ${observacao || ''}`.trim();
        }

        // --- FUN√á√ïES DE ALERTA POR E-MAIL ---
        const EMAIL_SENDING_ENABLED = true;
        const SEND_PRESTES_A_SAIR = false;
        const EXCLUDED_ALERT_USERS = ['daniel leite pereira','daniel leite','daniel.leite','daniel'];
        const EXCLUDED_ALERT_EMAILS = [];
        function isExcludedAlertUser(nameOrEmail) {
            const s = String(nameOrEmail||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
            if (!s) return false;
            if (EXCLUDED_ALERT_USERS.some(x => s.includes(x))) return true;
            if (EXCLUDED_ALERT_EMAILS.some(x => s.includes(x))) return true;
            return false;
        }

        /**
         * Envia e-mail usando EmailJS - FUN√á√ÉO √öNICA PARA AMBOS OS TIPOS
         * Retorna { success: boolean, error?: any }
         */
        async function enviarEmailReal(destinatario, assunto, mensagem) {
            if (!EMAIL_SENDING_ENABLED) {
                console.warn('Envio de e-mail desativado (modo ajustes):', assunto);
                return { success: false, error: 'email-disabled' };
            }
            const email = String(destinatario || '').trim();
            const valido = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i.test(email);
            if (!valido) return { success: false, error: 'E-mail do destinat√°rio inv√°lido: ' + email };
            const base = {
                subject: assunto,
                message: mensagem,
                message_html: String(mensagem || '').replace(/\n/g, '<br>'),
                conteudo: mensagem,
                conteudo_html: String(mensagem || '').replace(/\n/g, '<br>'),
                reply_to: 'no-reply@normaq.com.br',
                from_name: 'Sistema de Controle de OS',
                tipo_alerta: assunto.includes('Escalonada') ? 'Nova OS Escalonada' : 'Alerta de Escalonamento'
            };
            try {
                const p1 = { ...base, to_email: email };
                await emailjs.send(
                    emailjsConfig.serviceId,
                    emailjsConfig.templateId,
                    p1,
                    emailjsConfig.publicKey
                );
                return { success: true };
            } catch (e1) {
                const t = (e1 && (e1.text || e1.message)) || '';
                try {
                    const p2 = { ...base, to: email };
                    await emailjs.send(
                        emailjsConfig.serviceId,
                        emailjsConfig.templateId,
                        p2,
                        emailjsConfig.publicKey
                    );
                    return { success: true };
            } catch (e2) {
                const detalhe = e2?.text || e2?.message || JSON.stringify(e2);
                const known = (String(detalhe || '').toLowerCase().includes('recipients address is empty'));
                const hint = known
                    ? 'Template EmailJS sem destinat√°rio. No painel do EmailJS, abra o template "template_d1ec1cc" e mapeie o campo "To email" para {{to_email}} (ou {{to}}). Em Allowed Origins inclua o dom√≠nio atual (ex.: http://127.0.0.1:5504).'
                    : detalhe;
                return { success: false, error: hint };
            }
        }
        }

        /**
         * ALERTA 1: Verifica OS pr√≥ximas de escalonamento
         */
        async function verificarOSProximasEscalonamento() {
            try {
                console.log('Verificando OS pr√≥ximas de escalonamento...');
                const { data, error } = await supabase.from(tabelaBase).select('*');
                if (error) throw error;
                
                const alertas = await fetchAlertasConfigSupabase();
                const notificacoes = await fetchHistoricoNotificacoesSupabase();
                const processed = new Set();
                
                for (const alerta of alertas) {
                    if (!alerta.ativo) continue;
                    if (isExcludedAlertUser(alerta.usuario) || isExcludedAlertUser(alerta.email)) continue;
                    const key = `${alerta.usuario}|${alerta.email}`;
                    if (processed.has(key)) continue;
                    
                    // ALERTA 1: OS pr√≥ximas de serem escalonadas (para todos os usu√°rios)
                    const osProximasEscalonamento = data.filter(os => {
                        const dias = calcularDiasEmAberto(os);
                        const escalonamentoAtual = getEscalonamento(os.Tipo?.toLowerCase() || 'externa', dias, os.Revenda);
                        const proximoEscalonamento = getProximoEscalonamento(os.Tipo?.toLowerCase() || 'externa', dias, os.Revenda);
                        const situacao = String(os['Situacao OS'] || '').toLowerCase();
                        if (!situacao.includes('abert')) return false;
                        
                        // Para Ant√¥nio Gustavo - comportamento especial
                        if (alerta.usuario === 'Ant√¥nio Gustavo') {
                            return escalonamentoAtual !== alerta.usuario && 
                                   proximoEscalonamento === alerta.usuario &&
                                   dias >= (getLimiteEscalonamento(os.Tipo?.toLowerCase() || 'externa', alerta.usuario) - parseInt(alerta.dias));
                        }
                        
                        // Para outros usu√°rios - alerta normal
                        return escalonamentoAtual === alerta.usuario && 
                               proximoEscalonamento !== alerta.usuario &&
                               dias >= (getLimiteEscalonamento(os.Tipo?.toLowerCase() || 'externa', alerta.usuario) - parseInt(alerta.dias));
                    });
                    
                    if (osProximasEscalonamento.length > 0) {
                        const titulo = `‚ö†Ô∏è Alerta: OS Pr√≥xima de Escalonamento`;
                        let mensagemText = '';
                        let mensagemHtml = '';
                        if (alerta.usuario === 'Ant√¥nio Gustavo') {
                            mensagemText = `Prezado Ant√¥nio Gustavo,\n\n` +
                                `Voc√™ possui ${osProximasEscalonamento.length} OS que estar√£o pr√≥ximas de ser escalonadas para voc√™ em breve:\n\n`;
                            mensagemHtml = `<p>Prezado Ant√¥nio Gustavo,</p><p>Voc√™ possui <strong>${osProximasEscalonamento.length}</strong> OS que estar√£o pr√≥ximas de ser escalonadas para voc√™ em breve:</p><ul>`;
                            osProximasEscalonamento.forEach(os => {
                                const escalonamentoAtual = getEscalonamento(os.Tipo?.toLowerCase() || 'externa', calcularDiasEmAberto(os), os.Revenda);
                                const diasParaEscalonar = getLimiteEscalonamento(os.Tipo?.toLowerCase() || 'externa', alerta.usuario) - calcularDiasEmAberto(os);
                                mensagemText += `‚Ä¢ OS ${os['Numero OS']} - ${os.Cliente || 'N/A'} (Tipo: ${os.Tipo || '‚Äî'} | Atual: ${escalonamentoAtual} | Dias para escalonar: ${diasParaEscalonar})\n`;
                                mensagemHtml += `<li><strong>OS ${os['Numero OS']}</strong> - ${os.Cliente || 'N/A'} <em>(Tipo: ${os.Tipo || '‚Äî'} | Atual: ${escalonamentoAtual} | Dias para escalonar: ${diasParaEscalonar})</em></li>`;
                            });
                            mensagemHtml += `</ul>`;
                        } else {
                            mensagemText = `Prezado(a) ${alerta.usuario},\n\n` +
                                `Voc√™ possui ${osProximasEscalonamento.length} OS pr√≥ximas de serem escalonadas. A√ß√£o necess√°ria:\n\n`;
                            mensagemHtml = `<p>Prezado(a) ${alerta.usuario},</p><p>Voc√™ possui <strong>${osProximasEscalonamento.length}</strong> OS pr√≥ximas de serem escalonadas. A√ß√£o necess√°ria:</p><ul>`;
                            osProximasEscalonamento.forEach(os => {
                                const proximoEscalonamento = getProximoEscalonamento(os.Tipo?.toLowerCase() || 'externa', calcularDiasEmAberto(os), os.Revenda);
                                const diasParaEscalonar = getLimiteEscalonamento(os.Tipo?.toLowerCase() || 'externa', alerta.usuario) - calcularDiasEmAberto(os);
                                mensagemText += `‚Ä¢ OS ${os['Numero OS']} - ${os.Cliente || 'N/A'} (Tipo: ${os.Tipo || '‚Äî'} | Pr√≥ximo: ${proximoEscalonamento} | Dias: ${diasParaEscalonar})\n`;
                                mensagemHtml += `<li><strong>OS ${os['Numero OS']}</strong> - ${os.Cliente || 'N/A'} <em>(Tipo: ${os.Tipo || '‚Äî'} | Pr√≥ximo: ${proximoEscalonamento} | Dias: ${diasParaEscalonar})</em></li>`;
                            });
                            mensagemHtml += `</ul>`;
                        }
                        mensagemText += `\nPor favor, verifique estas OS no sistema.\nAtenciosamente,\nSistema de Controle de OS`;
                        mensagemHtml += `<p>Por favor, verifique estas OS no sistema.</p><p><strong>Atenciosamente,</strong><br>Sistema de Controle de OS</p>`;
                        const osSet1 = osProximasEscalonamento.map(os => String(os['Numero OS']||'').trim()).filter(Boolean);
                        const fp1 = osSet1.slice().sort((a,b)=>a.localeCompare(b)).join(',');
                        const skip1 = await shouldCooldownAnySend({ usuario: alerta.usuario, destinatario: alerta.email, minutes: 60 })
                            || await shouldCooldownUserSend({ tipo: 'alerta_escalonamento_proximo', usuario: alerta.usuario, destinatario: alerta.email, minutes: 60 })
                            || await shouldSkipNotificationByOSSet({ tipo: 'alerta_escalonamento_proximo', usuario: alerta.usuario, destinatario: alerta.email, osNumbers: osSet1, windowMinutes: null })
                            || await shouldSkipNotification({ tipo: 'alerta_escalonamento_proximo', usuario: alerta.usuario, destinatario: alerta.email, titulo, mensagem: mensagemText, windowMinutes: 180 });
                        if (!skip1) {
                            await sleep(500 + Math.floor(Math.random()*2500));
                            const recheck = await shouldCooldownAnySend({ usuario: alerta.usuario, destinatario: alerta.email, minutes: 60 })
                                || await shouldSkipNotificationByOSSet({ tipo: 'alerta_escalonamento_proximo', usuario: alerta.usuario, destinatario: alerta.email, osNumbers: osSet1, windowMinutes: null })
                                || await shouldSkipNotification({ tipo: 'alerta_escalonamento_proximo', usuario: alerta.usuario, destinatario: alerta.email, titulo, mensagem: mensagemText, windowMinutes: 180 });
                            if (recheck) skip1 = true;
                        }
                        const resultadoEnvio = skip1 ? { success: false, error: 'duplicate-skip' } : await enviarEmailReal(alerta.email, titulo, mensagemHtml);
                        const registro1 = {
                            tipo: 'alerta_escalonamento_proximo',
                            titulo,
                            mensagem: `${mensagemText}\nFP[os=${fp1}]`,
                            destinatario: alerta.email,
                            usuario: alerta.usuario,
                            enviado: !!resultadoEnvio.success,
                            erro: resultadoEnvio.error || null,
                            quantidadeOS: osProximasEscalonamento.length
                        };
                        notificacoes.push({ ...registro1, data: new Date().toLocaleString('pt-BR') });
                        await insertHistoricoNotificacaoSupabase(registro1);

                        const titulo2 = `üì£ Voc√™ tem ${osProximasEscalonamento.length} OS prestes a sair do seu usu√°rio`;
                        let mensagem2 = `Prezado(a) ${alerta.usuario},\n\nVoc√™ tem ${osProximasEscalonamento.length} OS prestes a sair do seu usu√°rio conforme as regras de dias.\n`;
                        mensagem2 += `Verifique e execute as a√ß√µes necess√°rias para evitar o escalonamento.\n\nAtenciosamente,\nSistema de Controle de OS`;
                        if (SEND_PRESTES_A_SAIR) {
                            const osSet2 = osProximasEscalonamento.map(os => String(os['Numero OS']||'').trim()).filter(Boolean);
                            const fp2 = osSet2.slice().sort((a,b)=>a.localeCompare(b)).join(',');
                            const skip2 = await shouldCooldownAnySend({ usuario: alerta.usuario, destinatario: alerta.email, minutes: 60 })
                                || await shouldCooldownUserSend({ tipo: 'os_prestes_a_sair', usuario: alerta.usuario, destinatario: alerta.email, minutes: 60 })
                                || await shouldSkipNotificationByOSSet({ tipo: 'os_prestes_a_sair', usuario: alerta.usuario, destinatario: alerta.email, osNumbers: osSet2, windowMinutes: null })
                                || await shouldSkipNotification({ tipo: 'os_prestes_a_sair', usuario: alerta.usuario, destinatario: alerta.email, titulo: titulo2, mensagem: mensagem2, windowMinutes: 180 });
                            if (!skip2) {
                                await sleep(500 + Math.floor(Math.random()*2500));
                                const recheck2 = await shouldCooldownAnySend({ usuario: alerta.usuario, destinatario: alerta.email, minutes: 60 })
                                    || await shouldSkipNotificationByOSSet({ tipo: 'os_prestes_a_sair', usuario: alerta.usuario, destinatario: alerta.email, osNumbers: osSet2, windowMinutes: null })
                                    || await shouldSkipNotification({ tipo: 'os_prestes_a_sair', usuario: alerta.usuario, destinatario: alerta.email, titulo: titulo2, mensagem: mensagem2, windowMinutes: 180 });
                                if (recheck2) skip2 = true;
                            }
                            const resultado2 = skip2 ? { success: false, error: 'duplicate-skip' } : await enviarEmailReal(alerta.email, titulo2, `<p>${mensagem2.replace(/\n/g,'<br>')}</p>`);
                            const registro2 = {
                                tipo: 'os_prestes_a_sair',
                                titulo: titulo2,
                                mensagem: `${mensagem2}\nFP[os=${fp2}]`,
                                destinatario: alerta.email,
                                usuario: alerta.usuario,
                                enviado: !!resultado2.success,
                                erro: resultado2.error || null,
                                quantidadeOS: osProximasEscalonamento.length
                            };
                            notificacoes.push({ ...registro2, data: new Date().toLocaleString('pt-BR') });
                            await insertHistoricoNotificacaoSupabase(registro2);
                        }
                        processed.add(key);
                    }
                }
                
                // Atualiza hist√≥rico na interface
                const historico = await fetchHistoricoNotificacoesSupabase();
                renderHistoricoAlertas(historico);
                
            } catch (error) {
                console.error('Erro ao verificar OS pr√≥ximas de escalonamento:', error);
            }
        }

        /**
         * ALERTA 2: Verifica quando uma OS foi escalonada
         */
        async function verificarOSEscalonadas() {
            try {
                console.log('Verificando OS escalonadas...');
                const { data, error } = await supabase.from(tabelaBase).select('*');
                if (error) throw error;
                
                const alertas = await fetchAlertasConfigSupabase();
                const notificacoes = await fetchHistoricoNotificacoesSupabase();
                const historicoAtual = {};
                const processed = new Set();
                
                // Primeiro, constru√≠mos o estado atual
                data.forEach(os => {
                    const situacao = String(os['Situacao OS'] || '').toLowerCase();
                    if (!situacao.includes('abert')) return; // registra apenas OS abertas
                    const dias = calcularDiasEmAberto(os);
                    const escalonamentoAtual = getEscalonamento(os.Tipo?.toLowerCase() || 'externa', dias, os.Revenda);
                    historicoAtual[os.Chave || os.Cahve] = escalonamentoAtual;
                });
                
                // Verificamos mudan√ßas
                for (const alerta of alertas) {
                    if (!alerta.ativo) continue;
                    if (isExcludedAlertUser(alerta.usuario) || isExcludedAlertUser(alerta.email)) continue;
                    const key = `${alerta.usuario}|${alerta.email}`;
                    if (processed.has(key)) continue;
                    
                    const osEscalonadasParaUsuario = data.filter(os => {
                        const dias = calcularDiasEmAberto(os);
                        const escalonamentoAtual = getEscalonamento(os.Tipo?.toLowerCase() || 'externa', dias, os.Revenda);
                        const escalonamentoAnterior = historicoEscalonamento[os.Chave || os.Cahve];
                        const situacao = String(os['Situacao OS'] || '').toLowerCase();
                        if (!situacao.includes('abert')) return false;
                        const allowedPrevious = getAllowedPrevious(alerta.usuario, os.Tipo?.toLowerCase() || 'externa', os.Revenda, dias);
                        let prevOk = false;
                        if (allowedPrevious) {
                            const anteriorNorm = normalizeNomeResponsavel(escalonamentoAnterior);
                            const allowedNorm = normalizeNomeResponsavel(allowedPrevious);
                            if (anteriorNorm) {
                                prevOk = anteriorNorm === allowedNorm;
                            } else {
                                // sem hist√≥rico anterior: inferir respons√°vel anterior a partir dos dias (dias-1)
                                const prevByDias = getPrevEscalonamentoByDias(os.Tipo?.toLowerCase() || 'externa', dias, os.Revenda);
                                prevOk = normalizeNomeResponsavel(prevByDias) === allowedNorm;
                            }
                        } else {
                            prevOk = normalizeNomeResponsavel(escalonamentoAnterior) !== normalizeNomeResponsavel(alerta.usuario);
                        }
                        return normalizeNomeResponsavel(escalonamentoAtual) === normalizeNomeResponsavel(alerta.usuario) && prevOk;
                    });
                    
                    // Exclui OS j√° notificadas anteriormente para este usu√°rio
                    let osNovasParaUsuario = [];
                    if (osEscalonadasParaUsuario.length > 0) {
                        const prevSet = await getPreviouslyNotifiedOSNumbers({ tipo: 'nova_os_escalonada', usuario: alerta.usuario, destinatario: alerta.email, windowMinutes: null, limit: 500 });
                        osNovasParaUsuario = osEscalonadasParaUsuario.filter(os => {
                            const n = String(os['Numero OS']||'').trim();
                            return n && !prevSet.has(n);
                        });
                    }

                    if (osNovasParaUsuario.length > 0) {
                        const titulo = `üîÑ Nova OS Escalonada para Voc√™`;
                        let mensagemText = `Prezado(a) ${alerta.usuario},\n\n` +
                            `Voc√™ recebeu ${osNovasParaUsuario.length} nova(s) OS escalonada(s):\n\n`;
                        let mensagemHtml = `<p>Prezado(a) ${alerta.usuario},</p><p>Voc√™ recebeu <strong>${osNovasParaUsuario.length}</strong> nova(s) OS escalonada(s):</p><ul>`;
                        osNovasParaUsuario.forEach(os => {
                            const escalonamentoAnterior = historicoEscalonamento[os.Chave || os.Cahve] || 'N/A';
                            const diasAberto = calcularDiasEmAberto(os);
                            mensagemText += `‚Ä¢ OS ${os['Numero OS']} - ${os.Cliente || 'N/A'} (Tipo: ${os.Tipo || '‚Äî'})\n  Respons√°vel anterior: ${escalonamentoAnterior}\n  Dias em aberto: ${diasAberto} dias\n\n`;
                            mensagemHtml += `<li><strong>OS ${os['Numero OS']}</strong> - ${os.Cliente || 'N/A'} <em>(Tipo: ${os.Tipo || '‚Äî'})</em><br><small>Respons√°vel anterior: ${escalonamentoAnterior} ‚Ä¢ Dias em aberto: ${diasAberto} dias</small></li>`;
                        });
                        mensagemHtml += `</ul>`;
                        mensagemText += `Por favor, assuma a responsabilidade por estas OS.\nAtenciosamente,\nSistema de Controle de OS`;
                        mensagemHtml += `<p>Por favor, assuma a responsabilidade por estas OS.</p><p><strong>Atenciosamente,</strong><br>Sistema de Controle de OS</p>`;
                        const osSet3 = osNovasParaUsuario.map(os => String(os['Numero OS']||'').trim()).filter(Boolean);
                        const fp3 = osSet3.slice().sort((a,b)=>a.localeCompare(b)).join(',');
                        let skip = await isUserSendLocked({ tipo: 'nova_os_escalonada', usuario: alerta.usuario, windowMinutes: 1 })
                            || await shouldSkipNotificationByOSSet({ tipo: 'nova_os_escalonada', usuario: alerta.usuario, destinatario: alerta.email, osNumbers: osSet3, windowMinutes: null })
                            || await shouldSkipNotification({ tipo: 'nova_os_escalonada', usuario: alerta.usuario, destinatario: alerta.email, titulo, mensagem: mensagemText, windowMinutes: 180 });
                        if (!skip) {
                            setUserSendLock({ tipo: 'nova_os_escalonada', usuario: alerta.usuario });
                            await sleep(500 + Math.floor(Math.random()*2500));
                            const recheck3 = await shouldSkipNotificationByOSSet({ tipo: 'nova_os_escalonada', usuario: alerta.usuario, destinatario: alerta.email, osNumbers: osSet3, windowMinutes: null })
                                || await shouldSkipNotification({ tipo: 'nova_os_escalonada', usuario: alerta.usuario, destinatario: alerta.email, titulo, mensagem: mensagemText, windowMinutes: 180 });
                            if (recheck3) skip = true;
                        }
                        const resultadoEnvio = skip ? { success: false, error: 'duplicate-skip' } : await enviarEmailReal(alerta.email, titulo, mensagemHtml);
                        const registro = {
                            tipo: 'nova_os_escalonada',
                            titulo,
                            mensagem: `${mensagemText}\nFP[os=${fp3}]`,
                            destinatario: alerta.email,
                            usuario: alerta.usuario,
                            enviado: !!resultadoEnvio.success,
                            erro: resultadoEnvio.error || null,
                            quantidadeOS: osNovasParaUsuario.length
                        };
                        notificacoes.push({ ...registro, data: new Date().toLocaleString('pt-BR') });
                        await insertHistoricoNotificacaoSupabase(registro);
                        processed.add(key);
                    }
                }
                
                // Atualiza o hist√≥rico para a pr√≥xima verifica√ß√£o
                historicoEscalonamento = historicoAtual;
                localStorage.setItem('historicoEscalonamento', JSON.stringify(historicoEscalonamento));
                const historico2 = await fetchHistoricoNotificacoesSupabase();
                renderHistoricoAlertas(historico2);
                
            } catch (error) {
                console.error('Erro ao verificar OS escalonadas:', error);
            }
        }

        /**
         * Fun√ß√£o principal que verifica ambos os tipos de alerta
         */
        async function verificarTodosOsAlertas(force = false) {
            console.log('=== INICIANDO VERIFICA√á√ÉO DE ALERTAS ===');
            try {
                if (!force) {
                    const lastRunRaw = localStorage.getItem('lastAlertRun');
                    const lastRun = lastRunRaw ? parseInt(lastRunRaw, 10) : 0;
                    if (lastRun && (Date.now() - lastRun) < (5 * 60 * 1000)) {
                        console.log('Skip verifica√ß√£o: rodou h√° menos de 5 minutos');
                        return;
                    }
                }
                localStorage.setItem('lastAlertRun', String(Date.now()));
            } catch(_) {}
            await verificarAlertasUnificados();
            console.log('=== VERIFICA√á√ÉO CONCLU√çDA ===');
        }

        let alertScheduleTimer = null;
        let lastAlertScheduleAt = 0;
        function scheduleAlertCheckSoon(reason) {
            try {
                const now = Date.now();
                if ((now - lastAlertScheduleAt) < 30000) return; // m√≠nimo 30s entre agendamentos
                lastAlertScheduleAt = now;
                if (alertScheduleTimer) { clearTimeout(alertScheduleTimer); }
                alertScheduleTimer = setTimeout(() => {
                    alertScheduleTimer = null;
                    verificarTodosOsAlertas(true);
                }, 5000);
            } catch(_) {}
        }

        async function initRealtimeAlertsSubscription() {
            try {
                const ch = supabase.channel('rt-os-alerts')
                    .on('postgres_changes', { event: '*', schema: 'public', table: tabelaBase }, payload => {
                        scheduleAlertCheckSoon('os-change');
                    })
                    .subscribe();
            } catch(e) { console.warn('Falha ao iniciar realtime:', e); }
        }

        /**
         * Obt√©m o limite de dias para um determinado escalonamento
         */
        function getLimiteEscalonamento(tipo, escalonamento) {
            const name = normalizeNomeResponsavel(escalonamento);
            const n = (s) => normalizeNomeResponsavel(s);
            if (tipo === 'garantia') {
                if (name === n('Fl√°via') || name === n('Giovana')) return 25;
                if (name === n('Wanderley')) return 35;
                if (name === n('Graziela')) return 50;
                if (name === n('Johnny')) return 90;
                if (name === n('Ant√¥nio Gustavo') || name === n('Antonio Gustavo')) return 91; // Acima de 90 dias
                return 0;
            } else {
                if (name === n('Isabelle') || name === n('Ana Leya') || name === n('Bruna')) return 10;
                if (name === n('Wanderley')) return 15;
                if (name === n('Graziela')) return 20;
                if (name === n('Johnny')) return 30;
                if (name === n('Ant√¥nio Gustavo') || name === n('Antonio Gustavo')) return 31; // Acima de 30 dias
                return 0;
            }
        }

        /**
         * Obt√©m o pr√≥ximo escalonamento baseado nos dias
         */
        function getProximoEscalonamento(tipo, dias, revenda) {
            const revendaNum = revenda ? revenda.toString() : '';
            if (tipo === 'garantia') {
                if (dias <= 25) {
                    if (['1', '4'].includes(revendaNum)) return 'Fl√°via';
                    if (['2', '3'].includes(revendaNum)) return 'Giovana';
                    return 'Fl√°via';
                }
                if (dias <= 35 && revendaNum === '3') return 'Wanderley';
                if (dias <= 50) return 'Graziela';
                if (dias <= 90) return 'Johnny';
                return 'Ant√¥nio Gustavo';
            } else {
                if (dias <= 10) {
                    // Externa/Inerna primeira linha por revenda
                    if (revendaNum === '3') return 'Ana Leya';
                    if (['1', '2', '4'].includes(revendaNum)) return tipo === 'interna' ? 'Bruna' : 'Isabelle';
                    return 'Isabelle';
                }
                if (dias <= 15 && revendaNum === '3') return 'Wanderley';
                if (dias <= 20) return 'Graziela';
                if (dias <= 30) return 'Johnny';
                return 'Ant√¥nio Gustavo';
            }
        }

        // --- FUN√á√ïES DE ORDENA√á√ÉO ---

        let sortState = {
            externa: { column: null, direction: 'asc' },
            interna: { column: null, direction: 'asc' },
            garantia: { column: null, direction: 'asc' }
        };

        function sortTable(tab, column) {
            const currentSort = sortState[tab];
            
            // Se clicar na mesma coluna, alterna a dire√ß√£o
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                // Se clicar em coluna diferente, define como ascendente
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            // Remove classes de ordena√ß√£o de todos os cabe√ßalhos
            document.querySelectorAll(`#table-${tab} th`).forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            // Adiciona classe ao cabe√ßalho atual
            const currentTh = document.querySelector(`#table-${tab} th[data-column="${column}"]`);
            if (currentTh) {
                currentTh.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
            }
            
            // Aplica a ordena√ß√£o
            applySorting(tab);
        }

        async function applySorting(tab) {
            const data = osData[tab] || [];
            const filteredData = applyFilters(tab, data);
            const currentSort = sortState[tab];
            
            if (!currentSort.column) {
                await renderTableRows(tab, filteredData);
                return;
            }
            
            const sortedData = [...filteredData].sort((a, b) => {
                let valueA, valueB;
                
                // Ordena√ß√£o especial para colunas espec√≠ficas
                if (currentSort.column === 'dias-aberto') {
                    // Ordena√ß√£o para Dias em Aberto
                    valueA = calcularDiasEmAberto(a);
                    valueB = calcularDiasEmAberto(b);
                } else if (currentSort.column === 'emissao') {
                    // Ordena√ß√£o para datas de emiss√£o
                    valueA = new Date(a.Emissao || '2000-01-01');
                    valueB = new Date(b.Emissao || '2000-01-01');
                } else if (currentSort.column === 'dias') {
                    // Ordena√ß√£o para dias totais
                    valueA = calculateDaysRobust(a.Emissao);
                    valueB = calculateDaysRobust(b.Emissao);
                } else if (currentSort.column === 'total-pecas') {
                    valueA = parseFloat(a['Total Pecas'] || 0);
                    valueB = parseFloat(b['Total Pecas'] || 0);
                } else if (currentSort.column === 'total-servico') {
                    valueA = parseFloat(a['Total Servico'] || 0);
                    valueB = parseFloat(b['Total Servico'] || 0);
                } else if (currentSort.column === 'total-os') {
                    valueA = parseFloat(a['Total OS'] || 0);
                    valueB = parseFloat(b['Total OS'] || 0);
                } else {
                    // Ordena√ß√£o gen√©rica para outras colunas
                    valueA = a[currentSort.column];
                    valueB = b[currentSort.column];
                    
                    // Tenta converter para n√∫mero
                    const numA = parseFloat(valueA);
                    const numB = parseFloat(valueB);
                    
                    // Se ambos s√£o n√∫meros v√°lidos, compara como n√∫meros
                    if (!isNaN(numA) && !isNaN(numB)) {
                        valueA = numA;
                        valueB = numB;
                    } else {
                        // Se n√£o s√£o n√∫meros, converte para string para compara√ß√£o
                        valueA = String(valueA || '').toLowerCase();
                        valueB = String(valueB || '').toLowerCase();
                    }
                }
                
                // Aplica a ordena√ß√£o baseada na dire√ß√£o
                if (currentSort.direction === 'asc') {
                    return valueA < valueB ? -1 : valueA > valueB ? 1 : 0;
                } else {
                    return valueA > valueB ? -1 : valueA < valueB ? 1 : 0;
                }
            });
            
            await renderTableRows(tab, sortedData);
        }

        function getTextColorForBackground(hexColor) {
            if (!hexColor || hexColor.length < 4) return '#333333';
            let hex = hexColor.substring(1); // remove #
            if (hex.length === 3) {
                hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
            }
            const r = parseInt(hex.substring(0, 2), 16);
            const g = parseInt(hex.substring(2, 4), 16);
            const b = parseInt(hex.substring(4, 6), 16);
            const brightness = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            return (brightness > 125) ? '#333333' : '#FFFFFF';
        }

        async function renderTableRows(tab, data) {
            const tbody = document.getElementById(`tbody-${tab}`);
            const countEl = document.getElementById(`count-${tab}`);
            
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="15" style="text-align: center; padding: 20px;">Nenhuma OS encontrada</td></tr>`;
                countEl.textContent = '0 OS encontradas';
                return;
            }
            
            // Primeiro obtemos todas as cores dos status
            const statusColors = {};
            for (const os of data) {
                const status = extrairStatusDaObservacao(os.Observacao);
                if (status && !statusColors[status]) {
                    statusColors[status] = await getStatusColor(status);
                }
            }
            
            tbody.innerHTML = data.map(os => {
                // C√°lculo total de dias (sempre ativo para a coluna 'Dias')
                const diasTotais = calculateDaysRobust(os.Emissao);
                
                // L√≥gica espec√≠fica para 'Dias em Aberto' usando a fun√ß√£o especializada
                const diasEmAberto = calcularDiasEmAberto(os);
                const diasEmAbertoSafe = (Number.isFinite(diasEmAberto) && diasEmAberto >= 0) ? diasEmAberto : 0;
                
                // Determina o conte√∫do da coluna Status
                const status = extrairStatusDaObservacao(os.Observacao);
                const observacaoReal = extrairObservacaoSemStatus(os.Observacao);
                
                // Obt√©m a cor do status e a cor do texto correspondente
                const statusColor = statusColors[status] || '';
                const textColor = getTextColorForBackground(statusColor);
                const statusStyle = statusColor ? `style="background-color: ${statusColor}; color: ${textColor};"` : '';
                // Usa data-* com encodeURIComponent para evitar quebra por aspas na Observa√ß√£o/Ac√£o
                const statusContent = `<span class="status-os-badge open-individual" ${statusStyle}
                    data-os-id="${os.Chave || os.Cahve}"
                    data-nro-os="${encodeURIComponent(os['Numero OS'] || '')}"
                    data-situacao="${encodeURIComponent(os['Situacao OS'] || 'Aberta')}"
                    data-observacao="${encodeURIComponent(observacaoReal || '')}"
                    data-acao="${encodeURIComponent(os['Acao / Atualizacao'] || '')}"
                    data-status="${encodeURIComponent(status || '')}"
                >${status}</span>`;
                
                const fmt = (v) => {
                    const n = parseFloat(v || 0);
                    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(isNaN(n) ? 0 : n);
                };
                return `
                    <tr>
                        <td>${revendasMap[os.Revenda] || os.Revenda}</td>
                        <td><strong>${os['Numero OS'] || '-'}</strong></td>
                        <td><span class="status-badge ${os['Situacao OS'] === 'Aberta' ? 'status-aberta' : 'status-fechada'}">${os['Situacao OS']}</span></td>
                        <td>${os.Tipo || '-'}</td>
                        <td>${formatDate(os.Emissao)}</td>
                        <td><span class="dias-badge ${getDiasClass(tab, diasTotais)}">${diasTotais}</span></td>
                        <td><span class="dias-badge ${getDiasClass(tab, diasEmAbertoSafe)}">${diasEmAbertoSafe}</span></td>
                        <td class="col-status">${statusContent}</td>
                        <td>${os.Cliente || '-'}</td>
                        <td>${os.Chassi || '-'}</td>
                        <td>${os.Consultor || '-'}</td>
                        <td>${fmt(os['Total Pecas'])}</td>
                        <td>${fmt(os['Total Servico'])}</td>
                        <td>${fmt(os['Total OS'])}</td>
                        <td><div class="observacao-text" title="${observacaoReal || ''}">${observacaoReal || ''}</div></td>
                        <td><div class="acao-atualizacao-text" title="${os['Acao / Atualizacao'] || ''}">${os['Acao / Atualizacao'] || ''}</div></td>
                        <td><span class="escalonamento-badge">${getEscalonamento(tab, diasEmAberto, os.Revenda)}</span></td>
                        <td><button class="btn btn-primary btn-sm open-individual"
                            data-os-id="${os.Chave || os.Cahve}"
                            data-nro-os="${encodeURIComponent(os['Numero OS'] || '')}"
                            data-situacao="${encodeURIComponent(os['Situacao OS'] || 'Aberta')}"
                            data-observacao="${encodeURIComponent(observacaoReal || '')}"
                            data-acao="${encodeURIComponent(os['Acao / Atualizacao'] || '')}"
                            data-status="${encodeURIComponent(status || '')}"
                            data-revenda="${encodeURIComponent(os.Revenda || '')}"
                            data-tipo="${encodeURIComponent(os.Tipo || '')}"
                        >Editar</button></td>
                    </tr>
                `;
            }).join('');
            
            countEl.textContent = `${data.length} OS encontradas`;
            const totalGeralEl = document.getElementById(`total-geral-${tab}`);
            if (totalGeralEl) {
                totalGeralEl.textContent = `Total Geral de OS: ${data.length}`;
            }
            
            document.querySelectorAll('.observacao-text, .acao-atualizacao-text').forEach(el => {
                el.addEventListener('click', e => { e.stopPropagation(); el.classList.toggle('expanded'); });
            });

            // Liga eventos para abrir modal de atualiza√ß√£o sem usar onclick inline
            tbody.querySelectorAll('.open-individual').forEach(el => {
                el.addEventListener('click', () => {
                    const osId = el.dataset.osId;
                    const nroOs = decodeURIComponent(el.dataset.nroOs || '');
                    const situacao = decodeURIComponent(el.dataset.situacao || 'Aberta');
                    const observacao = decodeURIComponent(el.dataset.observacao || '');
                    const acao = decodeURIComponent(el.dataset.acao || '');
                    const status = decodeURIComponent(el.dataset.status || 'Sem Status');
                    const revenda = decodeURIComponent(el.dataset.revenda || '');
                    const tipo = decodeURIComponent(el.dataset.tipo || '');
                    openIndividualModal(osId, nroOs, situacao, observacao, acao, status, revenda, tipo);
                });
            });

            // Garante que a visibilidade seja aplicada ap√≥s a renderiza√ß√£o
            setTimeout(applyColumnVisibility, 0);

            // Renderiza cards de alerta para o usu√°rio na aba atual
            try { await renderAlertCardsForTab(tab); } catch(e) { console.warn('Falha ao renderizar cards de alerta:', e); }
        }

        // --- Cards de alerta (Garantia): OS com transfer√™ncia iminente (<= 5 dias)
        // Helper para derivar o respons√°vel atual a partir do usu√°rio logado
        function getResponsavelAtualFromUser(user) {
            const userNome = ((user?.nome_completo || user?.usuario || '')).toLowerCase();
            if (userNome.includes('fl√°via') || userNome.includes('flavia')) return 'Fl√°via';
            if (userNome.includes('giovana')) return 'Giovana';
            if (userNome.includes('wanderley')) return 'Wanderley';
            if (userNome.includes('graziela')) return 'Graziela';
            if (userNome.includes('johnny')) return 'Johnny';
            if (userNome.includes('ana leya') || userNome.includes('ana leia')) return 'Ana Leya';
            if (userNome.includes('isabelle')) return 'Isabelle';
            if (userNome.includes('bruna')) return 'Bruna';
            return '';
        }

        // Limite em dias por respons√°vel e tipo (usado para alerta de 5 dias)
        function getEscalonamentoLimit(tipo, responsavel, revenda) {
            const rev = (revenda || '').toString();
            if (tipo === 'garantia') {
                if (responsavel === 'Fl√°via' || responsavel === 'Giovana') return 25;
                if (responsavel === 'Wanderley') return rev === '3' ? 35 : 35; // aplic√°vel apenas revenda 3
                if (responsavel === 'Graziela') return 50;
                if (responsavel === 'Johnny') return 90;
                if (responsavel === 'Ant√¥nio Gustavo') return 91;
                return 0;
            } else {
                if (responsavel === 'Isabelle' || responsavel === 'Ana Leya' || responsavel === 'Bruna') return 10;
                if (responsavel === 'Wanderley') return 15; // s√≥ ocorre na revenda 3 em interna/externa conforme getEscalonamento
                if (responsavel === 'Graziela') return 20;
                if (responsavel === 'Johnny') return 30;
                if (responsavel === 'Ant√¥nio Gustavo') return 31;
                return 0;
            }
        }

        async function renderGarantiaAlertCards(data) {
            const container = document.getElementById('garantia-alert-cards');
            if (!container) return;
            
            // Obt√©m informa√ß√µes do usu√°rio atual
            const currentUser = window.NormaQCurrentUser || (JSON.parse(localStorage.getItem('authUser')) || null);
            const userNome = (currentUser?.nome_completo || currentUser?.usuario || '').toLowerCase();
            
            // Se n√£o for um usu√°rio espec√≠fico ou for administrador, n√£o mostra cards
            const isGraziela = userNome.includes('graziela');
            const isJohnny = userNome.includes('johnny');
            const isWanderley = userNome.includes('wanderley');
            if (!currentUser || currentUser.is_admin || currentUser.tipo_usuario === 'Administrador' || 
                (currentUser.tipo_usuario === 'Gestor' && !isGraziela && !isJohnny && !isWanderley) || userNome.includes('ant√¥nio gustavo') || 
                userNome.includes('antonio gustavo') || userNome.includes('thiago carmo') || userNome.includes('thiago.carmo')) {
                container.innerHTML = '';
                return;
            }
            
            // Determina o respons√°vel atual baseado no nome do usu√°rio
            const responsavelAtual = getResponsavelAtualFromUser(currentUser);
            
            // Se n√£o identificou um respons√°vel espec√≠fico, n√£o mostra cards
            if (!responsavelAtual) {
                container.innerHTML = '';
                return;
            }
            // Usa contagem espec√≠fica da aba Garantia e apenas OS Abertas
            const imminents = await computeImminentTransfersForUserByTab(currentUser, 'garantia');
            const qtd = imminents.length;
            
            const hasAlert = qtd > 0;
            const bg = hasAlert ? '#fff8e1' : '#f5f5f5';
            const border = hasAlert ? '#ffc107' : '#ddd';
            const icon = hasAlert ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            const msg = hasAlert
                ? `Voc√™ tem ${qtd} OS com transfer√™ncia em at√© 5 dias.`
                : 'Nenhuma OS com transfer√™ncia iminente.';
                
            container.innerHTML = `
                <div class="user-alert-card" style="background:${bg}; border:1px solid ${border}; border-radius:8px; padding:12px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                        <strong>${responsavelAtual}</strong>
                        <span>${icon}</span>
                    </div>
                    <div style="color:#555;">${msg}</div>
                </div>
            `;
        }

        // Cards de alerta por aba (Externa/Interna/Garantia) com a mesma l√≥gica
        async function renderAlertCardsForTab(tab) {
            const container = document.getElementById(`${tab}-alert-cards`);
            if (!container) return;
            const user = getCurrentUserInfo();
            const nomeLower = (user && (user.nome_completo || user.usuario) || '').toLowerCase();
            const isGraziela = nomeLower.includes('graziela');
            const isJohnny = nomeLower.includes('johnny');
            const isWanderley = nomeLower.includes('wanderley');
            if (!user || user.is_admin || user.tipo_usuario === 'Administrador' || (user.tipo_usuario === 'Gestor' && !isGraziela && !isJohnny && !isWanderley)) {
                container.innerHTML = '';
                return;
            }
            
            if (nomeLower.includes('ant√¥nio gustavo') || nomeLower.includes('antonio gustavo') || nomeLower.includes('thiago carmo') || nomeLower.includes('thiago.carmo')) {
                container.innerHTML = '';
                return;
            }
            const responsavelAtual = getResponsavelAtualFromUser(user);
            if (!responsavelAtual) {
                container.innerHTML = '';
                return;
            }
            // Usa contagem apenas da aba atual, para refletir a tabela mostrada
            const imminents = await computeImminentTransfersForUserByTab(user, tab);
            const hasAlert = imminents.length > 0;
            const bg = hasAlert ? '#fff8e1' : '#f5f5f5';
            const border = hasAlert ? '#ffc107' : '#ddd';
            const icon = hasAlert ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            const msg = hasAlert
                ? `Voc√™ tem ${imminents.length} OS com transfer√™ncia em at√© 5 dias.`
                : 'Nenhuma OS com transfer√™ncia iminente.';

            container.innerHTML = `
                <div style="background:${bg}; border:1px solid ${border}; border-radius:8px; padding:12px; display:flex; align-items:center; gap:8px;">
                    <div style="font-size:18px;">${icon}</div>
                    <div style="flex:1;">${msg}</div>
                    ${hasAlert ? `<button id="btn-lista-${tab}-imminents" class="btn btn-sm" style="background:#ffc107; color:#000; border:none; padding:6px 10px; border-radius:4px; cursor:pointer;">Ver OS</button>` : ''}
                </div>
            `;

            if (hasAlert) {
                const btn = document.getElementById(`btn-lista-${tab}-imminents`);
                if (btn) {
                    btn.addEventListener('click', () => {
                        try {
                            const numeros = imminents.map(os => os['Numero OS'] || '').filter(Boolean);
                            mostrarModalListaOS(numeros);
                        } catch(_) {}
                    });
                }
            }
        }

        function renderTransferenciaTableRows(tab, data) {
            const tbody = document.getElementById(`tbody-transferencia-${tab}`);
            
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 20px;">Nenhuma OS encontrada para transfer√™ncia</td></tr>`;
                return;
            }
            
            tbody.innerHTML = data.map(os => {
                const diasEmAberto = calcularDiasEmAberto(os);
                const status = extrairStatusDaObservacao(os.Observacao);

                return `
                    <tr class="row-animate">
                        <td><input type="checkbox" class="transfer-checkbox-${tab}" value="${os.Chave || os.Cahve}"></td>
                        <td>${revendasMap[os.Revenda] || os.Revenda}</td>
                        <td><strong>${os['Numero OS'] || '-'}</strong></td>
                        <td><span class="status-badge ${os['Situacao OS'] === 'Aberta' ? 'status-aberta' : 'status-fechada'}">${os['Situacao OS']}</span></td>
                        <td>${formatDate(os.Emissao)}</td>
                        <td><span class="dias-badge ${getDiasClass(tab, diasEmAberto)}">${diasEmAberto}</span></td>
                        <td><span class="status-os-badge ${getStatusClass(status)}">${status}</span></td>
                        <td><span class="escalonamento-badge">${getEscalonamento(tab, diasEmAberto, os.Revenda)}</span></td>
                    </tr>
                `;
            }).join('');
        }

        async function ensureTransferDataLoaded() {
            // Carrega dados de todas as abas necess√°rias para Transfer√™ncia, caso ainda n√£o existam
            const tipos = { externa: 'Externa', interna: 'Interna', garantia: 'Garantia' };
            for (const tab of Object.keys(tipos)) {
                if (!Array.isArray(osData[tab]) || osData[tab].length === 0) {
                    try {
                        const { data, error } = await supabase.from(tabelaBase).select('*').eq('Tipo', tipos[tab]);
                        if (error) throw error;
                        osData[tab] = data || [];
                    } catch (err) {
                        console.error(`Falha ao carregar dados para ${tab}:`, err.message);
                        osData[tab] = osData[tab] || [];
                    }
                }
            }
        }

        function getTransferFilters(tab) {
            const revendaEl = document.getElementById(`transfer-filter-revenda-${tab}`);
            const statusEl = document.getElementById(`transfer-filter-status-${tab}`);
            return {
                revenda: revendaEl ? revendaEl.value : '',
                situacao: statusEl ? statusEl.value : 'Aberta'
            };
        }

        function applyTransferFilters(tab, data) {
            const { revenda, situacao } = getTransferFilters(tab);
            return data.filter(os => {
                const okRevenda = !revenda || revenda === 'Todos' || (os.Revenda && os.Revenda.toString() === revenda);
                const okSituacao = !situacao || situacao === 'Todos' || ((os['Situacao OS'] || '') === situacao);
                return okRevenda && okSituacao;
            });
        }

        async function populateTransferenciaTables() {
            await ensureTransferDataLoaded();
            // Garante que os filtros de Situa√ß√£o OS tenham op√ß√µes corretas
            resetTransferSituacaoFilters();

            let externaData = (osData.externa || []).filter(os => {
                const sit = ((os['Situacao OS'] || '') + '').toLowerCase();
                if (!sit.includes('abert')) return false; // exclui fechadas da transfer√™ncia
                const esc = getEscalonamento('externa', calcularDiasEmAberto(os), os.Revenda);
                return MANAGERS.includes(esc);
            });
            let internaData = (osData.interna || []).filter(os => {
                const sit = ((os['Situacao OS'] || '') + '').toLowerCase();
                if (!sit.includes('abert')) return false; // exclui fechadas da transfer√™ncia
                const esc = getEscalonamento('interna', calcularDiasEmAberto(os), os.Revenda);
                return MANAGERS.includes(esc);
            });
            let garantiaData = (osData.garantia || []).filter(os => {
                const sit = ((os['Situacao OS'] || '') + '').toLowerCase();
                if (!sit.includes('abert')) return false; // exclui fechadas da transfer√™ncia
                const esc = getEscalonamento('garantia', calcularDiasEmAberto(os), os.Revenda);
                return MANAGERS.includes(esc);
            });

            // Aplica filtros de Revenda e Situa√ß√£o para cada subtab
            externaData = applyTransferFilters('externa', externaData);
            internaData = applyTransferFilters('interna', internaData);
            garantiaData = applyTransferFilters('garantia', garantiaData);

            renderTransferenciaTableRows('externa', externaData);
            renderTransferenciaTableRows('interna', internaData);
            renderTransferenciaTableRows('garantia', garantiaData);
        }

        function transferirEscalonamento(tab) {
            const select = document.getElementById(`transfer-to-${tab}`);
            const targetPerson = select.value;
            const checkboxes = document.querySelectorAll(`.transfer-checkbox-${tab}:checked`);
            
            if (checkboxes.length === 0) {
                alert('Selecione pelo menos uma OS para transferir.');
                return;
            }

            const osKeysToTransfer = Array.from(checkboxes).map(cb => cb.value);

            osKeysToTransfer.forEach(key => {
                let os = findOSByKey(key);
                if (os) {
                    const originalEscalonamento = getEscalonamento(tab, calcularDiasEmAberto(os), os.Revenda);
                    os.Observacao = `(Transferido de ${originalEscalonamento} para ${targetPerson}) ${os.Observacao}`;
                }
            });

            saveOSData();
            // Atualiza as tabelas e a UI
            populateTransferenciaTables();
            filterAndDisplayData(tab);

            alert(`${osKeysToTransfer.length} OS(s) transferida(s) para ${targetPerson}.`);
        }

        function findOSByKey(key) {
            for (const type in osData) {
                const os = osData[type].find(os => (os.Chave || os.Cahve) === key);
                if (os) return os;
            }
            return null;
        }

        // --- INICIALIZA√á√ÉO ---
        document.addEventListener('DOMContentLoaded', async () => {
            initializeTabs();
            setupEventListeners();
            applyUserAccessControl();
            // Log de visita √† p√°gina (proatividade)
            try { await logPageVisit(); } catch(e) { console.warn('Falha ao registrar visita:', e); }
            try { await startUserSession(); } catch(e) {}
            try {
                const user = getCurrentUserInfo();
                const isAdmin = user && (String(user.usuario||'').toLowerCase() === 'thiago.carmo' || (String(user.tipo_usuario||'').toLowerCase() === 'administrador') || user.is_admin);
                if (isAdmin) { await initRealtimeAlertsSubscription(); }
            } catch(_) {}
            try {
                const supaAlertas = await fetchAlertasConfigSupabase();
                if (Array.isArray(supaAlertas) && supaAlertas.length > 0) {
                    localStorage.removeItem('alertasConfig');
                }
            } catch(_) {}
            checkPrimeiroLoginThenShowModal();
            loadOSData();
            try { await showUserEventNotificationsIfAny(); } catch(_) {}
            // Atualiza selects de status globais (inclui batch-status) com dados do Supabase
            try { await updateStatusSelects(); } catch(e) { console.warn('Falha ao atualizar selects de status:', e); }
            
            // Inicializa e atualiza data/hora
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // NOVO: Inicializa indicadores sem marcar atualiza√ß√£o
            const dashEl = document.getElementById('last-update-time');
            if (dashEl && !dashEl.textContent) dashEl.textContent = '‚Äî';
            // Preenche indicadores com √∫ltima atualiza√ß√£o persistida, se houver
            if (lastUpdateTime) {
                try {
                    setDashboardUpdateIndicator(lastUpdateTime);
                    setSuccessUpdateIndicator(lastUpdateTime);
                } catch(_) {}
            }
            try { await loadManualUpdateTimestamp(); } catch(_) {}
            try {
                const input = document.getElementById('manual-update-input');
                const d = lastUpdateTime || (function(){
                    const raw = localStorage.getItem(LAST_UPDATE_TIME_KEY);
                    return raw ? new Date(raw) : null;
                })();
                if (input && d instanceof Date && !isNaN(d)) {
                    const local = new Date(d.getTime() - d.getTimezoneOffset() * 60000);
                    input.value = local.toISOString().slice(0,16);
                }
            } catch(_) {}
            
            // Carrega hist√≥rico de escalonamento
            historicoEscalonamento = JSON.parse(localStorage.getItem('historicoEscalonamento')) || {};
            
            // Inicializa o controle de colunas
            initializeColumnVisibility();
            
            // Inicializa os controles de colunas com menu
            initializeColumnControls();
            
            // Verifica alertas a cada 30 minutos
            setInterval(verificarTodosOsAlertas, 30 * 60 * 1000);
            
            // Verifica alertas imediatamente ao carregar (com delay)
            setTimeout(verificarTodosOsAlertas, 15000);
        });

        window.addEventListener('beforeunload', function() {
            try { endUserSession(); } catch(_) {}
        });

        function initializeTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                // Adiciona ID para a tab de alerta para facilitar o controle
                if (tab.getAttribute('data-tab') === 'alerta') {
                    tab.id = 'alerta-tab';
                } else if (tab.getAttribute('data-tab') === 'externa') {
                    tab.id = 'externa-tab';
                }

                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');

                    // Verifica se √© a aba de alertas e libera acesso autom√°tico para perfis autorizados
                    if (tabId === 'alerta' && !acessoAlertasLiberado) {
                        const u = getCurrentUserInfo();
                        const nome = (u?.nome_completo || u?.usuario || '').toLowerCase();
                        const allowed = ['johnny','graziela','ant√¥nio gustavo','antonio gustavo','wanderley','thiago.carmo','thiago carmo'];
                        const isAllowed = allowed.some(a => nome.includes(a)) || (u?.is_admin === true) || ((u?.tipo_usuario || '').toLowerCase() === 'administrador');
                        if (isAllowed) {
                            acessoAlertasLiberado = true;
                        } else {
                            abrirModalSenha();
                            return;
                        }
                    }

                    // Tabs internas da se√ß√£o de Transfer√™ncia (n√£o alteram currentTab)
                    const isTransferSubTab = tabId && tabId.startsWith('transferencia-') && this.closest('#transferencia-escalonamento');
                    if (isTransferSubTab && tabId !== 'transferencia-escalonamento') {
                        const container = this.closest('.tabs-container');
                        const activeTab = container.querySelector('.tab.active');
                        const activeContent = container.querySelector('.tab-content.active');
                        if (activeTab) activeTab.classList.remove('active');
                        if (activeContent) activeContent.classList.remove('active');
                        this.classList.add('active');
                        const target = container.querySelector(`#${tabId}`);
                        if (target) target.classList.add('active');
                        // N√£o altera currentTab nem carrega dados
                        return;
                    }

                    // Tabs principais
                    const activeGlobalTab = document.querySelector('.tab.active');
                    const activeGlobalContent = document.querySelector('.tab-content.active');
                    if (activeGlobalTab) activeGlobalTab.classList.remove('active');
                    if (activeGlobalContent) activeGlobalContent.classList.remove('active');
                    this.classList.add('active');
                    const targetGlobal = document.getElementById(tabId);
                    if (targetGlobal) targetGlobal.classList.add('active');
                    currentTab = tabId;

                    // Loga visita √† aba selecionada
                    try { logPageVisit(currentTab); } catch(e) { /* noop */ }

                    if (tabId === 'transferencia-escalonamento') {
                        populateTransferenciaTables();
                    }

                    if (currentTab === 'dashboard') {
                        loadDashboardData();
                    } else if (currentTab === 'alerta') {
                        loadAlertas();
                    } else if (currentTab === 'gerenciar-status') {
                        initializeStatusManagement();
                    } else if (currentTab === 'cadastro-usuarios') {
                        loadUsuariosList();
                    } else if (currentTab === 'logs-status') {
                        initializeLogsTab();
                    } else if (currentTab !== 'atualizacao' && currentTab !== 'transferencia-escalonamento' && currentTab !== 'atualizar-valores') {
                        loadOSData();
                    }
                });
            });
        }
        
        // Fun√ß√£o debounce para otimizar performance
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function setupEventListeners() {
            document.getElementById('password-form').addEventListener('submit', function(e) {
                e.preventDefault();
                verificarSenha();
            });

            // Debounce para otimizar performance dos filtros
            const debouncedApplySorting = debounce(() => {
                if (currentTab !== 'dashboard') {
                    applySorting(currentTab);
                    updateTotals(currentTab);
                }
            }, 300);

            document.querySelectorAll('.filter-select, .filter-input').forEach(el => {
                const event = el.matches('select') ? 'change' : 'input';
                el.addEventListener(event, debouncedApplySorting);
            });
            
            const modal = document.getElementById('update-modal');
            document.querySelectorAll('.close-modal').forEach(btn => btn.addEventListener('click', () => modal.style.display = 'none'));
            document.getElementById('update-form').addEventListener('submit', e => { e.preventDefault(); updateOS(); });
            document.getElementById('btn-carregar-os').addEventListener('click', loadBatchOS);
            const btnLista = document.getElementById('btn-carregar-os-lista');
            if (btnLista) btnLista.addEventListener('click', loadBatchOSByNumbers);
            document.getElementById('btn-fechar-os').addEventListener('click', closeSelectedOS);
            document.getElementById('btn-atualizar-status').addEventListener('click', updateSelectedStatus);
            document.getElementById('btn-limpar-selecao').addEventListener('click', clearSelection);
            document.getElementById('select-all-os').addEventListener('change', toggleSelectAll);
            document.getElementById('btn-buscar-os').addEventListener('click', searchIndividualOS);
            document.getElementById('btn-atualizar-individual').addEventListener('click', updateIndividualOS);
            
            // Event listeners para ordena√ß√£o - CORRE√á√ÉO APLICADA
            document.querySelectorAll('th.sortable').forEach(th => {
                th.addEventListener('click', function() {
                    const column = this.getAttribute('data-column');
                    sortTable(currentTab, column);
                });
            });

            // Event listener para o select de status em lote
            document.getElementById('batch-status').addEventListener('change', function() {
                document.getElementById('btn-atualizar-status').disabled = selectedOS.size === 0 || this.value === '';
            });
            const filterStatusEl = document.getElementById('batch-filter-status');
            if (filterStatusEl) filterStatusEl.addEventListener('change', () => { renderBatchOSList(); updateSelectedCount(); });
            const filterEscEl = document.getElementById('batch-filter-escalonamento');
            if (filterEscEl) filterEscEl.addEventListener('change', () => { renderBatchOSList(); updateSelectedCount(); });
            const batchTipoEl = document.getElementById('batch-tipo');
            if (batchTipoEl) batchTipoEl.addEventListener('change', () => { populateBatchEscalonamento(); renderBatchOSList(); });

            // Popular escalonamento inicial
            try { populateBatchEscalonamento(); } catch(_) {}
            
            // Event listeners para a aba de alertas
            document.getElementById('btn-configurar-alerta').addEventListener('click', configurarAlerta);
            const btnTeste = document.getElementById('btn-testar-alerta');
            if (btnTeste) btnTeste.addEventListener('click', testarEnvioAlerta);
            const btnImport = document.getElementById('btn-importar-alertas');
            if (btnImport) btnImport.addEventListener('click', importLocalToSupabase);
            
            // Event listener para o bot√£o de aplicar filtros do dashboard
            document.getElementById('btn-aplicar-filtros-dashboard').addEventListener('click', loadDashboardData);
            
            // Event listener para o filtro de valores no dashboard
            document.getElementById('valor-filter-select').addEventListener('change', function() {
                loadDashboardData();
            });

            // Event listeners da aba de logs
            const btnLogs = document.getElementById('btn-aplicar-filtros-log');
            if (btnLogs) {
                btnLogs.addEventListener('click', () => {
                    renderLogsTab();
                });
            }
            const btnLoadMoreLogs = document.getElementById('btn-logs-load-more');
            if (btnLoadMoreLogs) {
                btnLoadMoreLogs.addEventListener('click', async () => {
                    const modeEl = document.getElementById('log-range-mode');
                    const usuarioEl = document.getElementById('log-user-select');
                    const mode = modeEl ? modeEl.value : 'mes_atual';
                    let from = null, to = null;
                    if (mode === 'mes_atual') {
                        const r = getCurrentMonthRange();
                        from = r.from; to = r.to;
                    } else if (mode !== 'todos') {
                        const r = getMonthRangeByName(mode);
                        if (r) { from = r.from; to = r.to; }
                    }
                    const params = { from, to, usuario: (usuarioEl ? usuarioEl.value : '__all__') };
                    logsOffset += LOGS_PAGE_SIZE;
                    const next = await fetchStatusLogs({ ...params, offset: logsOffset, pageSize: LOGS_PAGE_SIZE });
                    if (Array.isArray(next) && next.length) {
                        logsFullData = logsFullData.concat(next);
                        renderLogsChunk(true);
                    } else {
                        logsHasMore = false;
                        updateLogsLoadMore();
                    }
                });
            }
            
            // Event listeners para controle de colunas
            document.querySelectorAll('.column-toggle').forEach(toggle => {
                toggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const column = this.getAttribute('data-column');
                    toggleColumnVisibility(column);
                });
            });

            document.getElementById('select-all-transferencia-externa').addEventListener('change', (e) => {
                document.querySelectorAll('.transfer-checkbox-externa').forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                });
            });

            document.getElementById('select-all-transferencia-interna').addEventListener('change', (e) => {
                document.querySelectorAll('.transfer-checkbox-interna').forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                });
            });

            document.getElementById('select-all-transferencia-garantia').addEventListener('change', (e) => {
                document.querySelectorAll('.transfer-checkbox-garantia').forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                });
            });

            // Filtros da aba Transfer√™ncia de Escalonamento
            ['externa','interna','garantia'].forEach(tab => {
                const revendaEl = document.getElementById(`transfer-filter-revenda-${tab}`);
                const statusEl = document.getElementById(`transfer-filter-status-${tab}`);
                if (revendaEl) revendaEl.addEventListener('change', populateTransferenciaTables);
                if (statusEl) statusEl.addEventListener('change', populateTransferenciaTables);
            });

            // --- Eventos da aba Cadastrar Usu√°rios ---
            const cadForm = document.getElementById('form-cadastro-usuario');
            if (cadForm) {
                cadForm.addEventListener('submit', function(e){ e.preventDefault(); handleUserFormSubmit(); });
            }
            const btnLimparCadastro = document.getElementById('btn-limpar-cadastro');
            if (btnLimparCadastro) {
                btnLimparCadastro.addEventListener('click', clearUserForm);
            }

            // --- Eventos do modal de troca de senha do primeiro login ---
            const formChangePass = document.getElementById('form-change-password');
            if (formChangePass) {
                formChangePass.addEventListener('submit', function(e){ e.preventDefault(); saveNewPasswordFirstLogin(); });
            }
            const cancelChangePass = document.getElementById('cancel-change-password');
            if (cancelChangePass) {
                cancelChangePass.addEventListener('click', function(){ document.getElementById('modal-change-password').style.display = 'none'; });
            }
            const closeChangePass = document.getElementById('close-change-password');
            if (closeChangePass) {
                closeChangePass.addEventListener('click', function(){ document.getElementById('modal-change-password').style.display = 'none'; });
            }

            // --- Eventos da aba Atualizar Valores (CSV) ---
            const btnValidarCSV = document.getElementById('btn-validar-csv-valores');
            const btnAplicarCSV = document.getElementById('btn-aplicar-csv-valores');
            const inputCSV = document.getElementById('csv-valores-file');
            if (inputCSV) {
                inputCSV.addEventListener('change', function(){
                    const resumo = document.getElementById('csv-valores-resumo');
                    const detalhes = document.getElementById('csv-valores-detalhes');
                    if (resumo) resumo.textContent = this.files && this.files.length ? `Arquivo selecionado: ${this.files[0].name}` : 'Nenhum arquivo carregado.';
                    if (detalhes) detalhes.textContent = '';
                    if (btnAplicarCSV) btnAplicarCSV.disabled = true;
                });
            }
            if (btnValidarCSV) btnValidarCSV.addEventListener('click', handleValidarCSVValores);
            if (btnAplicarCSV) btnAplicarCSV.addEventListener('click', applyCSVValueUpdates);

            // --- Eventos da aba Importa√ß√£o de Dados ---
            const btnParseImport = document.getElementById('btn-parse-import');
            const btnSaveImport = document.getElementById('btn-save-import');
            const btnClearImport = document.getElementById('btn-clear-import');
            const inputImportFile = document.getElementById('import-csv-file');
            if (inputImportFile) {
                inputImportFile.addEventListener('change', function(){
                    const resumo = document.getElementById('import-resumo');
                    const detalhes = document.getElementById('import-detalhes');
                    if (resumo) resumo.textContent = this.files && this.files.length ? `Arquivo selecionado: ${this.files[0].name}` : 'Aguardando arquivo ou colagem.';
                    if (detalhes) detalhes.textContent = '';
                    if (btnSaveImport) btnSaveImport.disabled = true;
                    if (btnClearImport) btnClearImport.disabled = true;
                });
            }
            if (btnParseImport) btnParseImport.addEventListener('click', handleImportParse);
            if (btnSaveImport) btnSaveImport.addEventListener('click', handleImportSave);
            if (btnClearImport) btnClearImport.addEventListener('click', clearImportPreview);

            const manualSave = document.getElementById('manual-update-save');
            if (manualSave) {
                manualSave.addEventListener('click', async () => {
                    const input = document.getElementById('manual-update-input');
                    if (!input || !input.value) { showErrorMessage('Informe data e hora.'); return; }
                    const d = new Date(input.value);
                    if (isNaN(d)) { showErrorMessage('Formato de data inv√°lido.'); return; }
                    setDashboardUpdateIndicator(d);
                    setSuccessUpdateIndicator(d);
                    const res = await saveManualUpdateTimestamp(d.toISOString());
                    if (res === 'server') {
                        showSuccessMessage('Data de atualiza√ß√£o definida no servidor.');
                    } else if (res === 'local') {
                        showErrorMessage('Falha ao salvar no servidor. Data salva localmente.');
                    } else {
                        showErrorMessage('Sem permiss√£o para editar este campo.');
                    }
                });
            }
        }

        // --- L√ìGICA PRINCIPAL ---
        
        // Estado do controle de colunas
        let columnVisibility = JSON.parse(localStorage.getItem('columnVisibility')) || {};
        
        function toggleColumnVisibility(column) {
            // Inverte o estado de visibilidade da coluna
            columnVisibility[column] = !columnVisibility[column];
            
            // Salva no localStorage
            localStorage.setItem('columnVisibility', JSON.stringify(columnVisibility));
            
            // Aplica a visibilidade
            applyColumnVisibility();
        }
        
        function applyColumnVisibility() {
            // Aplica a visibilidade para todas as tabelas
            const tables = ['externa', 'interna', 'garantia'];
            
            tables.forEach(tabName => {
                const table = document.getElementById(`table-${tabName}`);
                if (table) {
                    // Aplica para cabe√ßalhos
                    table.querySelectorAll('th').forEach(th => {
                        const col = th.getAttribute('data-column');
                        if (col && columnVisibility[col]) {
                            th.classList.add('column-hidden');
                        } else {
                            th.classList.remove('column-hidden');
                        }
                    });
                    
                    // Aplica para c√©lulas do corpo
                    table.querySelectorAll('tbody tr').forEach(tr => {
                        tr.querySelectorAll('td').forEach((td, index) => {
                            const th = table.querySelectorAll('th')[index];
                            if (th) {
                                const col = th.getAttribute('data-column');
                                if (col && columnVisibility[col]) {
                                    td.classList.add('column-hidden');
                                } else {
                                    td.classList.remove('column-hidden');
                                }
                            }
                        });
                    });
                }
            });
        }
        
        // Inicializa a visibilidade das colunas ao carregar
        function initializeColumnVisibility() {
            // Configura coluna "Dias" como oculta por padr√£o se n√£o houver configura√ß√£o salva
            if (Object.keys(columnVisibility).length === 0) {
                columnVisibility['dias'] = true; // Oculta a coluna Dias por padr√£o
                localStorage.setItem('columnVisibility', JSON.stringify(columnVisibility));
            }
        }
        
        // --- NOVO SISTEMA DE CONTROLE DE COLUNAS ---
        
        // Configura√ß√£o das colunas dispon√≠veis
        const availableColumns = [
            { id: 'revenda', name: 'Revenda' },
            { id: 'nro-os', name: 'Nro. OS' },
            { id: 'situacao', name: 'Situa√ß√£o OS' },
            { id: 'tipo', name: 'Tipo OS' },
            { id: 'emissao', name: 'Emiss√£o' },
            { id: 'dias', name: 'Dias' },
            { id: 'dias-aberto', name: 'Dias em Aberto' },
            { id: 'status', name: 'Status' },
            { id: 'cliente', name: 'Cliente' },
            { id: 'chassi', name: 'Chassi' },
            { id: 'consultor', name: 'Consultor' },
            { id: 'total-pecas', name: 'Total Pe√ßas' },
            { id: 'total-servico', name: 'Total Servi√ßo' },
            { id: 'total-os', name: 'Total OS' },
            { id: 'observacao', name: 'Observa√ß√£o' },
            { id: 'acao-atualizacao', name: 'A√ß√£o/Atualiza√ß√£o' },
            { id: 'escalonamento', name: 'Escalonamento' }
        ];
        
        // Cria o menu de controle de colunas
        function createColumnsMenu(tab) {
            const menu = document.createElement('div');
            menu.className = 'columns-menu';
            
            const title = document.createElement('h4');
            title.textContent = 'Controle de Colunas';
            menu.appendChild(title);
            
            // Adiciona op√ß√µes para cada coluna
            availableColumns.forEach(column => {
                const columnItem = document.createElement('div');
                columnItem.className = 'column-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `column-${column.id}-${tab}`;
                checkbox.checked = !columnVisibility[column.id];
                checkbox.addEventListener('change', () => {
                    columnVisibility[column.id] = !checkbox.checked;
                    localStorage.setItem('columnVisibility', JSON.stringify(columnVisibility));
                    applyColumnVisibility();
                });
                
                const label = document.createElement('label');
                label.htmlFor = `column-${column.id}-${tab}`;
                label.textContent = column.name;
                
                columnItem.appendChild(checkbox);
                columnItem.appendChild(label);
                menu.appendChild(columnItem);
            });
            
            // Adiciona bot√£o para baixar matriz
            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'download-matrix-btn';
            downloadBtn.textContent = 'üì• Baixar Matriz';
            downloadBtn.addEventListener('click', () => {
                downloadMatrix(tab);
            });
            menu.appendChild(downloadBtn);
            
            return menu;
        }
        
        // Fun√ß√£o para baixar matriz (placeholder)
        function downloadMatrix(tab) {
            alert(`Fun√ß√£o de download da matriz para ${tab} ser√° implementada aqui.`);
        }

        // --- CONTROLE DE ACESSO POR PERFIL ---
        function applyUserAccessControl() {
            try {
                const user = window.NormaQCurrentUser || (JSON.parse(localStorage.getItem('authUser')) || null);
                const isAdmin = !!(user && (user.is_admin || user.tipo_usuario === 'Administrador'));
                const isGestor = !!(user && user.tipo_usuario === 'Gestor');
                const isUsuario = !!(user && user.tipo_usuario === 'Usu√°rio');
                // Whitelist para acesso √† aba Atualiza√ß√£o
                const normalize = s => (s || '').toString().normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
                const nomeNorm = normalize(user && (user.nome_completo || user.usuario));
                const UPDATE_WHITELIST = ['isabelle','ana leya','flavia','giovana','bruna','graziela','johnny','wanderley'];
                const canUseAtualizacao = UPDATE_WHITELIST.some(n => nomeNorm.includes(n));

                // Obter refer√™ncias para todas as abas
                const externaTab = document.querySelector('.tab[data-tab="externa"]');
                const internaTab = document.querySelector('.tab[data-tab="interna"]');
                const garantiaTab = document.querySelector('.tab[data-tab="garantia"]');
                const atualizacaoTab = document.querySelector('.tab[data-tab="atualizacao"]');
                const atualizarValoresTab = document.querySelector('.tab[data-tab="atualizar-valores"]');
                const importacaoTab = document.querySelector('.tab[data-tab="importacao"]');
                const dashboardTab = document.querySelector('.tab[data-tab="dashboard"]');
                const alertaTab = document.getElementById('alerta-tab');
                const statusTab = document.querySelector('.tab[data-tab="gerenciar-status"]');
                const transferTab = document.querySelector('.tab[data-tab="transferencia-escalonamento"]');
                const logsTab = document.getElementById('tab-logs-status');
                const cadTab = document.getElementById('tab-cadastro-usuarios');

                // Obter refer√™ncias para os conte√∫dos das abas
                const externaContent = document.getElementById('externa');
                const internaContent = document.getElementById('interna');
                const garantiaContent = document.getElementById('garantia');
                const atualizacaoContent = document.getElementById('atualizacao');
                const atualizarValoresContent = document.getElementById('atualizar-valores');
                const importacaoContent = document.getElementById('importacao');
                const dashboardContent = document.getElementById('dashboard');
                const alertaContent = document.getElementById('alerta');
                const statusContent = document.getElementById('gerenciar-status');
                const transferContent = document.getElementById('transferencia-escalonamento');
                const logsContent = document.getElementById('logs-status');
                const cadContent = document.getElementById('cadastro-usuarios');

                if (isAdmin) {
                    // Administrador: v√™ todas as abas
                    [externaTab, internaTab, garantiaTab, atualizacaoTab, atualizarValoresTab, importacaoTab,
                     dashboardTab, alertaTab, statusTab, transferTab, logsTab, cadTab].forEach(tab => {
                        if (tab) tab.style.display = '';
                    });
                    acessoAlertasLiberado = true;
                } else if (isGestor) {
                    // Gestor: libera Atualiza√ß√£o se estiver na whitelist
                    [externaTab, internaTab, garantiaTab, dashboardTab, alertaTab, transferTab, logsTab, (canUseAtualizacao ? atualizacaoTab : null)].forEach(tab => {
                        if (tab) tab.style.display = '';
                    });
                    // Oculta Gerenciar Status para gestor e demais abas restritas; mant√©m Atualiza√ß√£o se liberada
                    [statusTab, (canUseAtualizacao ? null : atualizacaoTab), atualizarValoresTab, importacaoTab, cadTab].forEach(tab => {
                        if (tab) tab.style.display = 'none';
                    });
                    // Se a tab atual foi ocultada, voltar para Externa (n√£o troca se Atualiza√ß√£o estiver liberada)
                    const gestorBlocked = ['atualizar-valores', 'cadastro-usuarios', 'gerenciar-status'];
                    if (gestorBlocked.includes(currentTab) || (currentTab === 'atualizacao' && !canUseAtualizacao)) {
                        if (externaTab && externaContent) {
                            document.querySelectorAll('.tab.active, .tab-content.active').forEach(el => el.classList.remove('active'));
                            externaTab.classList.add('active');
                            externaContent.classList.add('active');
                            currentTab = 'externa';
                        }
                    }
                } else if (isUsuario) {
                    // Usu√°rio: OS Externa, OS Interna, OS Garantia e Dashboard
                    // Libera a aba Atualiza√ß√£o somente para whitelist
                    [externaTab, internaTab, garantiaTab, dashboardTab, (canUseAtualizacao ? atualizacaoTab : null)].forEach(tab => {
                        if (tab) tab.style.display = '';
                    });
                    // Oculta demais abas; mant√©m Atualiza√ß√£o vis√≠vel se em whitelist
                    [statusTab, (canUseAtualizacao ? null : atualizacaoTab), atualizarValoresTab, importacaoTab, alertaTab, transferTab, logsTab, cadTab].forEach(tab => {
                        if (tab) tab.style.display = 'none';
                    });
                    // Se a tab atual foi ocultada, voltar para Externa
                    const blockedTabs = ['gerenciar-status', 'atualizar-valores', 'importacao', 'alerta', 'transferencia-escalonamento', 'logs-status', 'cadastro-usuarios'];
                    const atualizacaoBloqueada = (!canUseAtualizacao && currentTab === 'atualizacao');
                    if (blockedTabs.includes(currentTab) || atualizacaoBloqueada) {
                        if (externaTab && externaContent) {
                            document.querySelectorAll('.tab.active, .tab-content.active').forEach(el => el.classList.remove('active'));
                            externaTab.classList.add('active');
                            externaContent.classList.add('active');
                            currentTab = 'externa';
                        }
                    }
                } else {
                    // Usu√°rio padr√£o (sem tipo definido): OS Externa, OS Interna, OS Garantia e Dashboard
                    [externaTab, internaTab, garantiaTab, dashboardTab].forEach(tab => {
                        if (tab) tab.style.display = '';
                    });
                    // Oculta Gerenciar Status para usu√°rio padr√£o
                    [statusTab, atualizacaoTab, atualizarValoresTab, importacaoTab, alertaTab, transferTab, logsTab, cadTab].forEach(tab => {
                        if (tab) tab.style.display = 'none';
                    });
                    // Se a tab atual foi ocultada, voltar para Externa
                    if (['gerenciar-status', 'atualizacao', 'atualizar-valores', 'importacao', 'alerta', 'transferencia-escalonamento', 'logs-status', 'cadastro-usuarios'].includes(currentTab)) {
                        if (externaTab && externaContent) {
                            document.querySelectorAll('.tab.active, .tab-content.active').forEach(el => el.classList.remove('active'));
                            externaTab.classList.add('active');
                            externaContent.classList.add('active');
                            currentTab = 'externa';
                        }
                    }
                }

                const manualCtl = document.getElementById('manual-update-control');
                if (manualCtl) manualCtl.style.display = (user && user.usuario === 'thiago.carmo') ? '' : 'none';

                // Garantir que os conte√∫dos das abas ocultas tamb√©m sejam desativados
                [atualizacaoContent, atualizarValoresContent, importacaoContent, alertaContent, statusContent, transferContent, logsContent, cadContent].forEach(content => {
                    if (content) content.classList.remove('active');
                });

                // Atualizar o nome do usu√°rio no cabe√ßalho
                updateUserNameDisplay();

            } catch (e) {
                console.warn('Falha ao aplicar controle de acesso:', e);
            }
        }

        // --- LOGS DE STATUS E VISITAS ---
        const TABELA_STATUS_LOGS = 'status_logs';
        const TABELA_STATUS_LOGS_FALLBACK = 'status_logs';
        const COL_TIPO_OS_DB = 'Tipo OS';
        const TABELA_PAGE_VISITS = 'page_visits';
        const TABELA_USER_SESSIONS = 'user_sessions';
        let currentSessionId = null;
        let currentSessionLoginAt = null;

        function genSessionId() {
            if (self.crypto && self.crypto.randomUUID) return self.crypto.randomUUID();
            return 'sess_' + Date.now() + '_' + Math.floor(Math.random() * 1000000);
        }

        async function startUserSession() {
            const user = getCurrentUserInfo();
            if (!user) return;
            currentSessionId = genSessionId();
            currentSessionLoginAt = new Date();
            const payload = {
                session_id: currentSessionId,
                usuario: user.usuario,
                nome_completo: user.nome_completo,
                tipo_usuario: user.tipo_usuario,
                login_at: currentSessionLoginAt.toISOString(),
                created_at: currentSessionLoginAt.toISOString()
            };
            try {
                if (typeof supabase !== 'undefined') {
                    const { error } = await supabase.from(TABELA_USER_SESSIONS).insert(payload);
                    if (error) throw error;
                } else {
                    throw new Error('Supabase indispon√≠vel');
                }
            } catch (e) {
                const local = JSON.parse(localStorage.getItem('userSessions') || '[]');
                local.push(payload);
                localStorage.setItem('userSessions', JSON.stringify(local));
            }
        }

        async function endUserSession() {
            const user = getCurrentUserInfo();
            if (!user || !currentSessionId || !currentSessionLoginAt) return;
            const logout = new Date();
            const durationSeconds = Math.max(0, Math.round((logout.getTime() - currentSessionLoginAt.getTime()) / 1000));
            const update = { logout_at: logout.toISOString(), duration_seconds: durationSeconds };
            try {
                if (typeof supabase !== 'undefined') {
                    const { error } = await supabase
                        .from(TABELA_USER_SESSIONS)
                        .update(update)
                        .eq('session_id', currentSessionId);
                    if (error) throw error;
                } else {
                    throw new Error('Supabase indispon√≠vel');
                }
            } catch (e) {
                const local = JSON.parse(localStorage.getItem('userSessions') || '[]');
                const idx = local.findIndex(s => s.session_id === currentSessionId);
                if (idx >= 0) {
                    local[idx] = { ...local[idx], ...update };
                    localStorage.setItem('userSessions', JSON.stringify(local));
                }
            }
        }

        async function fetchUserSessions({ from, to, usuario }) {
            let result = [];
            let usedFallback = false;
            try {
                if (typeof supabase !== 'undefined') {
                    let query = supabase.from(TABELA_USER_SESSIONS).select('*');
                    const fromIso = from ? new Date(from + 'T00:00:00').toISOString() : null;
                    const toIso = to ? new Date(to + 'T23:59:59.999').toISOString() : null;
                    if (fromIso) query = query.gte('login_at', fromIso);
                    if (toIso) query = query.lte('login_at', toIso);
                    if (usuario && usuario !== '__all__') {
                        const u = String(usuario).replace(/"/g, '\\"');
                        query = query.or('usuario.eq."' + u + '",nome_completo.eq."' + u + '"');
                    }
                    query = query.order('login_at', { ascending: false });
                    const { data, error } = await query;
                    if (error) throw error;
                    result = data || [];
                    if (!result.length) usedFallback = true;
                }
            } catch (e) { usedFallback = true; }

            if (usedFallback && typeof supabase !== 'undefined') {
                try {
                    let q = supabase.from(TABELA_PAGE_VISITS).select('*').in('pagina', ['login','index']);
                    const fromIso = from ? new Date(from + 'T00:00:00').toISOString() : null;
                    const toIso = to ? new Date(to + 'T23:59:59.999').toISOString() : null;
                    if (fromIso) q = q.gte('created_at', fromIso);
                    if (toIso) q = q.lte('created_at', toIso);
                    if (usuario && usuario !== '__all__') {
                        const u2 = String(usuario).replace(/"/g, '\\"');
                        q = q.or('usuario.eq."' + u2 + '",nome_completo.eq."' + u2 + '"');
                    }
                    q = q.order('created_at', { ascending: false });
                    const { data } = await q;
                    const mapped = (data || []).map(v => ({
                        session_id: v.id || undefined,
                        usuario: v.usuario,
                        nome_completo: v.nome_completo,
                        tipo_usuario: v.tipo_usuario,
                        login_at: v.created_at,
                        logout_at: null,
                        duration_seconds: 0,
                        created_at: v.created_at
                    }));
                    result = mapped;
                } catch (_) {}
            }

            const local = JSON.parse(localStorage.getItem('userSessions') || '[]');
            const merged = [...result, ...local];
            return merged.filter(item => {
                const dt = parseDateOnly(item.login_at || item.created_at);
                const fromOk = from ? dt >= from : true;
                const toOk = to ? dt <= to : true;
                const userOk = usuario && usuario !== '__all__' ? (item.usuario === usuario || item.nome_completo === usuario) : true;
                return fromOk && toOk && userOk;
            });
        }

        // Fun√ß√£o para atualizar o nome do usu√°rio no cabe√ßalho
        function updateUserNameDisplay() {
            const user = getCurrentUserInfo();
            const userNameElement = document.getElementById('user-name');
            if (userNameElement && user) {
                userNameElement.textContent = user.nome_completo || user.usuario;
            }
        }

        function getCurrentUserInfo() {
            const user = window.NormaQCurrentUser || (JSON.parse(localStorage.getItem('authUser')) || null);
            if (!user) return null;
            return {
                id: user.id,
                nome_completo: user.nome_completo,
                usuario: user.usuario,
                tipo_usuario: user.tipo_usuario,
                is_admin: !!(user.is_admin || user.tipo_usuario === 'Administrador'),
                empresa_id: user.empresa_id || null
            };
        }

        async function logPageVisit(page = 'index') {
            const user = getCurrentUserInfo();
            if (!user) return;
            const payload = {
                usuario: user.usuario,
                nome_completo: user.nome_completo,
                tipo_usuario: user.tipo_usuario,
                pagina: page,
                created_at: new Date().toISOString()
            };
            try {
                if (typeof supabase !== 'undefined') {
                    const { error } = await supabase.from(TABELA_PAGE_VISITS).insert(payload);
                    if (error) throw error;
                } else {
                    throw new Error('Supabase client indispon√≠vel');
                }
            } catch (e) {
                console.warn('Falha ao inserir visita em supabase, usando localStorage', e);
                const local = JSON.parse(localStorage.getItem('pageVisits') || '[]');
                local.push(payload);
                localStorage.setItem('pageVisits', JSON.stringify(local));
            }
        }

        async function logStatusChangeEntry({ osId, nroOS, revenda, statusAnterior, statusNovo, tipoOS }) {
            console.log('DEBUG: logStatusChangeEntry chamado para OS', nroOS, 'de', statusAnterior, 'para', statusNovo, 'revenda:', revenda);
            const user = getCurrentUserInfo();
            if (!user) {
                try { showStatusLogToast('Usu√°rio n√£o identificado. Log n√£o ser√° salvo.', 'error'); } catch(_) {}
                console.warn('Log de status ignorado: usu√°rio n√£o identificado.');
                return;
            }
            const payloadDb = {
                usuario: user.usuario,
                nome_completo: user.nome_completo,
                tipo_usuario: user.tipo_usuario,
                os_id: osId,
                nro_os: nroOS,
                revenda: getRevendaName(revenda) || null,
                [COL_TIPO_OS_DB]: tipoOS || null,
                status_anterior: statusAnterior || 'Sem Status',
                status_novo: statusNovo || 'Sem Status'
            };
            const payloadLocal = {
                ...payloadDb,
                tipo_os: tipoOS || null,
                created_at: new Date().toISOString()
            };
            try { console.debug('status_logs payload', payload); } catch(_) {}
            try {
                if (typeof supabase !== 'undefined') {
                    console.log('DEBUG: Tentando inserir em status_logs...');
                    const { data, error } = await supabase.from(TABELA_STATUS_LOGS).insert(payloadDb);
                    if (error) {
                        console.error('Erro detalhado do Supabase:', error);
                        console.error('C√≥digo do erro:', error.code);
                        console.error('Detalhes do erro:', error.details);
                        console.error('Mensagem do erro:', error.message);
                        // Fallback: remover campo tipo_os se a coluna n√£o existir e tentar novamente
                        throw error;
                    }
                    console.log('DEBUG: Inser√ß√£o bem-sucedida em status_logs');
                    try { showStatusLogToast('Log de status salvo com sucesso.', 'success'); } catch(_) {}
                    try { await renderLogsTab(); } catch(_) {}
                } else {
                    throw new Error('Supabase client indispon√≠vel');
                }
            } catch (e) {
                console.warn('Falha ao inserir log em supabase, usando localStorage', e);
                console.error('Detalhes do erro:', e.message, e.code, e.details);
                const local = JSON.parse(localStorage.getItem('statusLogs') || '[]');
                local.push(payloadLocal);
                localStorage.setItem('statusLogs', JSON.stringify(local));
                // Exibe detalhe do erro (RLS/403/401) quando poss√≠vel
                const msg = (e && e.message) ? `Falha ao salvar no Supabase: ${e.message}. Log salvo localmente.` : 'Falha ao salvar no Supabase. Log salvo localmente.';
                try { showStatusLogToast(msg, 'error'); } catch(_) {}
                // Atualiza a aba de logs para refletir o fallback
                try { await renderLogsTab(); } catch(_) {}
            }
        }

        function parseDateOnly(isoString) {
            const d = new Date(isoString);
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }

        function toUtcStart(dateStr) {
            if (!dateStr) return null;
            const parts = dateStr.split('-').map(Number);
            const iso = new Date(Date.UTC(parts[0], parts[1]-1, parts[2], 0, 0, 0, 0)).toISOString();
            return iso;
        }

        function toUtcEnd(dateStr) {
            if (!dateStr) return null;
            const parts = dateStr.split('-').map(Number);
            const iso = new Date(Date.UTC(parts[0], parts[1]-1, parts[2], 23, 59, 59, 999)).toISOString();
            return iso;
        }

        function getCurrentMonthRange() {
            const now = new Date();
            const localNow = new Date(now.getTime() - now.getTimezoneOffset() * 60000);
            const start = new Date(localNow.getFullYear(), localNow.getMonth(), 1);
            const end = new Date(localNow.getFullYear(), localNow.getMonth()+1, 0);
            const fromStr = new Date(start.getTime() - start.getTimezoneOffset() * 60000).toISOString().slice(0,10);
            const toStr = new Date(end.getTime() - end.getTimezoneOffset() * 60000).toISOString().slice(0,10);
            return { from: fromStr, to: toStr };
        }

        function getMonthRangeByName(name) {
            if (!name) return null;
            const map = { 'janeiro':0, 'fevereiro':1, 'mar√ßo':2, 'marco':2, 'abril':3, 'maio':4, 'junho':5, 'julho':6, 'agosto':7, 'setembro':8, 'outubro':9, 'novembro':10, 'dezembro':11 };
            const idx = map[(name || '').toLowerCase()];
            if (idx === undefined) return null;
            const now = new Date();
            const year = now.getFullYear();
            const start = new Date(year, idx, 1);
            const end = new Date(year, idx + 1, 0);
            const fromStr = new Date(start.getTime() - start.getTimezoneOffset() * 60000).toISOString().slice(0,10);
            const toStr = new Date(end.getTime() - end.getTimezoneOffset() * 60000).toISOString().slice(0,10);
            return { from: fromStr, to: toStr };
        }

        function getTodayRange() {
            const now = new Date();
            const localNow = new Date(now.getTime() - now.getTimezoneOffset() * 60000);
            const dayStr = localNow.toISOString().slice(0,10);
            return { from: dayStr, to: dayStr };
        }

        async function fetchStatusLogs({ from, to, usuario, offset = 0, pageSize = LOGS_PAGE_SIZE }) {
            try {
                if (typeof supabase !== 'undefined') {
                    console.log('DEBUG: Buscando logs do Supabase...');
                    let q1 = supabase.from(TABELA_STATUS_LOGS)
                        .select('created_at, usuario, nome_completo, os_id, nro_os, revenda, "Tipo OS", status_anterior, status_novo')
                        .order('created_at', { ascending: false })
                        .range(offset, offset + pageSize - 1);
                    // Filtragem por data no servidor quando informado (m√™s atual por padr√£o)
                    const fromIso = from ? toUtcStart(from) : null;
                    const toIso = to ? toUtcEnd(to) : null;
                    if (fromIso) q1 = q1.gte('created_at', fromIso);
                    if (toIso) q1 = q1.lte('created_at', toIso);
                    // Filtro por usu√°rio permanece no cliente para evitar incompatibilidades
                    const { data, error } = await q1;
                    if (error) {
                        console.error('Erro na busca 1 de status_logs:', error);
                        throw error;
                    }
                    console.log('DEBUG: Resultado da busca 1 -', data?.length, 'registros encontrados');
                    if (data && data.length) {
                        // Normaliza Tipo OS para o cliente
                        const normalized = (data || []).map(row => {
                            if (row && row[COL_TIPO_OS_DB] !== undefined) row.tipo_os = row[COL_TIPO_OS_DB];
                            return row;
                        });
                        let result = normalized.filter(l => {
                            const d = parseDateOnly(l.created_at);
                            const fromOk = from ? d >= from : true;
                            const toOk = to ? d <= to : true;
                            const userOk = usuario && usuario !== '__all__' ? (l.usuario === usuario || l.nome_completo === usuario) : true;
                            return fromOk && toOk && userOk;
                        });
                        const filteredUser = (usuario && usuario !== '__all__') ? usuario.toLowerCase() : null;
                        if (filteredUser === 'bruna' || (filteredUser && filteredUser.includes('bruna'))) {
                            result = (result || []).filter(l => {
                                const rev = (l.revenda || '').toLowerCase();
                                const okRev = ['recife','natal','petrolina'].includes(rev);
                                const okTipo = !l.tipo_os || l.tipo_os === 'Interna';
                                return okRev && okTipo;
                            });
                        }
                        try {
                            const local = JSON.parse(localStorage.getItem('statusLogs') || '[]');
                            let merged = result.concat(local);
                            merged = merged.filter(l => {
                                const d = parseDateOnly(l.created_at);
                                const fromOk = from ? d >= from : true;
                                const toOk = to ? d <= to : true;
                                const userOk = usuario && usuario !== '__all__' ? (l.usuario === usuario || l.nome_completo === usuario) : true;
                                return fromOk && toOk && userOk;
                            });
                            const seen = new Set();
                            merged = merged.filter(l => {
                                const k = [l.os_id || '', l.nro_os || '', l.status_novo || '', l.created_at || ''].join('|');
                                if (seen.has(k)) return false;
                                seen.add(k);
                                return true;
                            });
                            console.log('DEBUG: Resultado final ap√≥s merge/local:', merged.length);
                            return merged;
                        } catch(_) {
                            console.log('DEBUG: Resultado final sem merge/local:', result.length);
                            return result;
                        }
                    }

                    console.log('DEBUG: Tentando busca 2 sem filtros de data...');
                    let q2 = supabase.from(TABELA_STATUS_LOGS)
                        .select('created_at, usuario, nome_completo, os_id, nro_os, revenda, "Tipo OS", status_anterior, status_novo')
                        .order('created_at', { ascending: false })
                        .range(offset, offset + pageSize - 1);
                    // Filtro por usu√°rio ser√° aplicado no cliente para evitar incompatibilidades de sintaxe
                    const { data: data2, error: error2 } = await q2;
                    if (error2) {
                        console.error('Erro na busca 2 de status_logs:', error2);
                        throw error2;
                    }
                    console.log('DEBUG: Resultado da busca 2 -', data2?.length, 'registros encontrados');
                    if (data2 && data2.length) {
                        const normalized2 = (data2 || []).map(row => { if (row && row[COL_TIPO_OS_DB] !== undefined) row.tipo_os = row[COL_TIPO_OS_DB]; return row; });
                        const filteredUser = (usuario && usuario !== '__all__') ? usuario.toLowerCase() : null;
                        if (filteredUser === 'bruna' || (filteredUser && filteredUser.includes('bruna'))) {
                            return (normalized2 || []).filter(l => {
                                const rev = (l.revenda || '').toLowerCase();
                                const okRev = ['recife','natal','petrolina'].includes(rev);
                                const okTipo = !l.tipo_os || l.tipo_os === 'Interna';
                                return okRev && okTipo;
                            });
                        }
                        // Aplicar filtros client-side (from, to, usuario)
                        let res2 = (normalized2 || []).filter(l => {
                            const d = parseDateOnly(l.created_at);
                            const fromOk = from ? d >= from : true;
                            const toOk = to ? d <= to : true;
                            const userOk = usuario && usuario !== '__all__' ? (l.usuario === usuario || l.nome_completo === usuario) : true;
                            return fromOk && toOk && userOk;
                        });
                        console.log('DEBUG: Resultado da busca 2 ap√≥s filtro local:', res2.length);
                        return res2;
                    }
                    // Tenta tabela fallback
                    if (typeof TABELA_STATUS_LOGS_FALLBACK !== 'undefined' && TABELA_STATUS_LOGS_FALLBACK) {
                        console.log('DEBUG: Tentando tabela fallback:', TABELA_STATUS_LOGS_FALLBACK);
                        let qfb = supabase.from(TABELA_STATUS_LOGS_FALLBACK)
                            .select('*')
                            .order('id', { ascending: false })
                            .range(offset, offset + pageSize - 1);
                        const { data: dataFb, error: errFb } = await qfb;
                        if (!errFb && dataFb && dataFb.length) {
                            const normalizedFb = (dataFb || []).map(row => { if (row && row[COL_TIPO_OS_DB] !== undefined) row.tipo_os = row[COL_TIPO_OS_DB]; return row; });
                            let resFb = (normalizedFb || []).filter(l => {
                                const d = parseDateOnly(l.created_at);
                                const fromOk = from ? d >= from : true;
                                const toOk = to ? d <= to : true;
                                const userOk = usuario && usuario !== '__all__' ? (l.usuario === usuario || l.nome_completo === usuario) : true;
                                return fromOk && toOk && userOk;
                            });
                            console.log('DEBUG: Resultado da tabela fallback:', resFb.length);
                            return resFb;
                        }
                    }
                    // Sem dados no Supabase: usar fallback local
                    console.log('DEBUG: Nenhum dado encontrado no Supabase (tabela principal e fallback)');
                    throw new Error('Nenhum dado de status no Supabase para o filtro atual');
                }
            } catch (e) {
                console.warn('Falha ao buscar logs em supabase, usando localStorage', e);
            }
            console.log('DEBUG: Usando fallback do localStorage');
            const local = JSON.parse(localStorage.getItem('statusLogs') || '[]');
            let filtered = local.filter(item => {
                const dt = parseDateOnly(item.created_at);
                const fromOk = from ? dt >= from : true;
                const toOk = to ? dt <= to : true;
                const userOk = usuario && usuario !== '__all__' ? (item.usuario === usuario || item.nome_completo === usuario) : true;
                return fromOk && toOk && userOk;
            });
            if (usuario && usuario !== '__all__') {
                const u = usuario.toLowerCase();
                if (u === 'bruna' || u.includes('bruna')) {
                    filtered = filtered.filter(l => {
                        const rev = (l.revenda || '').toLowerCase();
                        const okRev = ['recife','natal','petrolina'].includes(rev);
                        const okTipo = !l.tipo_os || l.tipo_os === 'Interna';
                        return okRev && okTipo;
                    });
                }
            }
            console.log('DEBUG: Fallback do localStorage -', filtered.length, 'registros encontrados');
            return filtered;
        }
        async function generateLogsFromOS({ from, to, usuario }) {
            const tabs = ['externa','interna','garantia'];
            const out = [];
            const userAll = !usuario || usuario === '__all__';
            const needsAll = !osData.externa.length || !osData.interna.length || !osData.garantia.length;
            if (needsAll && typeof supabase !== 'undefined') {
                try { await refreshAllTabsDataLite(); } catch(_) {}
            }
            tabs.forEach(tab => {
                (osData[tab] || []).forEach(os => {
                    const n = os['Numero OS'];
                    const obs = os['Observacao'] || '';
                    let statusNovo = 'Sem Status';
                    const m = obs.match(/\[Status:\s*(.*?)\]/);
                    if (m && m[1]) statusNovo = m[1].trim();
                    const emissao = os.Emissao || new Date().toISOString();
                    const d = parseDateOnly(emissao);
                    const fromOk = from ? d >= from : true;
                    const toOk = to ? d <= to : true;
                    if (!fromOk || !toOk) return;
                    if (!userAll) return;
                    out.push({
                        os_id: os.Chave || os.Cahve || null,
                        nro_os: n,
                        revenda: getRevendaName(os.Revenda) || os.Revenda || '',
                        tipo_os: os.Tipo || tab,
                        usuario: 'Sistema',
                        nome_completo: 'Sistema',
                        status_anterior: 'Sem Status',
                        status_novo: statusNovo,
                        created_at: emissao
                    });
                });
            });
            console.log('DEBUG: Logs sint√©ticos gerados a partir de OS:', out.length);
            return out;
        }

        async function fetchPageVisits({ from, to, usuario }) {
            try {
                if (typeof supabase !== 'undefined') {
                    let query = supabase.from(TABELA_PAGE_VISITS).select('*').eq('pagina', 'index');
                    if (from) query = query.gte('created_at', new Date(from).toISOString());
                    if (to) query = query.lte('created_at', new Date(new Date(to).setHours(23,59,59,999)).toISOString());
                    if (usuario && usuario !== '__all__') query = query.or('usuario.eq.' + usuario + ',nome_completo.eq.' + usuario);
                    query = query.order('created_at', { ascending: false });
                    const { data, error } = await query;
                    if (error) throw error;
                    if (data && data.length) return data;
                    // Sem dados no Supabase: usar fallback
                    throw new Error('Nenhum dado de visitas no Supabase para o filtro atual');
                }
            } catch (e) {
                console.warn('Falha ao buscar visitas em supabase, usando localStorage', e);
            }
            const local = JSON.parse(localStorage.getItem('pageVisits') || '[]');
            return local.filter(item => {
                const dt = parseDateOnly(item.created_at);
                const fromOk = from ? dt >= from : true;
                const toOk = to ? dt <= to : true;
                const userOk = usuario && usuario !== '__all__' ? (item.usuario === usuario || item.nome_completo === usuario) : true;
                const isIndex = item.pagina === 'index';
                return fromOk && toOk && userOk && isIndex;
            });
        }

        // Busca logins (por usu√°rio) no per√≠odo
        async function fetchPageLogins({ from, to, usuario }) {
            let result = [];
            try {
                if (typeof supabase !== 'undefined') {
                    let query = supabase.from(TABELA_PAGE_VISITS).select('*').eq('pagina', 'login');
                    if (from) query = query.gte('created_at', new Date(from).toISOString());
                    if (to) query = query.lte('created_at', new Date(new Date(to).setHours(23,59,59,999)).toISOString());
                    if (usuario && usuario !== '__all__') query = query.or('usuario.eq.' + usuario + ',nome_completo.eq.' + usuario);
                    query = query.order('created_at', { ascending: false });
                    const { data, error } = await query;
                    if (error) throw error;
                    result = (data || []);
                }
            } catch (e) {
                console.warn('Falha ao buscar logins no Supabase, continuando com localStorage', e);
            }
            // Mescla com localStorage (para garantir que os logins existam)
            const local = JSON.parse(localStorage.getItem('pageVisits') || '[]').filter(item => item.pagina === 'login');
            const merged = [...result, ...local];
            return merged.filter(item => {
                const dt = parseDateOnly(item.created_at);
                const fromOk = from ? dt >= from : true;
                const toOk = to ? dt <= to : true;
                const userOk = usuario && usuario !== '__all__' ? (item.usuario === usuario || item.nome_completo === usuario) : true;
                return fromOk && toOk && userOk;
            });
        }

        function aggregateByDay(items) {
            const map = new Map();
            items.forEach(it => {
                const day = parseDateOnly(it.created_at);
                map.set(day, (map.get(day) || 0) + 1);
            });
            // Ordenar por data
            return Array.from(map.entries()).sort((a,b) => a[0] > b[0] ? 1 : -1);
        }

        function formatDayLabelBR(dateStr) {
            try {
                const parts = String(dateStr || '').split('-');
                if (parts.length === 3) return parts[2].padStart(2,'0') + '/' + parts[1].padStart(2,'0');
                return dateStr;
            } catch(_) { return dateStr; }
        }

        function formatHHMM(seconds) {
            const s = Math.max(0, Number(seconds || 0));
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            return String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
        }

        function populateLogUserSelect() {
            const sel = document.getElementById('log-user-select');
            if (!sel) return;
            // Evita duplicar
            const existing = sel.querySelectorAll('option').length > 1;
            if (existing) return;
            const users = usuariosCache && usuariosCache.length ? usuariosCache : [];
            // Filtrar apenas usu√°rios que n√£o s√£o administradores
            const usuariosFiltrados = users.filter(u => 
                u.tipo_usuario !== 'Administrador' && u.tipo_usuario !== 'administrador'
            );
            usuariosFiltrados.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u.usuario || u.nome_completo || '';
                opt.textContent = u.nome_completo || u.usuario || '';
                sel.appendChild(opt);
            });
        }

        function setDefaultLogDates() {
            const toEl = document.getElementById('log-date-to');
            const fromEl = document.getElementById('log-date-from');
            const now = new Date();
            const localNow = new Date(now.getTime() - now.getTimezoneOffset() * 60000);
            const toStr = localNow.toISOString().slice(0,10);
            const from = new Date(localNow);
            from.setDate(localNow.getDate() - 30);
            const fromStr = from.toISOString().slice(0,10);
            if (toEl) {
                const currentTo = toEl.value || '';
                if (!currentTo || currentTo < toStr) toEl.value = toStr;
            }
            if (fromEl) {
                const currentFrom = fromEl.value || '';
                if (!currentFrom) fromEl.value = fromStr;
                if (fromEl.value > toStr) fromEl.value = fromStr;
            }
        }

        async function initializeLogsTab() {
            if (!usuariosCache || usuariosCache.length === 0) {
                try { await loadUsuariosList(); } catch(_) {}
            }
            populateLogUserSelect();
            await renderLogsTab();
        }

        async function enrichTipoOSForLogs(logs) {
            try {
                const map = new Map();
                ['externa','interna','garantia'].forEach(t => {
                    (osData[t] || []).forEach(os => {
                        const n = os['Numero OS'];
                        if (n) map.set(String(n), os.Tipo || null);
                    });
                });
                const missing = Array.from(new Set((logs || [])
                    .filter(l => (!l.tipo_os || l.tipo_os === '') && (l.nro_os || l.os_id))
                    .map(l => ({ nro: String(l.nro_os || ''), osId: l.os_id || null }))));
                const needByNumero = missing.filter(m => m.nro && !map.has(m.nro)).map(m => m.nro);
                const needById = missing.filter(m => m.osId).map(m => m.osId);
                if (missing.length && typeof supabase !== 'undefined') {
                    // Consulta por N√∫mero OS (tentando convers√£o num√©rica para evitar incompatibilidade de tipos)
                    for (let i = 0; i < needByNumero.length; i += OS_TIPO_CHUNK) {
                        const chunk = needByNumero.slice(i, i + OS_TIPO_CHUNK);
                        const numeric = chunk.map(v => { const n = Number(v); return isNaN(n) ? null : n; }).filter(v => v !== null);
                        let dataNum = [];
                        if (numeric.length) {
                            const { data: d1 } = await supabase.from(tabelaBase).select('Numero OS, Tipo').in('Numero OS', numeric);
                            dataNum = d1 || [];
                        }
                        const { data: d2 } = await supabase.from(tabelaBase).select('Numero OS, Tipo').in('Numero OS', chunk);
                        const combined = [...(dataNum || []), ...(d2 || [])];
                        (combined || []).forEach(os => {
                            const n = String(os['Numero OS'] || '');
                            if (n) map.set(n, os.Tipo || null);
                        });
                    }
                    // Consulta por Cahve (os_id) quando dispon√≠vel
                    for (let i = 0; i < needById.length; i += OS_TIPO_CHUNK) {
                        const chunkIds = needById.slice(i, i + OS_TIPO_CHUNK);
                    const { data: d3 } = await supabase.from(tabelaBase).select('Chave, Numero OS, Tipo').in('Chave', chunkIds);
                        (d3 || []).forEach(os => {
                            const n = String(os['Numero OS'] || '');
                            if (n) map.set(n, os.Tipo || null);
                        });
                    }
                }
                const enriched = (logs || []).map(l => {
                    if (!l.tipo_os || l.tipo_os === '') {
                        const tipo = map.get(String(l.nro_os || '')) || null;
                        if (tipo) l.tipo_os = tipo;
                    }
                    return l;
                });
                try {
                    if (typeof supabase !== 'undefined') {
                        const toUpdate = enriched.filter(l => l.os_id && l.tipo_os);
                        const batch = toUpdate.slice(0, 100);
                        for (const u of batch) {
                            const upd = { [COL_TIPO_OS_DB]: u.tipo_os };
                            await supabase.from(TABELA_STATUS_LOGS).update(upd).eq('os_id', u.os_id);
                        }
                    }
                } catch(_) {}
                return enriched;
            } catch(_) {
                return logs;
            }
        }

        async function renderLogsTab() {
            console.log('DEBUG: renderLogsTab chamada');
            try {
                const needsAll = !osData.externa.length || !osData.interna.length || !osData.garantia.length;
                if (needsAll && typeof supabase !== 'undefined') {
                    try { setTimeout(() => { try { refreshAllTabsDataLite(); } catch(_) {} }, 0); } catch(e) { }
                }
                const modeEl = document.getElementById('log-range-mode');
                const usuarioEl = document.getElementById('log-user-select');
                
                if (!modeEl || !usuarioEl) {
                    console.error('DEBUG: Elementos de filtro n√£o encontrados');
                    return;
                }
                
                const mode = modeEl.value || 'mes_atual';
                let from = null, to = null;
                if (mode === 'mes_atual') {
                    const r = getCurrentMonthRange();
                    from = r.from; to = r.to;
                } else if (mode !== 'todos') {
                    const r = getMonthRangeByName(mode);
                    if (r) { from = r.from; to = r.to; }
                }
                const usuario = usuarioEl.value || '__all__';
                const params = { from, to, usuario };

                console.log('DEBUG: Filtros - modo:', mode, 'from:', from, 'to:', to, 'usuario:', usuario);

                logsOffset = 0;
                logsHasMore = true;
                let statusLogs = await fetchStatusLogs({ ...params, offset: logsOffset, pageSize: LOGS_PAGE_SIZE });
                console.log('DEBUG: Logs recebidos:', statusLogs?.length, 'registros');
                
                // Log dos registros para debug
                if (statusLogs && statusLogs.length > 0) {
                    console.log('DEBUG: Todos os logs encontrados:', statusLogs);
                }

                // Resumo
                const resumoEl = document.getElementById('log-summary-text');
                if (resumoEl) {
                    // Distintos N¬∫ OS alterados no per√≠odo (com base nos logs)
                    const changedSet = new Set((statusLogs || []).map(l => l.nro_os).filter(Boolean));
                    const totalAlt = changedSet.size;
                    const userLabel = usuario === '__all__' ? 'Todos os usu√°rios' : `Usu√°rio: ${usuario}`;
                    resumoEl.textContent = `${userLabel} | Altera√ß√µes no per√≠odo: ${totalAlt}`;
                }

                // Tabela
                const tbody = document.getElementById('log-status-tbody');
                if (tbody) {
                    logsFullData = Array.isArray(statusLogs) ? statusLogs : [];
                    logsRenderedCount = 0;
                    renderLogsChunk(false);
                    // Enriquecimento de Tipo OS em paralelo, seguido de re-render leve
                    try {
                        Promise.resolve().then(async () => {
                            const enriched = await enrichTipoOSForLogs(logsFullData);
                            if (Array.isArray(enriched)) {
                                logsFullData = enriched;
                                renderLogsChunk(false);
                            }
                        });
                    } catch(_) {}
                }

                // Gr√°fico por dia (apenas altera√ß√µes)
                const aggAlt = Array.isArray(statusLogs) ? aggregateByDay(statusLogs) : [];
                const dias = aggAlt.length ? aggAlt.map(a=>a[0]).sort((a,b)=> a > b ? 1 : -1) : [];
                const diasLabel = dias.map(formatDayLabelBR);
                const dataAlt = dias.length ? dias.map(d => (aggAlt.find(a=>a[0]===d)?.[1] || 0)) : [];

                setTimeout(() => { updateProductivityCardsQuick(statusLogs, usuario, from, to).catch(()=>{}); }, 0);
                setTimeout(() => { updateProductivityCards(statusLogs, [], usuario, from, to).catch(()=>{}); }, 0);

                // Novo card: Logins por Usu√°rio (todos os usu√°rios n√£o-admin, com 0 quando n√£o houve login)
                const cardLogins = document.getElementById('card-logins-por-usuario');
                if (cardLogins) {
                    const sessions = await fetchUserSessions({ from, to, usuario: null });
                    const adminSet = new Set(((usuariosCache || []).filter(u => (u.tipo_usuario || '').toLowerCase() === 'administrador' || u.is_admin).flatMap(u => [String(u.usuario || '').toLowerCase(), String(u.nome_completo || '').toLowerCase()])).filter(v => v));
                    const agg = {};
                    (sessions || []).forEach(s => {
                        const usrKey = String(s.usuario || s.nome_completo || '').toLowerCase();
                        if (!usrKey || adminSet.has(usrKey) || usrKey === 'thiago.carmo') return;
                        const dur = Number(s.duration_seconds || (s.logout_at && s.login_at ? (new Date(s.logout_at) - new Date(s.login_at)) / 1000 : 0)) || 0;
                        if (!agg[usrKey]) agg[usrKey] = { count: 0, duration: 0, nome: s.nome_completo || s.usuario || '‚Äî' };
                        agg[usrKey].count += 1;
                        agg[usrKey].duration += Math.max(0, Math.round(dur));
                    });
                    const nonAdminUsers = (usuariosCache && usuariosCache.length) ? usuariosCache.filter(u => (u.tipo_usuario || '').toLowerCase() !== 'administrador' && !adminSet.has(String(u.usuario || u.nome_completo || '').toLowerCase())) : [];
                    const seen = new Set();
                    const merged = [];
                    nonAdminUsers.forEach(u => {
                        const key = String(u.usuario || u.nome_completo || '').toLowerCase();
                        const base = agg[key] || { count: 0, duration: 0, nome: u.nome_completo || u.usuario || '‚Äî' };
                        merged.push({ nome: u.nome_completo || u.usuario || '‚Äî', count: base.count, duration: base.duration });
                        seen.add(key);
                    });
                    Object.keys(agg).forEach(key => {
                        if (seen.has(key)) return;
                        const item = agg[key];
                        merged.push({ nome: item.nome, count: item.count, duration: item.duration });
                    });
                    const sorted = merged.sort((a,b) => b.count - a.count || b.duration - a.duration || a.nome.localeCompare(b.nome));
                    const listEl = cardLogins.querySelector('#logins-por-usuario-list');
                    if (listEl) {
                        listEl.innerHTML = sorted.length
                            ? sorted.map(item => `<div class="login-item" style="display:flex; justify-content:space-between; gap:8px;"><span class="login-name">${item.nome}</span><span class="login-count">${item.count}</span><span class="login-duration" style="color:#666;">${formatHHMM(item.duration)}</span></div>`).join('')
                            : '<div class="empty-state">Sem usu√°rios carregados</div>';
                    }
                }

                const valueLabelsPlugin = {
                    id: 'valueLabels',
                    afterDatasetsDraw(chart) {
                        const { ctx } = chart;
                        const horizontal = chart.options.indexAxis === 'y';
                        ctx.save();
                        chart.data.datasets.forEach((dataset, di) => {
                            const meta = chart.getDatasetMeta(di);
                            meta.data.forEach((bar, i) => {
                                const v = dataset.data[i];
                                if (v == null) return;
                                const pos = bar.tooltipPosition();
                                ctx.fillStyle = '#333';
                                ctx.font = '12px sans-serif';
                                ctx.textAlign = horizontal ? 'left' : 'center';
                                ctx.textBaseline = horizontal ? 'middle' : 'bottom';
                                const x = horizontal ? (pos.x + 6) : pos.x;
                                const y = horizontal ? pos.y : (pos.y - 6);
                                ctx.fillText(String(v), x, y);
                            });
                        });
                        ctx.restore();
                    }
                };

                const canvas = document.getElementById('chart-logs-status');
                if (canvas && typeof Chart !== 'undefined') {
                    const minWidth = Math.max(900, (dias || []).length * 60);
                    const wrapper = canvas.parentElement;
                    if (wrapper) {
                        wrapper.style.width = '100%';
                    }
                    canvas.style.width = minWidth + 'px';
                    canvas.style.height = '100%';
                    const existing = Chart.getChart('chart-logs-status');
                    if (existing) existing.destroy();
                    new Chart(canvas, {
                        type: 'bar',
                        data: {
                            labels: diasLabel,
                            datasets: [
                                { label: 'Altera√ß√µes', data: dataAlt, backgroundColor: '#fd7e14' }
                            ]
                        },
                        plugins: [valueLabelsPlugin],
                        options: {
                            maintainAspectRatio: false,
                            responsive: true,
                            plugins: {
                                legend: { position: 'top' },
                                title: { display: true, text: 'Altera√ß√µes di√°rias de status' },
                                tooltip: {
                                    enabled: true,
                                    callbacks: {
                                        label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y}`
                                    }
                                }
                            },
                            interaction: { mode: 'index', intersect: false },
                            scales: { x: { stacked: false }, y: { beginAtZero: true } }
                        }
                    });
                }

                const canvasUsers = document.getElementById('chart-logs-por-usuario');
                if (canvasUsers && typeof Chart !== 'undefined') {
                    const aggUsers = {};
                    (statusLogs || []).forEach(l => {
                        const name = l.nome_completo || l.usuario || '‚Äî';
                        aggUsers[name] = (aggUsers[name] || 0) + 1;
                    });
                    const sortedUsers = Object.entries(aggUsers).sort((a,b) => b[1] - a[1] || a[0].localeCompare(b[0]));
                    const topUsers = sortedUsers.slice(0, 12);
                    const labelsUsers = topUsers.map(u => u[0]);
                    const dataUsers = topUsers.map(u => u[1]);
                    const existingUserChart = Chart.getChart('chart-logs-por-usuario');
                    if (existingUserChart) existingUserChart.destroy();
                    new Chart(canvasUsers, {
                        type: 'bar',
                        data: {
                            labels: labelsUsers,
                            datasets: [
                                { label: 'Altera√ß√µes por usu√°rio', data: dataUsers, backgroundColor: '#6f42c1' }
                            ]
                        },
                        plugins: [valueLabelsPlugin],
                        options: {
                            maintainAspectRatio: false,
                            indexAxis: 'y',
                            responsive: true,
                            plugins: {
                                legend: { position: 'top' },
                                title: { display: true, text: 'Altera√ß√µes por usu√°rio' },
                                tooltip: {
                                    enabled: true,
                                    callbacks: {
                                        label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.x}`
                                    }
                                }
                            },
                            interaction: { mode: 'index', intersect: false },
                            scales: { x: { beginAtZero: true } }
                        }
                    });
                }
            } catch (e) {
                console.error('Erro ao renderizar a aba de logs:', e);
                const resumoEl = document.getElementById('log-summary-text');
                if (resumoEl) resumoEl.textContent = 'Erro ao carregar logs.';
            }
        }

        // Fun√ß√£o para atualizar os cards de produtividade
        async function updateProductivityCards(statusLogs, pageVisits, usuario, from, to) {
            try {
                let comAlteracao = 0;
                let semAlteracao = 0;
                let total = 0;
                
                // Se um usu√°rio espec√≠fico foi selecionado, filtrar as OS por usu√°rio
                if (usuario && usuario !== '__all__') {
                    // Criar um conjunto de OS que foram alteradas pelo usu√°rio selecionado
                    const osAlteradasPeloUsuario = new Set();
                    
                    // Percorrer os logs de status para encontrar as OS alteradas pelo usu√°rio
                    (statusLogs || []).forEach(log => {
                        if (log.nro_os && (log.usuario === usuario || log.nome_completo === usuario)) {
                            osAlteradasPeloUsuario.add(log.nro_os);
                        }
                    });
                    
                    // Contar apenas as OS que foram alteradas pelo usu√°rio selecionado
                    ['externa', 'interna', 'garantia'].forEach(tab => {
                        (osData[tab] || []).forEach(os => {
                            const numeroOS = os['Numero OS'] || '';
                            
                            // Verificar se esta OS foi alterada pelo usu√°rio selecionado
                            if (osAlteradasPeloUsuario.has(numeroOS)) {
                                const observacao = os['Observacao'] || '';
                                
                                // Extrair status real da observa√ß√£o (formato: [Status: NomeDoStatus])
                                let statusReal = 'Sem Status';
                                const statusMatch = observacao.match(/\[Status:\s*(.*?)\]/);
                                if (statusMatch && statusMatch[1]) {
                                    statusReal = statusMatch[1].trim();
                                }
                                
                                if (statusReal !== 'Sem Status') {
                                    comAlteracao++;
                                } else {
                                    semAlteracao++;
                                }
                                total++;
                            }
                        });
                    });
                } else {
                    // Se nenhum usu√°rio espec√≠fico foi selecionado, contar todas as OS
                    ['externa', 'interna', 'garantia'].forEach(tab => {
                        (osData[tab] || []).forEach(os => {
                            const observacao = os['Observacao'] || '';
                            
                            // Extrair status real da observa√ß√£o (formato: [Status: NomeDoStatus])
                            let statusReal = 'Sem Status';
                            const statusMatch = observacao.match(/\[Status:\s*(.*?)\]/);
                            if (statusMatch && statusMatch[1]) {
                                statusReal = statusMatch[1].trim();
                            }
                            
                            if (statusReal !== 'Sem Status') {
                                comAlteracao++;
                            } else {
                                semAlteracao++;
                            }
                            total++;
                        });
                    });
                }
                
                const percentualProcessado = total > 0 ? Math.round((comAlteracao / total) * 100) : 0;
                
                let visitasUsuario = 0;
                let tempoTotalSeg = 0;
                try {
                    const sessionsAll = await fetchUserSessions({ from, to, usuario: null });
                    const adminSet = new Set(((usuariosCache || []).filter(u => (u.tipo_usuario || '').toLowerCase() === 'administrador' || u.is_admin).flatMap(u => [String(u.usuario || '').toLowerCase(), String(u.nome_completo || '').toLowerCase()])).filter(v => v));
                    const filtered = (sessionsAll || []).filter(s => {
                        const usr = String(s.usuario || s.nome_completo || '').toLowerCase();
                        return usr && !adminSet.has(usr) && usr !== 'thiago.carmo';
                    });
                    visitasUsuario = filtered.length;
                    tempoTotalSeg = filtered.reduce((acc, s) => {
                        const dur = Number(s.duration_seconds || (s.logout_at && s.login_at ? (new Date(s.logout_at) - new Date(s.login_at)) / 1000 : 0)) || 0;
                        return acc + Math.max(0, Math.round(dur));
                    }, 0);
                } catch (e) {
                    visitasUsuario = 0;
                    tempoTotalSeg = 0;
                }
                
                // Atualizar os cards
                document.getElementById('card-os-alteradas').querySelector('div:nth-child(2)').textContent = comAlteracao;
                document.getElementById('card-os-sem-alteracao').querySelector('div:nth-child(2)').textContent = semAlteracao;
                document.getElementById('card-percentual-processado').querySelector('div:nth-child(2)').textContent = percentualProcessado + '%';
                const cardVis = document.getElementById('card-visitas-usuario');
                cardVis.querySelector('div:nth-child(2)').textContent = visitasUsuario;
                const tempoFmt = formatHHMM(tempoTotalSeg);
                cardVis.querySelector('div:nth-child(3)').textContent = 'tempo logado: ' + tempoFmt;
                
            } catch (e) {
                console.error('Erro ao atualizar cards de produtividade:', e);
            }
        }

        async function updateProductivityCardsQuick(statusLogs, usuario, from, to) {
            try {
                const changedSet = new Set((statusLogs || []).map(l => l.nro_os).filter(Boolean));
                const comAlteracao = changedSet.size;
                const semAlteracao = 0;
                const percentualProcessado = comAlteracao > 0 ? 100 : 0;
                let visitasUsuario = 0;
                let tempoTotalSeg = 0;
                try {
                    const sessionsAll = await fetchUserSessions({ from, to, usuario: null });
                    const adminSet = new Set(((usuariosCache || []).filter(u => (u.tipo_usuario || '').toLowerCase() === 'administrador' || u.is_admin).flatMap(u => [String(u.usuario || '').toLowerCase(), String(u.nome_completo || '').toLowerCase()])).filter(v => v));
                    const filtered = (sessionsAll || []).filter(s => {
                        const usr = String(s.usuario || s.nome_completo || '').toLowerCase();
                        return usr && !adminSet.has(usr) && usr !== 'thiago.carmo';
                    });
                    visitasUsuario = filtered.length;
                    tempoTotalSeg = filtered.reduce((acc, s) => {
                        const dur = Number(s.duration_seconds || (s.logout_at && s.login_at ? (new Date(s.logout_at) - new Date(s.login_at)) / 1000 : 0)) || 0;
                        return acc + Math.max(0, Math.round(dur));
                    }, 0);
                } catch (e) {}
                document.getElementById('card-os-alteradas').querySelector('div:nth-child(2)').textContent = comAlteracao;
                document.getElementById('card-os-sem-alteracao').querySelector('div:nth-child(2)').textContent = semAlteracao;
                document.getElementById('card-percentual-processado').querySelector('div:nth-child(2)').textContent = percentualProcessado + '%';
                const cardVis = document.getElementById('card-visitas-usuario');
                cardVis.querySelector('div:nth-child(2)').textContent = visitasUsuario;
                const tempoFmt = formatHHMM(tempoTotalSeg);
                cardVis.querySelector('div:nth-child(3)').textContent = 'tempo logado: ' + tempoFmt;
            } catch (e) {}
        }

        async function refreshAllTabsDataLite() {
            try {
                const { data, error } = await supabase.from(tabelaBase).select('Numero OS, Observacao, Emissao, Situacao OS, Tipo, Revenda');
                if (error) throw error;
                const all = data || [];
                osData.externa = all.filter(d => d.Tipo === 'Externa');
                osData.interna = all.filter(d => d.Tipo === 'Interna');
                osData.garantia = all.filter(d => d.Tipo === 'Garantia');
            } catch (e) {}
        }

        function renderLogsChunk(append) {
            const tbody = document.getElementById('log-status-tbody');
            if (!tbody) return;
            const html = (logsFullData || []).map(l => {
                const dt = new Date(l.created_at);
                const dh = dt.toLocaleString('pt-BR');
                return `<tr><td>${dh}</td><td>${l.nome_completo || l.usuario}</td><td>${l.nro_os || ''}</td><td>${l.revenda || ''}</td><td>${l.tipo_os || ''}</td><td>${l.status_anterior || ''}</td><td>${l.status_novo || ''}</td></tr>`;
            }).join('');
            tbody.innerHTML = html;
            logsRenderedCount = logsFullData.length;
            updateLogsLoadMore();
        }

        function updateLogsLoadMore() {
            const btn = document.getElementById('btn-logs-load-more');
            if (!btn) return;
            btn.disabled = logsRenderedCount >= logsFullData.length;
            btn.style.display = logsRenderedCount >= logsFullData.length ? 'none' : 'inline-block';
        }

        // --- Atualizar Valores (CSV) ---
        function detectDelimiter(headerLine) {
            if (headerLine.includes(';')) return ';';
            if (headerLine.includes(',')) return ',';
            return ';';
        }

        function normalizeNumberBR(value) {
            if (value === undefined || value === null) return null;
            if (typeof value === 'number') return value;
            let s = String(value).trim();
            if (!s) return null;
            s = s.replace(/^R\$\s*/i, '');
            s = s.replace(/\./g, '').replace(/,/g, '.');
            const n = parseFloat(s);
            return isNaN(n) ? null : n;
        }

        function validateCSVHeaders(headers) {
            const hasKey = CSV_VAL_KEY_FIELDS.some(k => headers.includes(k));
            const missing = CSV_VAL_REQUIRED.filter(h => !headers.includes(h));
            const issues = [];
            if (!hasKey) issues.push('CSV deve conter "Chave" ou "Numero OS".');
            if (missing.length) issues.push('Colunas ausentes: ' + missing.join(', '));
            return { ok: hasKey && missing.length === 0, issues, missing };
        }

        function parseCSVText(text) {
            const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
            if (lines.length === 0) return { headers: [], rows: [] };
            const delim = detectDelimiter(lines[0]);
            const headers = lines[0].split(delim).map(h => h.trim());
            const rows = lines.slice(1).map(line => {
                const parts = line.split(delim);
                const obj = {};
                headers.forEach((h, idx) => obj[h] = (parts[idx] ?? '').trim());
                return obj;
            });
            return { headers, rows };
        }

        function showCSVResumo(message, detailsHtml = '') {
            const resumoEl = document.getElementById('csv-valores-resumo');
            const detalhesEl = document.getElementById('csv-valores-detalhes');
            if (resumoEl) resumoEl.textContent = message;
            if (detalhesEl) detalhesEl.innerHTML = detailsHtml;
        }

        async function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsText(file, 'utf-8');
            });
        }

        // --- Importa√ß√£o de Dados ---
        const IMPORT_EXPECTED_HEADERS = [
            'Chave','Cahve','Tipo','Revenda','Numero OS','Situacao OS','Tipo OS','Emissao','Dias','Cliente','Chassi','Modelo','Descricao Modelo','Consultor','Observacao','Total Pecas','Total Servico','Total OS','Acao / Atualizacao','status','Status'
        ];
        let importPreviewState = { headers: [], rows: [], valid: [], duplicates: [], existingPairs: new Set() };

        function mapImportHeaders(headers) {
            const map = {};
            const canon = (s) => String(s||'').trim().replace(/\s+/g,' ').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
            const toCanonical = (k) => {
                const nk = canon(k);
                if (nk === 'chave' || nk === 'cahve') return 'Chave';
                if (nk === 'status') return 'status';
                if (nk === 'numero os' || nk === 'nro os' || nk === 'nro. os' || nk === 'no os' || nk === 'num os') return 'Numero OS';
                if (nk === 'situacao os') return 'Situacao OS';
                if (nk === 'tipo os') return 'Tipo OS';
                if (nk === 'revenda') return 'Revenda';
                if (nk === 'cliente') return 'Cliente';
                if (nk === 'chassi') return 'Chassi';
                if (nk === 'modelo') return 'Modelo';
                if (nk === 'descricao modelo') return 'Descricao Modelo';
                if (nk === 'consultor' || nk === 'consultor responsavel') return 'Consultor';
                if (nk === 'observacao' || nk === 'observacoes' || nk === 'obs' || nk === 'observacao os' || nk === 'observacoes os') return 'Observacao';
                if (nk === 'total pecas') return 'Total Pecas';
                if (nk === 'total servico') return 'Total Servico';
                if (nk === 'total os' || nk === 'total o.s' || nk === 'total o s') return 'Total OS';
                if (nk === 'acao / atualizacao' || nk === 'acao/atualizacao' || nk === 'acao-atualizacao') return 'Acao / Atualizacao';
                if (nk === 'emissao') return 'Emissao';
                if (nk === 'dias') return 'Dias';
                if (nk === 'tipo') return 'Tipo';
                return String(k||'').trim();
            };
            headers.forEach(h => { map[h] = toCanonical(h); });
            return map;
        }
        function normalizeImportRow(row, headerMap) {
            const obj = {};
            Object.keys(row).forEach(orig => {
                const target = headerMap[orig] || orig;
                // N√£o sobrescreve "Tipo" com "Tipo OS" caso ambas existam
                if (target === 'Tipo' && typeof obj[target] !== 'undefined' && orig !== 'Tipo') {
                    return;
                }
                obj[target] = row[orig];
            });
            if (obj.Revenda) {
                const code = getRevendaCode(obj.Revenda);
                obj.Revenda = code || obj.Revenda;
            }
            return obj;
        }
        function renderImportLists(valid, duplicates) {
            const mkTable = (list) => {
                if (!list.length) return '<div class="empty-state">Nenhum registro</div>';
                const cols = ['Chave','Tipo','Revenda','Numero OS','Situacao OS','Emissao','Dias','Cliente','Chassi','Modelo','Descricao Modelo','Consultor','Observacao','Total Pecas','Total Servico','Total OS','Acao / Atualizacao','status'];
                const thead = '<thead><tr>' + cols.map(c => `<th>${c}</th>`).join('') + '</tr></thead>';
                const rows = list.map(r => {
                    const rowObj = {
                        'Chave': r.Chave||r.Cahve||'',
                        'Tipo': r.Tipo||r['Tipo OS']||'',
                        'Revenda': r.Revenda||'',
                        'Numero OS': r['Numero OS']||'',
                        'Situacao OS': r['Situacao OS']||'',
                        'Emissao': r.Emissao||'',
                        'Dias': r.Dias||'',
                        'Cliente': r.Cliente||'',
                        'Chassi': r.Chassi||'',
                        'Modelo': r.Modelo||'',
                        'Descricao Modelo': r['Descricao Modelo']||'',
                        'Consultor': r.Consultor||'',
                        'Observacao': r.Observacao||'',
                        'Total Pecas': r['Total Pecas']||'',
                        'Total Servico': r['Total Servico']||'',
                        'Total OS': r['Total OS']||'',
                        'Acao / Atualizacao': r['Acao / Atualizacao']||'',
                        'status': r.Status||r.status||''
                    };
                    return '<tr>' + cols.map(c => `<td>${rowObj[c] ?? ''}</td>`).join('') + '</tr>';
                }).join('');
                return `<table><tbody>${thead}${rows}</tbody></table>`;
            };
            const vEl = document.getElementById('import-list-valid');
            const dEl = document.getElementById('import-list-duplicadas');
            if (vEl) vEl.innerHTML = mkTable(valid);
            if (dEl) dEl.innerHTML = mkTable(duplicates);
        }
        function setImportResumo(text, details = '') {
            const r = document.getElementById('import-resumo');
            const d = document.getElementById('import-detalhes');
            if (r) r.textContent = text;
            if (d) d.innerHTML = details;
        }
        async function handleImportParse() {
            try {
                const fileInput = document.getElementById('import-csv-file');
                const pasteEl = document.getElementById('import-paste');
                let text = '';
                if (fileInput && fileInput.files && fileInput.files.length) {
                    text = await readFileAsText(fileInput.files[0]);
                } else {
                    text = pasteEl ? pasteEl.value : '';
                }
                if (!text || !text.trim()) { setImportResumo('Nenhum dado para validar.'); return; }
                const parsed = parseCSVText(text);
                importPreviewState.headers = parsed.headers;
                importPreviewState.rows = parsed.rows;
                const headerMap = mapImportHeaders(parsed.headers);
                const normalized = parsed.rows.map(r => normalizeImportRow(r, headerMap));
                // normaliza√ß√µes auxiliares
                const normTipo = v => String(v||'').trim().toLowerCase();
                const normRev = v => String(v||'').trim();
                const normOS = v => String(v||'').trim();
                const normCh = v => String(v||'').trim();

                // mant√©m apenas registros com Cahve+Tipo ou Revenda+Tipo+Numero OS presentes
                const withKeys = normalized.filter(r => (
                    (normCh(r.Chave||r.Cahve).length && normTipo(r.Tipo).length) ||
                    (normRev(r.Revenda).length && normTipo(r.Tipo).length && normOS(r['Numero OS']).length)
                ));

                // dedupe interno (arquivo) por dois crit√©rios: Cahve+Tipo OU Revenda+Tipo+Numero OS
                const seenCT = new Set();
                const seenRTN = new Set();
                const uniques = [];
                const internalDups = [];
                withKeys.forEach(r => {
                    const kCT = `${normCh(r.Chave||r.Cahve)}|${normTipo(r.Tipo)}`;
                    const kRTN = `${normRev(r.Revenda)}|${normTipo(r.Tipo)}|${normOS(r['Numero OS'])}`;
                    const isDup = (kCT && seenCT.has(kCT)) || (kRTN && seenRTN.has(kRTN));
                    if (isDup) internalDups.push(r); else {
                        if (kCT) seenCT.add(kCT);
                        if (kRTN) seenRTN.add(kRTN);
                        uniques.push(r);
                    }
                });

                // busca existentes na Base por Cahve e tamb√©m por Revenda+Tipo+Numero OS
                // usamos principalmente Revenda+Tipo+Numero OS para dedupe; Cahve √© opcional
                const osRevList = uniques
                    .filter(r => normRev(r.Revenda) && normOS(r['Numero OS']) && normTipo(r.Tipo))
                    .map(r => ({ Revenda: normRev(r.Revenda), 'Numero OS': normOS(r['Numero OS']), Tipo: r.Tipo }));

                let existingCT = new Set();
                let existingRTN = new Set();
                // removido: consulta por Cahve para evitar erro 400; mantemos dedupe por Revenda+Tipo+Numero OS
                // consulta por Revenda+Tipo+Numero OS
                if (osRevList.length) {
                    const numeros = Array.from(new Set(osRevList.map(x => x['Numero OS']).filter(Boolean)));
                    const { data: existRTN } = await supabase.from(tabelaBase).select('Revenda, Tipo, "Numero OS"').in('Numero OS', numeros);
                    (existRTN||[]).forEach(e => {
                        existingRTN.add(`${normRev(e.Revenda)}|${normTipo(e.Tipo)}|${normOS(e['Numero OS'])}`);
                    });
                }
                importPreviewState.existingPairs = new Set([...existingCT, ...existingRTN]);

                const valid = uniques.filter(r => {
                    const kCT = `${normCh(r.Chave||r.Cahve)}|${normTipo(r.Tipo)}`;
                    const kRTN = `${normRev(r.Revenda)}|${normTipo(r.Tipo)}|${normOS(r['Numero OS'])}`;
                    const exists = (kCT && existingCT.has(kCT)) || (kRTN && existingRTN.has(kRTN));
                    return !exists;
                });
                const duplicates = uniques.filter(r => {
                    const kCT = `${normCh(r.Chave||r.Cahve)}|${normTipo(r.Tipo)}`;
                    const kRTN = `${normRev(r.Revenda)}|${normTipo(r.Tipo)}|${normOS(r['Numero OS'])}`;
                    const exists = (kCT && existingCT.has(kCT)) || (kRTN && existingRTN.has(kRTN));
                    return exists;
                }).concat(internalDups);
                importPreviewState.valid = valid;
                importPreviewState.duplicates = duplicates;
                setImportResumo(`Lidas: ${parsed.rows.length}. Com chave/tipo ou revenda/tipo/nro: ${withKeys.length}. V√°lidas: ${valid.length}. Duplicatas: ${duplicates.length}.`,
                    `<div class="info">Duplicidade avaliada por "Chave+Tipo" e por "Revenda+Tipo+Numero OS" contra arquivo e Base.</div>`);
                renderImportLists(valid, duplicates);
                const btnSave = document.getElementById('btn-save-import');
                const btnClear = document.getElementById('btn-clear-import');
                if (btnSave) btnSave.disabled = valid.length === 0;
                if (btnClear) btnClear.disabled = (parsed.rows.length === 0);
            } catch (e) {
                setImportResumo('Erro ao validar dados.', `<div class="error">${e?.message || 'Erro'}</div>`);
            }
        }
        function clearImportPreview() {
            importPreviewState = { headers: [], rows: [], valid: [], duplicates: [], existingPairs: new Set() };
            setImportResumo('Aguardando arquivo ou colagem.');
            renderImportLists([], []);
            const btnSave = document.getElementById('btn-save-import');
            const btnClear = document.getElementById('btn-clear-import');
            if (btnSave) btnSave.disabled = true;
            if (btnClear) btnClear.disabled = true;
        }
        async function handleImportSave() {
            try {
                const items = importPreviewState.valid || [];
                if (!items.length) { setImportResumo('Nada para salvar.'); return; }
                const ALLOWED_COLS = new Set(['Chave','Tipo','Revenda','Numero OS','Situacao OS','Emissao','Dias','Cliente','Chassi','Modelo','Descricao Modelo','Consultor','Observacao','Total Pecas','Total Servico','Total OS','Acao / Atualizacao','status']);
                function buildImportPayload(r) {
                    const p = {};
                    Object.keys(r).forEach(k => { if (ALLOWED_COLS.has(k)) p[k] = r[k]; });
                    if (!p.Tipo && r['Tipo OS']) p.Tipo = String(r['Tipo OS']).trim();
                    // Normaliza chave de status para min√∫sculas
                    if (p.Status !== undefined && p.status === undefined) {
                        p.status = String(p.Status || '').trim();
                        delete p.Status;
                    }
                    // Revenda c√≥digo
                    if (p.Revenda != null) {
                        const code = getRevendaCode(String(p.Revenda)) || String(p.Revenda).trim();
                        const iv = parseInt(code, 10);
                        p.Revenda = isNaN(iv) ? code : iv;
                    }
                    // Numero OS como string (evita erro de tipo na Base)
                    if (p['Numero OS'] != null) {
                        p['Numero OS'] = String(p['Numero OS']).trim();
                    }
                    // Chave como string (evita erro de tipo na Base)
                    if (p.Chave != null) {
                        p.Chave = String(p.Chave).trim();
                    }
                    // Dias inteiro (se informado)
                    let diasInformado = null;
                    if (p.Dias != null && String(p.Dias).trim() !== '') {
                        const di = parseInt(String(p.Dias).trim(), 10);
                        diasInformado = isNaN(di) ? null : di;
                    }
                    // Emissao: manter formato texto DD/MM/YYYY (compat√≠vel com Base_OS atual); se ausente, reconstruir via Dias
                    let emissaoBR = null;
                    if (p.Emissao != null && String(p.Emissao).trim() !== '') {
                        const d = parseDate(p.Emissao);
                        if (d && !isNaN(d.getTime())) emissaoBR = d.toLocaleDateString('pt-BR');
                        else emissaoBR = String(p.Emissao).trim();
                    }
                    if (!emissaoBR && diasInformado != null) {
                        const d = new Date();
                        d.setHours(0,0,0,0);
                        d.setDate(d.getDate() - Math.max(0, diasInformado));
                        emissaoBR = d.toLocaleDateString('pt-BR');
                    }
                    p.Emissao = emissaoBR;
                    // Dias final: se n√£o informado, calcula a partir de Emissao; caso contr√°rio mant√©m
                    if (diasInformado == null) {
                        const dcalc = p.Emissao ? calculateDaysRobust(p.Emissao) : 0;
                        p.Dias = dcalc;
                    } else {
                        p.Dias = diasInformado;
                    }
                    // Totais num√©ricos
                    if (p['Total Pecas'] != null) p['Total Pecas'] = normalizeNumberBR(p['Total Pecas']);
                    if (p['Total Servico'] != null) p['Total Servico'] = normalizeNumberBR(p['Total Servico']);
                    if (p['Total OS'] != null) p['Total OS'] = normalizeNumberBR(p['Total OS']);
                    // Status normalizado capitalizado b√°sico
                    if (p.status == null || String(p.status).trim() === '') p.status = 'Sem Status';
                    else p.status = String(p.status).trim();
                    // Observacao e Acao / Atualizacao strings
                    if (p.Observacao != null) p.Observacao = String(p.Observacao);
                    if (p['Acao / Atualizacao'] != null) p['Acao / Atualizacao'] = String(p['Acao / Atualizacao']);
                    // Cliente, Chassi, Modelo, Descricao Modelo, Consultor strings
                    ['Cliente','Chassi','Modelo','Descricao Modelo','Consultor','Situacao OS','Tipo'].forEach(f => { if (p[f] != null) p[f] = String(p[f]).trim(); });
                    if (!p['Situacao OS']) p['Situacao OS'] = 'Aberta';
                    // remove apenas campos nulos (mant√©m strings vazias)
                    Object.keys(p).forEach(k => { if (p[k] === null) delete p[k]; });
                    return p;
                }
                const payloads = items.map(buildImportPayload);
                const REQUIRED = ['Tipo','Revenda','Numero OS','Emissao'];
                const validPayloads = payloads.filter(p => REQUIRED.every(k => p[k] !== undefined && p[k] !== null && String(p[k]).trim() !== ''));
                const invalidCount = payloads.length - validPayloads.length;
                let ok = 0, err = 0;
                const chunkSize = 250;
                for (let i = 0; i < items.length; i += chunkSize) {
                    const chunk = validPayloads.slice(i, i + chunkSize);
                    const resp = await insertRowsMinimal(tabelaBase, chunk);
                    if (resp !== true) {
                        // fallback linha a linha para identificar registros problem√°ticos
                        for (const row of chunk) {
                            const one = await insertRowsMinimal(tabelaBase, [row]);
                            if (one === true) ok += 1; else err += 1;
                        }
                    } else {
                        ok += chunk.length;
                    }
                }
                setImportResumo(`Importa√ß√£o conclu√≠da. Sucesso: ${ok}. Falhas: ${err}. Ignorados por falta de campos: ${invalidCount}.`);
                clearImportPreview();
                try { await loadOSData(); } catch(_) {}
                try { await verificarTodosOsAlertas(true); } catch(_) {}
                try { setTimeout(() => { verificarTodosOsAlertas(true); }, 8000); } catch(_) {}
            } catch (e) {
                const msg = e?.message || e?.details || e?.hint || 'Erro';
                setImportResumo('Erro ao salvar na Base.', `<div class="error">${msg}</div>`);
            }
        }

        async function insertRowsMinimal(table, rows) {
            try {
                const { error } = await supabase.from(table).insert(rows);
                if (error) {
                    console.warn('Falha ao inserir chunk (supabase-js):', error, 'sample=', rows && rows.length ? rows[0] : {});
                    const msg = error?.message || error?.details || error?.hint || String(error);
                    const sample = rows && rows.length ? JSON.stringify(rows[0]) : '{}';
                    setImportResumo('Erro ao salvar na Base.', `<div class="error">${msg}<br><small>Exemplo de payload: ${sample}</small></div>`);
                    return false;
                }
                return true;
            } catch (e) {
                console.warn('Erro ao inserir (supabase-js):', e);
                setImportResumo('Erro ao salvar na Base.', `<div class="error">${e?.message || 'Erro de rede'}</div>`);
                return false;
            }
        }

        function getRevendaCode(revenda) {
            if (!revenda) return null;
            const code = revendasReverse[revenda] || null;
            return code || (['1','2','3','4'].includes(revenda) ? revenda : null);
        }

        function getRevendaName(revendaCode) {
            if (!revendaCode) return '';
            // Mapeamento inverso: c√≥digos para nomes
            const revendasMap = { '1': 'Recife', '2': 'Natal', '3': 'Fortaleza', '4': 'Petrolina' };
            return revendasMap[revendaCode] || revendaCode;
        }

        async function handleValidarCSVValores() {
            try {
                const input = document.getElementById('csv-valores-file');
                const btnAplicar = document.getElementById('btn-aplicar-csv-valores');
                if (!input || !input.files || input.files.length === 0) {
                    showCSVResumo('Nenhum arquivo carregado.');
                    if (btnAplicar) btnAplicar.disabled = true;
                    return;
                }
                const file = input.files[0];
                const text = await readFileAsText(file);
                const { headers, rows } = parseCSVText(text);
                const v = validateCSVHeaders(headers);
                csvValoresState = { records: rows, valid: v.ok, headers, issues: v.issues };
                if (!v.ok) {
                    showCSVResumo('CSV inv√°lido.', `<div class="error">${v.issues.join('<br>')}</div>`);
                    if (btnAplicar) btnAplicar.disabled = true;
                    return;
                }
                // Estat√≠sticas b√°sicas
                const withKey = rows.filter(r => CSV_VAL_KEY_FIELDS.some(k => r[k] && r[k].trim().length));
                const withValues = rows.filter(r => normalizeNumberBR(r['Total OS']) !== null || normalizeNumberBR(r['Total Pecas']) !== null || normalizeNumberBR(r['Total Servico']) !== null);
                showCSVResumo(`Registros lidos: ${rows.length}. Com chave: ${withKey.length}. Com valores: ${withValues.length}.`);
                if (btnAplicar) btnAplicar.disabled = rows.length === 0 || withValues.length === 0;
            } catch (e) {
                console.warn('Falha ao validar CSV:', e);
                showCSVResumo('Erro ao validar CSV. Verifique o arquivo.');
                const btnAplicar = document.getElementById('btn-aplicar-csv-valores');
                if (btnAplicar) btnAplicar.disabled = true;
            }
        }

        function findOSByNumeroTipo(numero, tipoLabel) {
            const tabs = ['externa','interna','garantia'];
            for (const tab of tabs) {
                const arr = osData[tab] || [];
                const item = arr.find(os => String(os['Numero OS']).trim() === String(numero).trim() && os.Tipo === tipoLabel);
                if (item) return item;
            }
            return null;
        }

        function updateLocalFromRecord(rec) {
            const totalOS = normalizeNumberBR(rec['Total OS']);
            const totalP = normalizeNumberBR(rec['Total Pecas']);
            const totalS = normalizeNumberBR(rec['Total Servico']);
            const applyTo = (os) => {
                if (!os) return false;
                if (totalP !== null) os['Total Pecas'] = totalP;
                if (totalS !== null) os['Total Servico'] = totalS;
                if (totalOS !== null) os['Total OS'] = totalOS;
                return true;
            };
            let updated = false;
            const keyField = CSV_VAL_KEY_FIELDS.find(k => rec[k] && rec[k].trim().length);
            if (keyField) {
                const os = findOSByKey(rec[keyField]);
                updated = applyTo(os);
            } else if (rec['Numero OS']) {
                const tipoLabel = rec['Tipo'] || null;
                const os = tipoLabel ? findOSByNumeroTipo(rec['Numero OS'], tipoLabel) : null;
                updated = applyTo(os);
            }
            return updated;
        }

        async function refreshAllTabsData() {
            try {
                const { data, error } = await supabase.from(tabelaBase).select('*');
                if (error) throw error;
                const all = data || [];
                osData.externa = all.filter(d => d.Tipo === 'Externa');
                osData.interna = all.filter(d => d.Tipo === 'Interna');
                osData.garantia = all.filter(d => d.Tipo === 'Garantia');
                ['externa','interna','garantia'].forEach(tab => { applySorting(tab); updateTotals(tab); });
                // Avalia aumento de contagem em todas as abas ap√≥s refresh
                ['externa','interna','garantia'].forEach(tab => {
                    evaluateIncreaseAndUpdateIndicators(tab, (osData[tab] || []).length);
                });
                loadDashboardData();
            } catch (e) {
                console.warn('Falha ao recarregar dados ap√≥s CSV:', e);
            }
        }

        async function applyCSVValueUpdates() {
            const btnAplicar = document.getElementById('btn-aplicar-csv-valores');
            if (btnAplicar) btnAplicar.disabled = true;
            const rows = csvValoresState.records || [];
            if (!rows.length) {
                showCSVResumo('Nada para aplicar. Valide o CSV primeiro.');
                return;
            }
            let updatedCount = 0, skippedCount = 0, errorCount = 0, notFoundCount = 0;
            for (const rec of rows) {
                const totalOS = normalizeNumberBR(rec['Total OS']);
                const totalP = normalizeNumberBR(rec['Total Pecas']);
                const totalS = normalizeNumberBR(rec['Total Servico']);
                if (totalOS === null && totalP === null && totalS === null) { skippedCount++; continue; }
                const updateData = {};
                if (totalP !== null) updateData['Total Pecas'] = totalP;
                if (totalS !== null) updateData['Total Servico'] = totalS;
                if (totalOS !== null) updateData['Total OS'] = totalOS;

                try {
                    const keyField = ['Chave','Numero OS'].find(k => rec[k] && String(rec[k]).trim().length);
                    let query = supabase.from(tabelaBase).update(updateData);
                    let matchApplied = false;
                    if (keyField) {
                        query = query.eq('Chave', rec[keyField]);
                        matchApplied = true;
                    } else if (rec['Numero OS']) {
                        query = query.eq('Numero OS', rec['Numero OS']);
                        if (rec['Tipo']) query = query.eq('Tipo', rec['Tipo']);
                        const revCode = getRevendaCode(rec['Revenda']);
                        if (revCode) query = query.eq('Revenda', revCode);
                        matchApplied = true;
                    }
                    if (!matchApplied) { skippedCount++; continue; }
                    const { data, error } = await query.select();
                    if (error) { errorCount++; continue; }
                    const affected = Array.isArray(data) ? data.length : 0;
                    if (affected > 0) {
                        updatedCount += affected;
                        updateLocalFromRecord(rec);
                    } else {
                        notFoundCount++;
                    }
                } catch (e) {
                    console.warn('Erro ao atualizar registro via Supabase:', e);
                    errorCount++;
                }
            }

            await refreshAllTabsData();
            setSuccessUpdateIndicator(new Date());
            showCSVResumo(`Atualiza√ß√£o conclu√≠da. Sucesso: ${updatedCount}. N√£o encontrados: ${notFoundCount}. Ignorados: ${skippedCount}. Erros: ${errorCount}.`);
            const btnValidar = document.getElementById('btn-validar-csv-valores');
            if (btnValidar) btnValidar.focus();
        }
        // --- ABA CADASTRAR USU√ÅRIOS ---
        async function loadUsuariosList() {
            try {
                const { data, error } = await supabase
                    .from('usuarios_auth')
                    .select('id, nome_completo, usuario, email, tipo_usuario, is_admin, senha')
                    .order('nome_completo', { ascending: true });
                if (error) throw error;
                const bcryptLib = (window.bcrypt || (window.dcodeIO && window.dcodeIO.bcrypt));
                const rows = data || [];
                usuariosCache = rows.map(u => {
                    const pass = (u.senha || '').trim();
                    let first = false;
                    try {
                        if (pass.startsWith('$2a$') || pass.startsWith('$2b$') || pass.startsWith('$2y$')) {
                            first = bcryptLib ? bcryptLib.compareSync(DEFAULT_FIRST_PASSWORD, pass) : false;
                        } else {
                            first = (pass === DEFAULT_FIRST_PASSWORD);
                        }
                    } catch(_) { first = false; }
                    const { senha, ...rest } = u; // n√£o manter a senha no cache
                    return { ...rest, primeiro_login: first };
                });
                if (!usuariosCache || usuariosCache.length === 0) {
                    // Fallback: exibe o usu√°rio administrador conhecido quando n√£o h√° dados
                    usuariosCache = [{ id: 1, nome_completo: 'Thiago Carmo', usuario: 'thiago.carmo', email: 'thiago.carmo@normaq.com.br', tipo_usuario: 'Administrador', is_admin: true, primeiro_login: false }];
                }
                renderUsuariosTable(usuariosCache);
            } catch (err) {
                console.error('Erro ao carregar usu√°rios:', err);
                // Fallback: mostra o administrador conhecido
                usuariosCache = [{ id: 1, nome_completo: 'Thiago Carmo', usuario: 'thiago.carmo', email: 'thiago.carmo@normaq.com.br', tipo_usuario: 'Administrador', is_admin: true, primeiro_login: false }];
                renderUsuariosTable(usuariosCache);
            }
        }

        function renderUsuariosTable(rows) {
            const tbody = document.getElementById('tbody-usuarios');
            if (!tbody) return;
            if (!rows || rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state">Nenhum usu√°rio encontrado</div></td></tr>';
                return;
            }
            const currentUser = window.NormaQCurrentUser || (JSON.parse(localStorage.getItem('authUser')) || null);
            const isAdminView = !!(currentUser && (currentUser.is_admin || currentUser.tipo_usuario === 'Administrador'));
            const html = rows.map(u => `
                <tr>
                    <td style="padding:8px;">${u.nome_completo || '-'}</td>
                    <td style="padding:8px;">${u.usuario || '-'}</td>
                    <td style="padding:8px;">${u.email || '-'}</td>
                    <td style="padding:8px;">${u.tipo_usuario || (u.is_admin ? 'Administrador' : 'Usu√°rio')}</td>
                    <td style="padding:8px;">${u.primeiro_login ? 'Sim' : 'N√£o'}</td>
                    <td style="padding:8px; display:flex; gap:8px;">
                        <button class="btn btn-warning" onclick="editarUsuario(${u.id})">‚úèÔ∏è Editar</button>
                        <button class="btn btn-danger" onclick="excluirUsuario(${u.id})">üóëÔ∏è Excluir</button>
                        ${isAdminView ? `<button class="btn" onclick="resetarSenhaPadrao(${u.id})">üîÑ Resetar Senha</button>` : ''}
                    </td>
                </tr>
            `).join('');
            tbody.innerHTML = html;
        }

        async function handleUserFormSubmit() {
            const id = ((document.getElementById('cad-user-id') && document.getElementById('cad-user-id').value) || '').trim();
            const nome = ((document.getElementById('cad-nome-completo') && document.getElementById('cad-nome-completo').value) || '').trim();
            const usuario = ((document.getElementById('cad-usuario') && document.getElementById('cad-usuario').value) || '').trim();
            const email = ((document.getElementById('cad-email') && document.getElementById('cad-email').value) || '').trim();
            const tipoEl = document.getElementById('cad-tipo-usuario');
            const tipo = tipoEl ? tipoEl.value : '';
            
            if (!nome || !usuario || !email || !tipo) {
                alert('Preencha todos os campos obrigat√≥rios.');
                return;
            }

            try {
                const isAdmin = (tipo === 'Administrador');
                if (id) {
                    // Atualiza√ß√£o
                    const { error } = await supabase
                        .from('usuarios_auth')
                        .update({ nome_completo: nome, usuario, email, tipo_usuario: tipo, is_admin: isAdmin })
                        .eq('id', id);
                    if (error) throw error;
                    alert('Usu√°rio atualizado com sucesso!');
                } else {
                    // Cria√ß√£o com senha inicial padr√£o
                    const bcryptLib = (window.bcrypt || (window.dcodeIO && window.dcodeIO.bcrypt));
                    const salt = bcryptLib.genSaltSync(10);
                    const senhaInicial = 'NMQ@123';
                    const senhaHash = bcryptLib.hashSync(senhaInicial, salt);
                    const { error } = await supabase
                        .from('usuarios_auth')
                        .insert({ nome_completo: nome, usuario, email, tipo_usuario: tipo, is_admin: isAdmin, senha: senhaHash });
                    if (error) throw error;
                    alert('Usu√°rio cadastrado! Senha inicial: NMQ@123');
                }
                clearUserForm();
                loadUsuariosList();
            } catch (err) {
                console.error('Erro ao salvar usu√°rio:', err);
                alert('Falha ao salvar usu√°rio: ' + (err?.message || 'Erro desconhecido'));
            }
        }

        function clearUserForm() {
            const fields = ['cad-user-id','cad-nome-completo','cad-usuario','cad-email'];
            fields.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
            const tipoEl = document.getElementById('cad-tipo-usuario');
            if (tipoEl) tipoEl.value = 'Usu√°rio';
            const btn = document.getElementById('btn-salvar-usuario');
            if (btn) btn.textContent = 'Cadastrar Usu√°rio';
        }

        function editarUsuario(id) {
            const u = (usuariosCache || []).find(x => x.id === id);
            if (!u) { alert('Usu√°rio n√£o encontrado no cache.'); return; }
            const idEl = document.getElementById('cad-user-id');
            const nomeEl = document.getElementById('cad-nome-completo');
            const usuarioEl = document.getElementById('cad-usuario');
            const emailEl = document.getElementById('cad-email');
            const tipoEl = document.getElementById('cad-tipo-usuario');
            if (idEl) idEl.value = u.id;
            if (nomeEl) nomeEl.value = u.nome_completo || '';
            if (usuarioEl) usuarioEl.value = u.usuario || '';
            if (emailEl) emailEl.value = u.email || '';
            if (tipoEl) tipoEl.value = u.tipo_usuario || (u.is_admin ? 'Administrador' : 'Usu√°rio');
            const btn = document.getElementById('btn-salvar-usuario');
            if (btn) btn.textContent = 'Salvar Altera√ß√µes';
        }

        async function excluirUsuario(id) {
            if (!confirm('Tem certeza que deseja excluir este usu√°rio?')) return;
            try {
                const { error } = await supabase
                    .from('usuarios_auth')
                    .delete()
                    .eq('id', id);
                if (error) throw error;
                alert('Usu√°rio exclu√≠do com sucesso!');
                loadUsuariosList();
            } catch (err) {
                console.error('Erro ao excluir usu√°rio:', err);
                alert('Falha ao excluir usu√°rio: ' + (err?.message || 'Erro desconhecido'));
            }
        }

        async function resetarSenhaPadrao(id) {
            try {
                if (!confirm('Deseja resetar a senha para o padr√£o?')) return;
                const bcryptLib = (window.bcrypt || (window.dcodeIO && window.dcodeIO.bcrypt));
                if (!bcryptLib) { alert('Biblioteca de criptografia n√£o carregada.'); return; }
                const salt = bcryptLib.genSaltSync(10);
                const senhaHash = bcryptLib.hashSync(DEFAULT_FIRST_PASSWORD, salt);
                const { error } = await supabase
                    .from('usuarios_auth')
                    .update({ senha: senhaHash })
                    .eq('id', id);
                if (error) throw error;
                alert('Senha resetada com sucesso!');
                loadUsuariosList();
            } catch (err) {
                console.error('Erro ao resetar senha:', err);
                alert('Falha ao resetar senha: ' + (err?.message || 'Erro desconhecido'));
            }
        }

        // --- Troca de senha no primeiro login ---
        function checkPrimeiroLoginThenShowModal() {
            try {
                const user = window.NormaQCurrentUser || (JSON.parse(localStorage.getItem('authUser')) || null);
                if (user && user.primeiro_login) {
                    const modal = document.getElementById('modal-change-password');
                    if (modal) modal.style.display = 'flex';
                }
            } catch (e) {
                console.warn('Falha ao verificar primeiro login:', e);
            }
        }

        async function saveNewPasswordFirstLogin() {
            const passEl = document.getElementById('new-pass');
            const pass = ((passEl && passEl.value) || '').trim();
            const confirmEl = document.getElementById('new-pass-confirm');
            const confirm = ((confirmEl && confirmEl.value) || '').trim();
            const feedback = document.getElementById('change-pass-feedback');
            if (feedback) { feedback.style.display = 'none'; feedback.textContent = ''; feedback.className = 'feedback'; }

            if (!pass || !confirm) {
                if (feedback) { feedback.textContent = 'Informe e confirme a nova senha.'; feedback.className = 'feedback error'; feedback.style.display = 'block'; }
                return;
            }
            if (pass !== confirm) {
                if (feedback) { feedback.textContent = 'As senhas n√£o coincidem.'; feedback.className = 'feedback error'; feedback.style.display = 'block'; }
                return;
            }
            try {
                const user = window.NormaQCurrentUser || (JSON.parse(localStorage.getItem('authUser')) || null);
                if (!user || !user.id) throw new Error('Usu√°rio n√£o autenticado.');
                const bcryptLib = (window.bcrypt || (window.dcodeIO && window.dcodeIO.bcrypt));
                const salt = bcryptLib.genSaltSync(10);
                const hash = bcryptLib.hashSync(pass, salt);
                const { error } = await supabase
                    .from('usuarios_auth')
                    .update({ senha: hash })
                    .eq('id', user.id);
                if (error) throw error;
                // Atualiza localStorage
                const updated = { ...user, primeiro_login: false };
                localStorage.setItem('authUser', JSON.stringify(updated));
                window.NormaQCurrentUser = updated;
                if (feedback) { feedback.textContent = 'Senha atualizada com sucesso!'; feedback.className = 'feedback success'; feedback.style.display = 'block'; }
                setTimeout(() => { const modal = document.getElementById('modal-change-password'); if (modal) modal.style.display = 'none'; }, 1200);
            } catch (err) {
                console.error('Erro ao atualizar senha:', err);
                if (feedback) { feedback.textContent = 'Falha ao atualizar senha: ' + (err?.message || 'Erro desconhecido'); feedback.className = 'feedback error'; feedback.style.display = 'block'; }
            }
        }
        
        // Inicializa os controles de colunas
        function initializeColumnControls() {
            const tabs = ['externa', 'interna', 'garantia'];
            
            tabs.forEach(tab => {
                const btn = document.getElementById(`columns-control-btn-${tab}`);
                if (btn) {
                    let menu = null;
                    
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        
                        // Remove menu existente
                        if (menu && document.body.contains(menu)) {
                            document.body.removeChild(menu);
                            menu = null;
                            return;
                        }
                        
                        // Cria novo menu
                        menu = createColumnsMenu(tab);
                        document.body.appendChild(menu);
                        
                        // Posiciona o menu abaixo do bot√£o
                        const rect = btn.getBoundingClientRect();
                        menu.style.position = 'absolute';
                        menu.style.top = `${rect.bottom + window.scrollY}px`;
                        menu.style.left = `${rect.left + window.scrollX}px`;
                        
                        // Fecha o menu ao clicar fora
                        const closeMenu = (e) => {
                            if (menu && !menu.contains(e.target) && e.target !== btn) {
                                document.body.removeChild(menu);
                                menu = null;
                                document.removeEventListener('click', closeMenu);
                            }
                        };
                        
                        setTimeout(() => {
                            document.addEventListener('click', closeMenu);
                        }, 0);
                    });
                }
            });
        }
        
        // --- FUN√á√ïES DE GERENCIAMENTO DE STATUS ---
        async function safeUpdateStatus(filterBy, filterValue, baseData) {
            const variants = [
                { ...baseData },
                (() => { const v = { ...baseData }; delete v.atualizado_por; return v; })()
            ];
            for (const data of variants) {
                try {
                    const { error } = await supabase
                        .from('status_customizados')
                        .update(data)
                        .eq(filterBy, filterValue);
                    if (!error) return true;
                } catch(_) {}
            }
            return false;
        }
        
        // Carrega os status do banco de dados Supabase
        async function loadStatusFromStorage() {
            try {
                const { data, error } = await supabase
                    .from('status_customizados')
                    .select('id, nome, cor_hex, ordem_exibicao, ativo, bloqueia_progresso, finaliza_processo, categoria, descricao')
                    .eq('ativo', true)
                    .order('ordem_exibicao', { ascending: true });
                
                if (error) {
                    console.error('Erro ao carregar status:', error);
                    return [];
                }
                
                // Converte para o formato esperado pelo c√≥digo existente
                return data.map(status => ({
                    id: status.id,
                    name: status.nome,
                    color: status.cor_hex || '#007bff',
                    ordem_exibicao: status.ordem_exibicao,
                    bloqueia_progresso: status.bloqueia_progresso,
                    finaliza_processo: status.finaliza_processo,
                    categoria: status.categoria,
                    descricao: status.descricao
                })) || [];
            } catch (error) {
                console.error('Erro ao carregar status:', error);
                return [];
            }
        }
        
        // Salva os status no banco de dados Supabase
        async function saveStatusToStorage(statuses) {
            try {
                const userInfo = getCurrentUserInfo();
                // Primeiro obt√©m os status atuais para comparar
                const { data: existingStatuses, error: fetchError } = await supabase
                    .from('status_customizados')
                    .select('id, nome, cor_hex, ordem_exibicao');
                
                if (fetchError) {
                    console.error('Erro ao buscar status existentes:', fetchError);
                    return;
                }
                
                const statusIds = statuses.filter(s => !!s.id).map(s => s.id);
                const statusNames = statuses.map(s => s.name.toLowerCase());
                const statusesToDeactivate = existingStatuses.filter(s => 
                    (statusIds.length > 0 ? !statusIds.includes(s.id) : !statusNames.includes(s.nome.toLowerCase()))
                );
                
                for (const status of statusesToDeactivate) {
                    const data = { ativo: false, data_atualizacao: new Date().toISOString() };
                    if (userInfo && userInfo.id) data.atualizado_por = userInfo.id;
                    let ok = await safeUpdateStatus('id', status.id, data);
                    if (!ok) ok = await safeUpdateStatus('nome', status.nome, data);
                }
                
                // Insere ou atualiza os status
                for (const [index, status] of statuses.entries()) {
                    const existingStatus = status.id ? existingStatuses.find(s => s.id === status.id) : existingStatuses.find(s => s.nome.toLowerCase() === status.name.toLowerCase());
                    
                    if (existingStatus) {
                        // Atualiza status existente
                        const updateData = {
                            cor_hex: status.color,
                            ordem_exibicao: status.ordem_exibicao || index,
                            bloqueia_progresso: status.bloqueia_progresso || false,
                            finaliza_processo: status.finaliza_processo || false,
                            categoria: status.categoria || '',
                            descricao: status.descricao || '',
                            atualizado_por: userInfo ? userInfo.id : null,
                            data_atualizacao: new Date().toISOString()
                        };
                        let ok = await safeUpdateStatus('id', existingStatus.id, updateData);
                        if (!ok) ok = await safeUpdateStatus('nome', existingStatus.nome, updateData);
                        if (!ok) { try { showFeedback('Erro ao atualizar status', true); } catch(_) {} } else { try { showFeedback('Status atualizado com sucesso!', false); } catch(_) {} }
                    } else {
                        const basePayload = {
                            nome: status.name,
                            cor_hex: status.color,
                            ordem_exibicao: index,
                            ativo: true,
                            bloqueia_progresso: false,
                            finaliza_processo: false,
                            categoria: '',
                            descricao: '',
                            criado_por: userInfo ? (userInfo.id || userInfo.usuario || 'sistema') : 'sistema',
                            atualizado_por: userInfo ? (userInfo.id || null) : null,
                            data_atualizacao: new Date().toISOString()
                        };
                        const attempts = [];
                        attempts.push({
                            ...basePayload,
                            id: (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') ? crypto.randomUUID() : undefined,
                            empresa_id: (userInfo && userInfo.empresa_id) ? userInfo.empresa_id : undefined
                        });
                        attempts.push({ ...basePayload, empresa_id: undefined });
                        attempts.push({ ...basePayload, id: undefined, empresa_id: undefined });
                        attempts.push({ ...basePayload, id: undefined, empresa_id: undefined, criado_por: userInfo ? (userInfo.usuario || 'sistema') : 'sistema', atualizado_por: userInfo ? (userInfo.usuario || null) : null });
                        attempts.push({ nome: basePayload.nome, cor_hex: basePayload.cor_hex, ordem_exibicao: basePayload.ordem_exibicao, ativo: true, data_atualizacao: basePayload.data_atualizacao });

                        let saved = false;
                        let lastError = null;
                        for (const payload of attempts) {
                            try {
                                const clean = Object.fromEntries(Object.entries(payload).filter(([_, v]) => v !== undefined));
                                const { error: insertError } = await supabase
                                    .from('status_customizados')
                                    .insert(clean);
                                if (!insertError) { saved = true; break; }
                                lastError = insertError;
                            } catch (e) { lastError = e; }
                        }
                        if (!saved) {
                            console.error('Erro ao inserir status:', lastError);
                            try { showFeedback('Erro ao salvar status: ' + (lastError?.message || ''), true); } catch (_) {}
                        } else {
                            try { showFeedback('Status salvo com sucesso!', false); } catch (_) {}
                        }
                    }
                }
            } catch (error) {
                console.error('Erro ao salvar status:', error);
                try { showFeedback('Erro ao salvar status: ' + (error.message || ''), true); } catch (_) {}
            }
        }
        
        // Status do sistema ocultos (exclu√≠dos pelo usu√°rio)
        function loadHiddenSystemStatuses() {
            return JSON.parse(localStorage.getItem('hiddenSystemStatuses')) || [];
        }
        function saveHiddenSystemStatuses(list) {
            localStorage.setItem('hiddenSystemStatuses', JSON.stringify(list));
        }
        
        // Extrai status √∫nicos da base de dados
        function getUniqueStatusesFromData() {
            const allStatuses = new Set();
            const hidden = loadHiddenSystemStatuses();
            
            // Percorre todos os dados carregados
            Object.values(osData).forEach(dataArray => {
                dataArray.forEach(os => {
                    if (os.Status) {
                        allStatuses.add(os.Status.trim());
                    }
                });
            });
            
            // Adiciona os status padr√£o do sistema
            const defaultStatuses = [
                'Pendente de Pe√ßa', 'Pendente de Programa√ß√£o', 'Pendente Submiss√£o',
                'Programado', 'Submiss√£o Aprovada', 'Submiss√£o em Processamento', 
                'Em Negocia√ß√£o', 'Servi√ßo Conclu√≠do', 'Concluindo', 'Em Atendimento', 
                'Cancelado'
            ];
            
            defaultStatuses.forEach(status => allStatuses.add(status));
            
            return Array.from(allStatuses)
                .filter(status => status && status !== 'Sem Status' && !hidden.includes(status));
        }
        
        // Carrega e exibe a lista de status
        async function loadStatusList() {
            const customList = document.getElementById('status-list');
            const systemList = document.getElementById('system-status-list');
            const customStatuses = await loadStatusFromStorage();
            const systemStatuses = getUniqueStatusesFromData();

            customList.innerHTML = '';
            systemList.innerHTML = '';

            customStatuses.forEach((status, index) => {
                const statusItem = document.createElement('div');
                statusItem.className = 'status-item';
                statusItem.setAttribute('data-id', index);
                statusItem.innerHTML = `
                    <span class="status-color-preview" style="background-color: ${status.color};"></span>
                    <span class="status-name">${status.name}</span>
                    <span class="status-actions">
                        <button onclick="editStatus(${index})">Editar</button>
                        <button onclick="deleteStatus(${index})">Excluir</button>
                    </span>
                `;
                customList.appendChild(statusItem);
            });

            // Primeiro obtemos todas as cores dos status do sistema
            const systemStatusColors = {};
            for (const status of systemStatuses) {
                if (!customStatuses.some(customStatus => customStatus.name === status)) {
                    systemStatusColors[status] = await getStatusColor(status);
                }
            }
            
            // Depois criamos os elementos HTML
            for (const status of systemStatuses) {
                if (!customStatuses.some(customStatus => customStatus.name === status)) {
                    const statusItem = document.createElement('div');
                    statusItem.className = 'status-item';
                    statusItem.innerHTML = `
                        <span class="status-color-preview" style="background-color: ${systemStatusColors[status]};"></span>
                        <span class="status-name">${status}</span>
                        <span class="status-actions">
                            <button onclick="editExistingStatus('${status}')">Editar</button>
                            <button onclick="deleteSystemStatus('${status}')">Excluir</button>
                        </span>
                    `;
                    systemList.appendChild(statusItem);
                }
            }

            new Sortable(customList, {
                animation: 150,
                onEnd: async function (evt) {
                    const reorderedStatuses = [];
                    const items = customList.querySelectorAll('.status-item');
                    const originalStatuses = await loadStatusFromStorage();
                    items.forEach(item => {
                        const originalIndex = parseInt(item.getAttribute('data-id'));
                        reorderedStatuses.push(originalStatuses[originalIndex]);
                    });
                    await saveStatusToStorage(reorderedStatuses);
                    await loadStatusList();
                }
            });
        }
        
        // Adiciona um status existente como customizado
        function addExistingStatus(statusName) {
            const nameInput = document.getElementById('status-name');
            const colorInput = document.getElementById('status-color');
            if (nameInput) nameInput.value = statusName;
            if (colorInput) colorInput.value = '#007bff';
            if (nameInput) nameInput.focus();
        }
        
        // Edita um status existente (n√£o customizado)
        async function editExistingStatus(statusName) {
            const statuses = await loadStatusFromStorage();
            const index = statuses.findIndex(s => s.name.toLowerCase() === statusName.toLowerCase());
            const nameInput = document.getElementById('status-name');
            const colorInput = document.getElementById('status-color');
            if (nameInput) nameInput.value = statusName;
            if (colorInput) colorInput.value = index !== -1 ? (statuses[index].color || '#007bff') : (await getStatusColor(statusName) || '#007bff');

            if (index !== -1) {
                if (nameInput) nameInput.setAttribute('data-editing-index', index);
            } else {
                if (nameInput) nameInput.removeAttribute('data-editing-index');
            }
            if (nameInput) nameInput.focus();
        }
        
        // Salva um novo status ou atualiza um existente
        async function saveStatus() {
            const nameInput = document.getElementById('status-name');
            const colorInput = document.getElementById('status-color');
            const editingIndex = nameInput ? nameInput.getAttribute('data-editing-index') : null;
            
            const name = ((nameInput && nameInput.value) || '').trim();
            const color = colorInput ? colorInput.value : '#007bff';
            
            if (!name) {
                alert('Por favor, digite um nome para o status.');
                return;
            }
            
            const statuses = await loadStatusFromStorage();
            
            if (editingIndex !== null) {
                const idx = Number(editingIndex);
                const current = statuses[idx] || { name: '', color: '#007bff' };
                statuses[idx] = { ...current, name, color };
            } else {
                // Modo adi√ß√£o - verifica se j√° existe
                const exists = statuses.some(s => s.name.toLowerCase() === name.toLowerCase());
                if (exists) {
                    alert('J√° existe um status com este nome.');
                    return;
                }
                statuses.push({ name, color });
            }
            
            await saveStatusToStorage(statuses);
            await loadStatusList();
            clearStatusForm();
            
            // Atualiza os selects de status em todas as abas
            updateStatusSelects();
        }
        
        // Edita um status existente
        async function editStatus(index) {
            const statuses = await loadStatusFromStorage();
            const status = statuses[index];
            
            const nameInput = document.getElementById('status-name');
            const colorInput = document.getElementById('status-color');
            if (nameInput) nameInput.value = status.name;
            if (colorInput) colorInput.value = status.color;
            if (nameInput) nameInput.setAttribute('data-editing-index', index);
            
            // Foca no campo de nome
            if (nameInput) nameInput.focus();
        }
        
        // Exclui um status
        async function deleteStatus(index) {
            if (!confirm('Tem certeza que deseja excluir este status?')) {
                return;
            }
            
            const statuses = await loadStatusFromStorage();
            const toDelete = statuses[index];
            try {
                const userInfo = getCurrentUserInfo();
                const updateData = { ativo: false, data_atualizacao: new Date().toISOString() };
                if (userInfo && userInfo.id) updateData.atualizado_por = userInfo.id;
                let ok = false;
                if (toDelete && toDelete.id) {
                    ok = await safeUpdateStatus('id', toDelete.id, updateData);
                }
                if (!ok && toDelete && toDelete.name) {
                    ok = await safeUpdateStatus('nome', toDelete.name, updateData);
                }
                if (!ok && toDelete && typeof toDelete.id === 'string') {
                    const intId = parseInt(toDelete.id, 10);
                    if (!isNaN(intId)) ok = await safeUpdateStatus('id', intId, updateData);
                }
                if (!ok) { try { showFeedback('Erro ao excluir status', true); } catch(_) {} }
            } catch(_) {}
            await loadStatusList();
            updateStatusSelects();
        }
        
        // Exclui status do sistema (se existir como customizado) com mesmo nome
        async function deleteSystemStatus(statusName) {
            if (!confirm('Tem certeza que deseja excluir este status?')) {
                return;
            }
            // Remove a vers√£o customizada (se existir)
            const statuses = await loadStatusFromStorage();
            const index = statuses.findIndex(s => s.name.toLowerCase() === statusName.toLowerCase());
            if (index !== -1) {
                statuses.splice(index, 1);
                await saveStatusToStorage(statuses);
            }
            // Oculta o status do sistema nos lists e selects
            const hidden = loadHiddenSystemStatuses();
            if (!hidden.includes(statusName)) {
                hidden.push(statusName);
                saveHiddenSystemStatuses(hidden);
            }
            await loadStatusList();
            updateStatusSelects();
        }
        
        // Limpa o formul√°rio de status
        function clearStatusForm() {
            const nameInput = document.getElementById('status-name');
            const colorInput = document.getElementById('status-color');
            if (nameInput) nameInput.value = '';
            if (colorInput) colorInput.value = '#007bff';
            if (nameInput) nameInput.removeAttribute('data-editing-index');
        }
        
        // Atualiza os selects de status em todas as abas
        async function updateStatusSelects() {
            const statuses = await loadStatusFromStorage();
            const hidden = loadHiddenSystemStatuses();
            const defaultStatuses = [
                'Sem Status', 'Pendente de Pe√ßa', 'Pendente de Programa√ß√£o', 'Pendente Submiss√£o',
                'Programado', 'Submiss√£o Aprovada', 'Submiss√£o em Processamento', 'Em Negocia√ß√£o',
                'Servi√ßo Conclu√≠do', 'Concluindo', 'Em Atendimento', 'Cancelado'
            ];

            // Seleciona apenas os filtros de status principais e selects de atualiza√ß√£o
            const allSelects = Array.from(document.querySelectorAll('select[id^="filter-status-"], select[id="update-status"], select[id="batch-status"], select[id="batch-filter-status"]'));
            const statusSelects = allSelects.filter(sel => !sel.id.startsWith('transfer-filter-status-'));

            statusSelects.forEach(select => {
                const currentValue = select.value;
                const added = new Set();

                // Cabe√ßalho inicial por tipo de select
                if (select.id === 'update-status') {
                    select.innerHTML = '<option value="">Selecionar status...</option>';
                } else if (select.id === 'batch-status') {
                    select.innerHTML = '<option value="">Atualizar Status para...</option>';
                } else if (select.id === 'batch-filter-status') {
                    select.innerHTML = '<option value="">Filtrar por Status...</option>';
                } else {
                    // Filtros (externa/interna/garantia)
                    select.innerHTML = '<option value="">Todos</option>';
                }

                // Adiciona status padr√£o (filtrando ocultos)
                defaultStatuses.forEach(status => {
                    if (!hidden.includes(status) && !added.has(status)) {
                        const option = document.createElement('option');
                        option.value = status;
                        option.textContent = status;
                        select.appendChild(option);
                        added.add(status);
                    }
                });

                // Adiciona status customizados (sem duplicar)
                statuses.forEach(status => {
                    const name = (status.name || '').trim();
                    if (name && !hidden.includes(name) && !added.has(name)) {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        select.appendChild(option);
                        added.add(name);
                    }
                });

                if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
                    select.value = currentValue;
                }
            });

            // Garante que os filtros de Situa√ß√£o OS na Transfer√™ncia mantenham Aberta/Fechada/Todos
            resetTransferSituacaoFilters();
        }

        // Restaura op√ß√µes de Situa√ß√£o OS na aba Transfer√™ncia de Escalonamento
        function resetTransferSituacaoFilters() {
            ['externa','interna','garantia'].forEach(tab => {
                const sel = document.getElementById(`transfer-filter-status-${tab}`);
                if (sel) {
                    const prev = sel.value;
                    sel.innerHTML = `
                        <option value="Aberta">Aberta</option>
                        <option value="Fechada">Fechada</option>
                        <option value="Todos">Todos</option>
                    `;
                    // Mant√©m valor atual se existir nas op√ß√µes
                    if (prev && sel.querySelector(`option[value="${prev}"]`)) {
                        sel.value = prev;
                    } else {
                        sel.value = 'Aberta';
                    }
                }
            });
        }
        
        // Inicializa o gerenciamento de status
        async function initializeStatusManagement() {
            await loadStatusList();
            await updateStatusSelects();
        }

        async function loadOSData() {
            showLoading(currentTab);
            hideMessages();
            try {
                const tipo = tiposMap[currentTab];
                if (!tipo) {
                    console.warn(`Aba sem tipo mapeado: "${currentTab}". Ignorando carregamento.`);
                    return;
                }
                console.log('Carregando dados para tipo:', tipo, 'da tabela:', tabelaBase);
                const { data, error } = await supabase.from(tabelaBase).select('*').eq('Tipo', tipo);
                if (error) {
                    console.error('Erro do Supabase:', error);
                    throw error;
                }
                console.log('Dados recebidos do Supabase:', data ? data.length : 0, 'registros');
                if (data && data.length > 0) {
                    console.log('Primeira OS exemplo:', data[0]);
                }
                osData[currentTab] = data || [];
                showSuccessMessage(`${data.length} OS do tipo "${tipo}" carregadas.`);
                await renderTable(currentTab);
                updateTotals(currentTab);
                // Atualiza indicadores APENAS se houve aumento na contagem
                evaluateIncreaseAndUpdateIndicators(currentTab, (data || []).length);
                applyColumnVisibility();

                // Exibir notifica√ß√£o de transfer√™ncia iminente ap√≥s login/carregamento
                try { await showTransferenciaToastIfNeeded(); } catch(_) {}
            } catch (error) {
                console.error('Erro completo no loadOSData:', error);
                showErrorMessage(`Erro ao carregar dados: ${error.message}`);
            }
        }

        async function renderTable(tab) {
            const dataToRender = osData[tab] || [];
            
            if (dataToRender.length === 0) {
                const tbody = document.getElementById(`tbody-${tab}`);
                const countEl = document.getElementById(`count-${tab}`);
                if (tbody) {
                    tbody.innerHTML = `<tr><td colspan="15" style="text-align: center; padding: 20px;">Nenhuma OS encontrada</td></tr>`;
                }
                if (countEl) {
                    countEl.textContent = '0 OS encontradas';
                }
                return;
            }

            // Aplica ordena√ß√£o se houver
            applySorting(tab);
        }

        // --- Notifica√ß√£o: Transfer√™ncia iminente (<=5 dias) ---
        async function computeImminentTransfersForUserAcrossTypes(user) {
            const responsavelAtual = getResponsavelAtualFromUser(user);
            if (!responsavelAtual) return [];
            // Carrega datasets se ainda n√£o estiverem em mem√≥ria
            let externa = osData.externa || [];
            let interna = osData.interna || [];
            let garantia = osData.garantia || [];
            try {
                if (!Array.isArray(externa) || externa.length === 0) {
                    const { data: de } = await supabase.from(tabelaBase).select('*').eq('Tipo', 'Externa');
                    externa = de || [];
                }
                if (!Array.isArray(interna) || interna.length === 0) {
                    const { data: di } = await supabase.from(tabelaBase).select('*').eq('Tipo', 'Interna');
                    interna = di || [];
                }
                if (!Array.isArray(garantia) || garantia.length === 0) {
                    const { data: dg } = await supabase.from(tabelaBase).select('*').eq('Tipo', 'Garantia');
                    garantia = dg || [];
                }
            } catch(_) {}

            const items = [];
            const types = [
                { tipo: 'externa', data: externa },
                { tipo: 'interna', data: interna },
                { tipo: 'garantia', data: garantia }
            ];
            types.forEach(({ tipo, data }) => {
                (data || []).forEach(os => {
                    const situacao = ((os['Situacao OS'] || '') + '').toLowerCase();
                    // Considera apenas OS Abertas para alerta/transfer√™ncia iminente
                    if (!situacao.includes('abert')) return;
                    const dias = calcularDiasEmAberto(os);
                    const esc = getEscalonamento(tipo, dias, os.Revenda);
                    if (esc !== responsavelAtual) return;
                    const limit = getEscalonamentoLimit(tipo, esc, os.Revenda);
                    const daysUntil = limit - dias;
                    // Inclui tamb√©m OS no dia do limite (0 dias restantes)
                    if (daysUntil >= 0 && daysUntil <= 5) items.push(os);
                });
            });
            return items;
        }

        // Vers√£o por aba: conta somente a aba atual (Externa/Interna/Garantia) e apenas OS Abertas
        async function computeImminentTransfersForUserByTab(user, tab) {
            const responsavelAtual = getResponsavelAtualFromUser(user);
            if (!responsavelAtual) return [];
            const tipoLabel = tab === 'externa' ? 'Externa' : (tab === 'interna' ? 'Interna' : 'Garantia');
            let data = osData[tab] || [];
            try {
                if (!Array.isArray(data) || data.length === 0) {
                    const { data: dtab } = await supabase.from(tabelaBase).select('*').eq('Tipo', tipoLabel);
                    data = dtab || [];
                }
            } catch(_) {}

            const items = [];
            (data || []).forEach(os => {
                const situacao = ((os['Situacao OS'] || '') + '').toLowerCase();
                if (!situacao.includes('abert')) return;
                const dias = calcularDiasEmAberto(os);
                const esc = getEscalonamento(tab, dias, os.Revenda);
                if (esc !== responsavelAtual) return;
                const limit = getEscalonamentoLimit(tab, esc, os.Revenda);
                const daysUntil = limit - dias;
                // Inclui tamb√©m OS no dia do limite (0 dias restantes)
                if (daysUntil >= 0 && daysUntil <= 5) items.push(os);
            });
            return items;
        }

        async function showTransferenciaToastIfNeeded() {
            // Verifica se j√° foi exibido nesta sess√£o
            if (sessionStorage.getItem('transferenciaToastShown') === 'true') return;
            
            const user = getCurrentUserInfo();
            if (!user) return;
            const nome = (user.nome_completo || user.usuario || '').toLowerCase();
            if (nome.includes('ant√¥nio gustavo') || nome.includes('antonio gustavo') || nome.includes('thiago carmo') || nome.includes('thiago.carmo')) return;

            // Usa todas as abas e aplica o mesmo crit√©rio do escalonamento por usu√°rio
            const imminents = await computeImminentTransfersForUserAcrossTypes(user);
            if (!imminents.length) return;

            // Cria container se necess√°rio
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.style.position = 'fixed';
                container.style.top = '10px';
                container.style.right = '10px';
                container.style.zIndex = '10010';
                document.body.appendChild(container);
            }
            const toast = document.createElement('div');
            toast.style.background = '#fff';
            toast.style.border = '1px solid #ffc107';
            toast.style.boxShadow = '0 4px 16px rgba(0,0,0,0.2)';
            toast.style.borderRadius = '8px';
            toast.style.padding = '12px 16px';
            toast.style.margin = '8px';
            toast.style.minWidth = '320px';
            toast.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                <strong>Transfer√™ncia Pendente</strong>
                <button aria-label="Fechar" style="background:none; border:none; font-size:18px; cursor:pointer;">&times;</button>
            </div>
            <div>Voc√™ tem ${imminents.length} OS com transfer√™ncia em at√© 5 dias.</div>`;

            const closeBtn = toast.querySelector('button');
            closeBtn.addEventListener('click', () => toast.remove());
            toast.addEventListener('click', () => {
                try {
                    const numeros = imminents.map(os => os['Numero OS'] || '').filter(Boolean);
                    mostrarModalListaOS(numeros);
                } catch(_) {}
            });
            container.appendChild(toast);
            
            // Marca que a notifica√ß√£o foi exibida nesta sess√£o
            sessionStorage.setItem('transferenciaToastShown', 'true');
        }

        // Toast gen√©rico para feedback de grava√ß√£o de logs
        function showStatusLogToast(message, type) {
            try {
                let container = document.getElementById('toast-container');
                if (!container) {
                    container = document.createElement('div');
                    container.id = 'toast-container';
                    container.style.position = 'fixed';
                    container.style.top = '10px';
                    container.style.right = '10px';
                    container.style.zIndex = '10010';
                    document.body.appendChild(container);
                }
                const toast = document.createElement('div');
                toast.style.background = '#fff';
                toast.style.border = type === 'success' ? '1px solid #28a745' : '1px solid #dc3545';
                toast.style.boxShadow = '0 4px 16px rgba(0,0,0,0.2)';
                toast.style.borderRadius = '8px';
                toast.style.padding = '10px 14px';
                toast.style.margin = '8px';
                toast.style.minWidth = '280px';
                toast.innerHTML = '<div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">' +
                    '<span style="color:' + (type === 'success' ? '#28a745' : '#dc3545') + '; font-weight:600;">' + (type === 'success' ? 'Sucesso' : 'Aviso') + '</span>' +
                    '<span style="flex:1; color:#333;">' + message + '</span>' +
                    '<button aria-label="Fechar" style="background:none; border:none; font-size:18px; cursor:pointer;">&times;</button>' +
                '</div>';
                const closeBtn = toast.querySelector('button');
                closeBtn.addEventListener('click', function() { try { toast.remove(); } catch(_) {} });
                setTimeout(function() { try { toast.remove(); } catch(_) {} }, 4000);
                container.appendChild(toast);
            } catch(_) {}
        }

        function mostrarModalListaOS(numeros) {
            let modal = document.getElementById('transferencia-imminente-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'transferencia-imminente-modal';
                modal.className = 'modal';
                modal.innerHTML = `<div class="modal-content" style="max-width:480px;">
                    <div class="modal-header"><h2 class="modal-title">OS com Transfer√™ncia</h2><button class="close-modal">&times;</button></div>
                    <div class="modal-body" id="lista-os-transferencia" style="padding:8px 0; font-family:monospace;"></div>
                    <div class="modal-footer"><button type="button" class="btn close-modal">Fechar</button></div>
                </div>`;
                document.body.appendChild(modal);
                modal.querySelectorAll('.close-modal').forEach(btn => btn.addEventListener('click', () => modal.style.display = 'none'));
            }
            const body = modal.querySelector('#lista-os-transferencia');
            body.innerHTML = (numeros && numeros.length)
                ? numeros.map(n => `<div>${n}</div>`).join('')
                : '<div>Nenhuma OS encontrada.</div>';
            modal.style.display = 'flex';
        }

        function openIndividualModal(osId, nroOs, situacao, observacao, acaoAtualizacao, status, revenda = '', tipo = '') {
            const idEl = document.getElementById('update-os-id');
            const nroEl = document.getElementById('update-nro-os');
            const sitEl = document.getElementById('update-situacao');
            if (idEl) idEl.value = osId;
            if (nroEl) nroEl.value = nroOs;
            if (sitEl) sitEl.value = situacao;
            updateStatusSelects(); // Popula o dropdown com todos os status
            const statusEl = document.getElementById('update-status');
            const obsEl = document.getElementById('update-observacao');
            const acaoEl = document.getElementById('update-acao-atualizacao');
            const modalEl = document.getElementById('update-modal');
            if (statusEl) statusEl.value = status || 'Sem Status';
            if (obsEl) obsEl.value = observacao || '';
            if (acaoEl) acaoEl.value = acaoAtualizacao || '';
            if (modalEl) modalEl.style.display = 'flex';

            // Guarda informa√ß√µes anteriores para log
            const updateForm = document.getElementById('update-form');
            if (updateForm) {
                updateForm.dataset.prevStatus = status || '';
                updateForm.dataset.nroOs = nroOs || '';
                updateForm.dataset.revenda = revenda || '';
                updateForm.dataset.tipo = tipo || '';
            }
        }

        async function updateOS() {
            const idEl = document.getElementById('update-os-id');
            const osId = idEl ? idEl.value : '';
            if (!osId) {
                alert('Erro: ID da OS n√£o encontrado!');
                return;
            }
            
            try {
                const situacaoEl = document.getElementById('update-situacao');
                const statusEl = document.getElementById('update-status');
                const obsEl = document.getElementById('update-observacao');
                const acaoEl = document.getElementById('update-acao-atualizacao');
                const situacaoNova = situacaoEl ? situacaoEl.value : '';
                const statusNovo = statusEl ? statusEl.value : '';
                const observacao = obsEl ? obsEl.value : '';
                const acaoAtualizacao = acaoEl ? acaoEl.value : '';
                
                let diasParaSalvar = null;

                // Se estiver fechando a OS agora, calcula e congela os dias atuais
                if (situacaoNova === 'Fechada') {
                    // Busca a data de emiss√£o atual para calcular o valor final
                    const { data: osAtual, error: errorOs } = await supabase
                        .from(tabelaBase)
                        .select('Emissao')
                        .eq('Chave', osId)
                        .single();
                    
                    if (errorOs) {
                        console.error('Erro ao buscar OS:', errorOs);
                        throw errorOs;
                    }
                    
                    if (osAtual && osAtual.Emissao) {
                        diasParaSalvar = calculateDaysRobust(osAtual.Emissao);
                    }
                }

                // Prepara os dados para atualiza√ß√£o - SEM Status, usando Observacao
                const observacaoComStatus = combinarStatusEObservacao(statusNovo, observacao);
                const updateData = {
                    'Situacao OS': situacaoNova,
                    'Observacao': observacaoComStatus,
                    'Acao / Atualizacao': acaoAtualizacao
                };

                // S√≥ atualiza a coluna 'Dias' se estiver fechando
                if (diasParaSalvar !== null) {
                    updateData['Dias'] = diasParaSalvar;
                }

                console.log('Atualizando OS:', osId, updateData);

                const { error } = await supabase
                    .from(tabelaBase)
                    .update(updateData)
                    .eq('Chave', osId);

                if (error) {
                    console.error('Erro detalhado:', error);
                    throw error;
                }
                // Feedback imediato ao usu√°rio
                alert('OS atualizada com sucesso!');
                const modalEl = document.getElementById('update-modal');
                if (modalEl) modalEl.style.display = 'none';
                // Recarrega dados de forma ass√≠ncrona
                setTimeout(() => { try { loadOSData(); } catch(_) {} }, 0);

                // Log da altera√ß√£o (n√£o bloqueia a UI)
                try {
                    const updateForm = document.getElementById('update-form');
                    const payloadLog = {
                        osId: osId,
                        nroOS: updateForm?.dataset?.nroOs || ((document.getElementById('update-nro-os') && document.getElementById('update-nro-os').value) || ''),
                        revenda: updateForm?.dataset?.revenda || '',
                        tipoOS: updateForm?.dataset?.tipo || '',
                        statusAnterior: updateForm?.dataset?.prevStatus || 'Sem Status',
                        statusNovo: statusNovo
                    };
                    Promise.resolve().then(() => logStatusChangeEntry(payloadLog)).catch(e => console.warn('Falha ao logar altera√ß√£o (modal):', e));
                } catch(e) { console.warn('Falha ao agendar log (modal):', e); }
            } catch (error) {
                console.error('Erro completo:', error);
                alert('Erro ao atualizar OS: ' + error.message);
            }
        }

        // --- L√ìGICA ABA ATUALIZA√á√ÉO (Batch) ---
        let batchOSData = [];
        let selectedOS = new Set();

        async function loadBatchOS() {
            const tipoEl = document.getElementById('batch-tipo');
            const tipo = tipoEl ? tipoEl.value : '';
            const sitEl = document.getElementById('batch-situacao');
            const situacao = sitEl ? sitEl.value : 'Aberta';
            const listEl = document.getElementById('batch-os-list');
            if (listEl) listEl.innerHTML = `<div style="text-align: center; padding: 40px;"><div class="spinner"></div></div>`;
            try {
                const query = supabase.from(tabelaBase).select('*').eq('Tipo', tipo).limit(500);
                const { data, error } = await query.eq('Situacao OS', situacao);
                if (error) throw error;
                batchOSData = data || [];
                renderBatchOSList();
                updateSelectedCount();
            } catch (error) {
                if (listEl) listEl.innerHTML = `<div class="empty-state">Erro: ${error.message}</div>`;
            }
        }

        async function loadBatchOSByNumbers() {
            const tipoEl = document.getElementById('batch-tipo');
            const tipo = tipoEl ? tipoEl.value : '';
            const sitEl = document.getElementById('batch-situacao');
            const situacao = sitEl ? sitEl.value : '';
            const inputEl = document.getElementById('batch-multi-os');
            const raw = (inputEl && inputEl.value) ? inputEl.value : '';
            const numeros = raw.split(/[;\n,\s]+/).map(s => s.trim()).filter(s => s.length > 0);
            const unique = Array.from(new Set(numeros));
            if (unique.length === 0) { alert('Informe ao menos um n√∫mero de OS.'); return; }
            const listEl = document.getElementById('batch-os-list');
            if (listEl) listEl.innerHTML = `<div style="text-align: center; padding: 40px;"><div class="spinner"></div></div>`;
            try {
                let query = supabase.from(tabelaBase).select('*').eq('Tipo', tipo).in('Numero OS', unique).limit(500);
                if (situacao) query = query.eq('Situacao OS', situacao);
                const { data, error } = await query;
                if (error) throw error;
                batchOSData = data || [];
                renderBatchOSList();
                updateSelectedCount();
            } catch (error) {
                if (listEl) listEl.innerHTML = `<div class="empty-state">Erro: ${error.message}</div>`;
            }
        }

        function renderBatchOSList() {
            const container = document.getElementById('batch-os-list');
            const filterStatusEl = document.getElementById('batch-filter-status');
            const filterEscEl = document.getElementById('batch-filter-escalonamento');
            const tipoEl = document.getElementById('batch-tipo');
            const filterStatus = filterStatusEl ? filterStatusEl.value : '';
            const filterEsc = filterEscEl ? filterEscEl.value : '';
            const tipoAtual = tipoEl ? (tipoEl.value || 'Externa') : 'Externa';
            if (batchOSData.length === 0) {
                container.innerHTML = `<div class="empty-state">Nenhuma OS encontrada</div>`;
                return;
            }
            const filtered = batchOSData.filter(os => {
                const st = extrairStatusDaObservacao(os.Observacao);
                if (filterStatus && st !== filterStatus) return false;
                if (filterEsc) {
                    const dias = calcularDiasEmAberto(os);
                    const esc = getEscalonamento(tipoAtual.toLowerCase(), dias, os.Revenda);
                    if (esc !== filterEsc) return false;
                }
                return true;
            });
            if (filtered.length === 0) {
                container.innerHTML = `<div class="empty-state">Nenhuma OS encontrada para o status selecionado</div>`;
                return;
            }
            container.innerHTML = filtered.map((os, index) => {
                const status = extrairStatusDaObservacao(os.Observacao);
                const statusDisplay = `<span class="status-os-badge ${getStatusClass(status)}">${status}</span>`;
                
                return `
                <div class="os-checkbox-item">
                    <input type="checkbox" id="os-${index}" data-id="${os.Chave || os.Cahve}" data-emissao="${os.Emissao}">
                    <div class="os-details">
                        <span class="os-number">OS ${os['Numero OS']}</span> - ${os.Cliente || ''}
                        <br><small>Emiss√£o: ${formatDate(os.Emissao)} | Status: ${statusDisplay}</small>
                    </div>
                </div>`;
            }).join('');
            container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', function() {
                    this.checked ? selectedOS.add(this.dataset.id) : selectedOS.delete(this.dataset.id);
                    updateSelectedCount();
                });
            });
        }

        function populateBatchEscalonamento() {
            const sel = document.getElementById('batch-filter-escalonamento');
            const tipoEl = document.getElementById('batch-tipo');
            const tipo = (tipoEl ? tipoEl.value : 'Externa').toLowerCase();
            if (!sel) return;
            const map = {
                externa: ['Isabelle','Ana Leya','Wanderley','Graziela','Johnny','Ant√¥nio Gustavo'],
                interna: ['Bruna','Ana Leya','Wanderley','Graziela','Johnny','Ant√¥nio Gustavo'],
                garantia: ['Fl√°via','Giovana','Wanderley','Graziela','Johnny','Ant√¥nio Gustavo']
            };
            const opts = map[tipo] || map.externa;
            sel.innerHTML = ['<option value="">Filtrar por Escalonamento...</option>'].concat(opts.map(n => `<option value="${n}">${n}</option>`)).join('');
        }

        function updateSelectedCount() {
            const count = selectedOS.size;
            const countEl = document.getElementById('selected-count');
            if (countEl) countEl.textContent = `${count} OS selecionadas`;
            const fecharBtn = document.getElementById('btn-fechar-os');
            if (fecharBtn) fecharBtn.disabled = count === 0;
            const atualizarBtn = document.getElementById('btn-atualizar-status');
            const batchStatusEl = document.getElementById('batch-status');
            if (atualizarBtn) atualizarBtn.disabled = count === 0 || !batchStatusEl || batchStatusEl.value === '';
        }

        function toggleSelectAll() {
            const allEl = document.getElementById('select-all-os');
            const checked = allEl ? allEl.checked : false;
            document.querySelectorAll('#batch-os-list input[type="checkbox"]').forEach(cb => {
                cb.checked = checked;
                checked ? selectedOS.add(cb.dataset.id) : selectedOS.delete(cb.dataset.id);
            });
            updateSelectedCount();
        }

        function clearSelection() {
            selectedOS.clear();
            document.querySelectorAll('#batch-os-list input[type="checkbox"]').forEach(cb => cb.checked = false);
            const allEl = document.getElementById('select-all-os');
            if (allEl) allEl.checked = false;
            const statusEl = document.getElementById('batch-status');
            if (statusEl) statusEl.value = '';
            updateSelectedCount();
        }

        async function closeSelectedOS() {
            if (selectedOS.size === 0 || !confirm(`Fechar ${selectedOS.size} OSs?`)) return;
            
            let processed = 0;
            let errors = 0;
            
            for (const osId of selectedOS) {
                try {
                    const os = batchOSData.find(o => (o.Chave || o.Cahve) == osId);
                    if (os) {
                        const diasFinais = calculateDaysRobust(os.Emissao);
                        const { error } = await supabase.from(tabelaBase).update({ 
                            'Situacao OS': 'Fechada', 
                            'Dias': diasFinais 
                        }).eq('Chave', osId);
                        
                        if (error) {
                            console.error(`Erro ao fechar OS ${osId}:`, error);
                            errors++;
                        } else {
                            processed++;
                        }
                    }
                } catch (error) {
                    console.error(`Erro ao processar OS ${osId}:`, error);
                    errors++;
                }
            }
            
            if (errors > 0) {
                alert(`${processed} OS fechadas com sucesso! ${errors} erros encontrados.`);
            } else {
                alert(`${processed} OS fechadas com sucesso!`);
            }
            
            clearSelection();
            loadBatchOS();
        }

        async function updateSelectedStatus() {
            const statusEl = document.getElementById('batch-status');
            const novoStatus = statusEl ? statusEl.value : '';
            if (selectedOS.size === 0 || !novoStatus) return;
            
            if (!confirm(`Atualizar status para "${novoStatus}" em ${selectedOS.size} OSs?`)) return;
            
            let processed = 0;
            let errors = 0;
            
            const userInfo = getCurrentUserInfo();
            for (const osId of selectedOS) {
                try {
                    const os = batchOSData.find(o => (o.Chave || o.Cahve) == osId);
                    if (os) {
                        if ((userInfo?.usuario || '').toLowerCase().includes('bruna')) {
                            const tipoOk = (os.Tipo || '').toLowerCase() === 'Interna'.toLowerCase();
                            const revOk = ['1','2','4'].includes(String(os.Revenda || ''));
                            if (!tipoOk || !revOk) {
                                continue;
                            }
                        }
                        const statusAnterior = extrairStatusDaObservacao(os.Observacao);
                        // Extrai a observa√ß√£o atual sem o status
                        const observacaoAtual = extrairObservacaoSemStatus(os.Observacao);
                        // Combina com o novo status
                        const novaObservacao = combinarStatusEObservacao(novoStatus, observacaoAtual);
                        
                        const updateData = {
                            'Observacao': novaObservacao
                        };
                        
                        const { error } = await supabase
                            .from(tabelaBase)
                            .update(updateData)
                            .eq('Chave', osId);
                        
                        if (error) {
                            console.error(`Erro ao atualizar status da OS ${osId}:`, error);
                            errors++;
                        } else {
                            processed++;
                            // Log da altera√ß√£o de status
                            try {
                                await logStatusChangeEntry({
                                    osId: osId,
                                    nroOS: os['Numero OS'],
                                    revenda: os.Revenda,
                                    tipoOS: os.Tipo,
                                    statusAnterior,
                                    statusNovo: novoStatus
                                });
                            } catch(e) { console.warn('Falha ao logar altera√ß√£o (lote):', e); }
                        }
                    }
                } catch (error) {
                    console.error(`Erro ao processar OS ${osId}:`, error);
                    errors++;
                }
            }
            
            if (errors > 0) {
                alert(`${processed} OS atualizadas com status "${novoStatus}"! ${errors} erros encontrados.`);
            } else {
                alert(`${processed} OS atualizadas com status "${novoStatus}"!`);
            }
            
            clearSelection();
            loadBatchOS();
        }

        async function searchIndividualOS() {
            const osEl = document.getElementById('individual-nro-os');
            const nroOS = ((osEl && osEl.value) || '').trim();
            if (!nroOS) return alert('Digite o n√∫mero!');
            
            try {
                const { data, error } = await supabase.from(tabelaBase).select('*').eq('Numero OS', nroOS).limit(1);
                if (error) throw error;
                if (!data.length) return alert('OS n√£o encontrada.');
                
                const os = data[0];
                const status = extrairStatusDaObservacao(os.Observacao);
                const observacaoReal = extrairObservacaoSemStatus(os.Observacao);
                
                const sitEl = document.getElementById('individual-situacao');
                const statusEl = document.getElementById('individual-status');
                const obsEl = document.getElementById('individual-observacao');
                const acaoEl = document.getElementById('individual-acao-atualizacao');
                const formEl = document.getElementById('individual-os-form');
                if (sitEl) sitEl.value = os['Situacao OS'] || 'Aberta';
                if (statusEl) statusEl.value = status;
                if (obsEl) obsEl.value = observacaoReal || '';
                if (acaoEl) acaoEl.value = os['Acao / Atualizacao'] || '';
                formEl.dataset.osId = os.Chave || os.Cahve;
                formEl.dataset.prevStatus = status || '';
                formEl.dataset.nroOs = os['Numero OS'] || '';
                formEl.dataset.revenda = os.Revenda || '';
                const formShow = document.getElementById('individual-os-form');
                if (formShow) formShow.style.display = 'block';
            } catch (error) {
                alert('Erro ao buscar OS: ' + error.message);
            }
        }

        async function updateIndividualOS() {
            const formEl = document.getElementById('individual-os-form');
            const osId = formEl ? formEl.dataset.osId : '';
            if (!osId) {
                alert('Erro: ID da OS n√£o encontrado!');
                return;
            }
            
            try {
                const sitEl = document.getElementById('individual-situacao');
                const statusEl = document.getElementById('individual-status');
                const obsEl = document.getElementById('individual-observacao');
                const acaoEl = document.getElementById('individual-acao-atualizacao');
                const situacaoNova = sitEl ? sitEl.value : '';
                const statusNovo = statusEl ? statusEl.value : '';
                const observacao = obsEl ? obsEl.value : '';
                const acaoAtualizacao = acaoEl ? acaoEl.value : '';
                
                // Combina status e observa√ß√£o
                const observacaoComStatus = combinarStatusEObservacao(statusNovo, observacao);
                
                let updateData = {
                    'Situacao OS': situacaoNova,
                    'Observacao': observacaoComStatus,
                    'Acao / Atualizacao': acaoAtualizacao
                };
                
                if (situacaoNova === 'Fechada') {
                    const { data: os } = await supabase.from(tabelaBase).select('Emissao').eq('Chave', osId).single();
                    if (os) updateData['Dias'] = calculateDaysRobust(os.Emissao);
                }
                
                const { error } = await supabase.from(tabelaBase).update(updateData).eq('Chave', osId);
                if (error) throw error;
                
                // Log da altera√ß√£o individual
                try {
                    const formEl = document.getElementById('individual-os-form');
                    await logStatusChangeEntry({
                        osId: osId,
                        nroOS: formEl.dataset.nroOs || '',
                        revenda: formEl.dataset.revenda || '',
                        tipoOS: formEl.dataset.tipo || '',
                        statusAnterior: formEl.dataset.prevStatus || '',
                        statusNovo: statusNovo
                    });
                } catch(e) { console.warn('Falha ao logar altera√ß√£o (individual):', e); }

                alert('OS atualizada com sucesso!');
                const formShow = document.getElementById('individual-os-form');
                if (formShow) formShow.style.display = 'none';
            } catch (error) {
                console.error('Erro ao atualizar OS individual:', error);
                alert('Erro ao atualizar OS: ' + error.message);
            }
        }

        // --- FUN√á√ïES AUXILIARES ---

        function applyFilters(tab, data) {
            const revendaSelect = document.getElementById(`filter-revenda-${tab}`);
            const nroEl = document.getElementById(`filter-nro-os-${tab}`);
            const sitEl = document.getElementById(`filter-situacao-${tab}`);
            const diasEl = document.getElementById(`filter-dias-${tab}`);
            const statusEl = document.getElementById(`filter-status-${tab}`);
            const escEl = document.getElementById(`filter-escalonamento-${tab}`);
            const nroOs = ((nroEl && nroEl.value) || '').toLowerCase();
            const situacao = sitEl ? sitEl.value : '';
            const diasFilter = diasEl ? diasEl.value : '';
            const statusFilter = statusEl ? statusEl.value : '';
            const escalonamento = escEl ? escEl.value : '';

            // Obter valores selecionados do filtro m√∫ltiplo de revenda
            const selectedRevendas = revendaSelect ? Array.from(revendaSelect.selectedOptions).map(option => option.value) : [];

            // Perfil: restringe dados para usu√°rio padr√£o ao seu escalonamento
            const currentUser = window.NormaQCurrentUser || (JSON.parse(localStorage.getItem('authUser')) || null);
            const restrictByUser = !!(currentUser && !(currentUser.is_admin || currentUser.tipo_usuario === 'Administrador') && currentUser.tipo_usuario !== 'Gestor');
            const normalize = (str) => (str || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
            const getUserEscLabel = (nomeCompleto) => {
                const parts = (nomeCompleto || '').trim().split(/\s+/);
                const first = parts[0] || '';
                const second = parts[1] || '';
                const two = `${first} ${second}`.trim();
                const twoNorm = normalize(two);
                if (twoNorm.startsWith('ana leya')) return 'Ana Leya';
                if (twoNorm.startsWith('antonio gustavo')) return 'Ant√¥nio Gustavo';
                return first || '';
            };
            const userEscNorm = restrictByUser ? normalize(getUserEscLabel(currentUser?.nome_completo || '')) : '';

            return data.filter(os => {
                const cu = window.NormaQCurrentUser || (JSON.parse(localStorage.getItem('authUser')) || null);
                const isBruna = cu && ((cu.usuario || '').toLowerCase().includes('bruna') || (cu.nome_completo || '').toLowerCase().includes('bruna'));
                if (isBruna) {
                    if (tab === 'externa') return false;
                    const osRev = String(os.Revenda || '');
                    if (tab === 'interna' && osRev === '3') return false;
                }
                // Filtro de revenda (m√∫ltipla sele√ß√£o) - CORRE√á√ÉO MELHORADA
                if (selectedRevendas.length > 0) {
                    // Converte ambos os valores para string para garantir compatibilidade
                    const osRevenda = String(os.Revenda || '');
                    const hasMatchingRevenda = selectedRevendas.some(rev => String(rev) === osRevenda);
                    
                    if (!hasMatchingRevenda) {
                        return false;
                    }
                }
                
                if (nroOs && (os['Numero OS'] || '').toString().toLowerCase() !== nroOs.toLowerCase()) return false;
                if (situacao && os['Situacao OS'] !== situacao) return false;
                
                // Filtro de status usando a extra√ß√£o da observa√ß√£o
                const status = extrairStatusDaObservacao(os.Observacao);
                if (statusFilter && status !== statusFilter) return false;

                // Filtra baseado na coluna 'Dias em Aberto'
                const diasEmAberto = calcularDiasEmAberto(os);

                if (diasFilter) {
                    if (diasFilter.includes('+')) {
                        const minDias = parseInt(diasFilter);
                        if (diasEmAberto < minDias) return false;
                    } else {
                        const [min, max] = diasFilter.split('-').map(Number);
                        if (diasEmAberto < min || diasEmAberto > max) return false;
                    }
                }
                const escCalc = getEscalonamento(tab, diasEmAberto, os.Revenda);
                if (escalonamento && escCalc !== escalonamento) return false;
                // Modificado: Permite que usu√°rios vejam OS que est√£o com eles E que sa√≠ram deles
                if (restrictByUser) {
                    const escNorm = normalize(escCalc);
                    const userEscNorm = normalize(getUserEscLabel(currentUser?.nome_completo || ''));
                    
                    // Verifica se a OS est√° atualmente com o usu√°rio
                    const isCurrentlyWithUser = escNorm === userEscNorm;
                    
                    // Verifica se a OS j√° pertenceu ao usu√°rio (saiu dele)
                    let hasBelongedToUser = false;
                    
                    // Para Ana Leya: verifica se a OS j√° foi dela (0-10 dias para interna e externa)
                    if (userEscNorm.includes('ana leya') || userEscNorm.includes('ana leia')) {
                        if (tab === 'interna' || tab === 'externa') {
                            const diasParaAna = getEscalonamentoLimit(tab, 'Ana Leya', os.Revenda);
                            if (diasEmAberto > diasParaAna) {
                                hasBelongedToUser = true;
                            }
                        }
                    }
                    
                    // Para Isabelle: verifica se a OS j√° foi dela (0-10 dias para externa)
                    if (userEscNorm.includes('isabelle')) {
                        if (tab === 'externa') {
                            const diasParaIsabelle = getEscalonamentoLimit('externa', 'Isabelle', os.Revenda);
                            if (diasEmAberto > diasParaIsabelle) {
                                hasBelongedToUser = true;
                            }
                        }
                    }
                    
                    // Para Bruna: verifica se a OS j√° foi dela (0-10 dias para interna)
                    if (userEscNorm.includes('bruna')) {
                        if (tab === 'interna') {
                            const diasParaBruna = getEscalonamentoLimit('interna', 'Bruna', os.Revenda);
                            if (diasEmAberto > diasParaBruna) {
                                hasBelongedToUser = true;
                            }
                        }
                    }
                    
                    // Para Graziela: verifica se a OS j√° foi dela (16-20 dias)
                    if (userEscNorm.includes('graziela')) {
                        const diasParaGraziela = getEscalonamentoLimit(tab, 'Graziela', os.Revenda);
                        if (diasEmAberto > diasParaGraziela) {
                            hasBelongedToUser = true;
                        }
                    }
                    
                    // Para Fl√°via: verifica se a OS j√° foi dela (0-25 dias para garantia)
                    if (userEscNorm.includes('flavia') || userEscNorm.includes('fl√°via')) {
                        if (tab === 'garantia') {
                            const diasParaFlavia = getEscalonamentoLimit('garantia', 'Fl√°via', os.Revenda);
                            if (diasEmAberto > diasParaFlavia) {
                                hasBelongedToUser = true;
                            }
                        }
                    }
                    
                    // Para Giovana: verifica se a OS j√° foi dela (0-25 dias para garantia)
                    if (userEscNorm.includes('giovana')) {
                        if (tab === 'garantia') {
                            const diasParaGiovana = getEscalonamentoLimit('garantia', 'Giovana', os.Revenda);
                            if (diasEmAberto > diasParaGiovana) {
                                hasBelongedToUser = true;
                            }
                        }
                    }
                    
                    // Para Wanderley: verifica se a OS j√° foi dele (11-15 dias para revenda 3)
                    if (userEscNorm.includes('wanderley')) {
                        const diasParaWanderley = getEscalonamentoLimit(tab, 'Wanderley', os.Revenda);
                        if (diasEmAberto > diasParaWanderley && os.Revenda?.toString() === '3') {
                            hasBelongedToUser = true;
                        }
                    }
                    
                    // Permite visualiza√ß√£o se a OS est√° atualmente com o usu√°rio OU j√° foi dele
                    if (!isCurrentlyWithUser && !hasBelongedToUser) {
                        return false;
                    }
                }
                return true;
            });
        }
        
        function getDiasClass(tab, dias) {
            // Protege contra valores inv√°lidos
            if (!Number.isFinite(dias) || dias < 0) dias = 0;
            // Usa apenas classes CSS existentes: dias-0-10, dias-11-15, dias-16-20, dias-21-30, dias-30-plus
            if (tab === 'garantia') {
                if (dias <= 25) return 'dias-0-10';
                if (dias <= 35) return 'dias-11-15';
                if (dias <= 50) return 'dias-16-20';
                if (dias <= 90) return 'dias-21-30';
                return 'dias-30-plus';
            } else {
                if (dias <= 10) return 'dias-0-10';
                if (dias <= 15) return 'dias-11-15';
                if (dias <= 20) return 'dias-16-20';
                if (dias <= 30) return 'dias-21-30';
                return 'dias-30-plus';
            }
        }

function getEscalonamento(tab, dias, revenda) {
            // Normaliza valores
            if (!Number.isFinite(dias) || dias < 0) dias = 0;
            const revendaNum = revenda ? revenda.toString() : '';

            // Garantia: regra acordada
            if (tab === 'garantia') {
                // 0‚Äì25 dias
                if (dias <= 25) {
                    if (['1', '4'].includes(revendaNum)) return 'Fl√°via';
                    if (['2', '3'].includes(revendaNum)) return 'Giovana';
}

function getEscalonamentoChain(tipo, revenda) {
    const r = String(revenda || '').toString();
    const is3 = r === '3';
    const is1 = r === '1';
    const is2 = r === '2';
    const is4 = r === '4';
    const t = (String(tipo || '').toLowerCase());
    if (t === 'garantia') {
        if (is3) return ['Giovana', 'Wanderley', 'Graziela', 'Johnny', 'Ant√¥nio Gustavo'];
        if (is1 || is4) return ['Fl√°via', 'Graziela', 'Johnny', 'Ant√¥nio Gustavo'];
        if (is2) return ['Giovana', 'Graziela', 'Johnny', 'Ant√¥nio Gustavo'];
        return ['Giovana', 'Graziela', 'Johnny', 'Ant√¥nio Gustavo'];
    }
    if (t === 'interna') {
        if (is3) return ['Ana Leya', 'Wanderley', 'Graziela', 'Johnny', 'Ant√¥nio Gustavo'];
        if (is1 || is2 || is4) return ['Bruna', 'Graziela', 'Johnny', 'Ant√¥nio Gustavo'];
        return ['Bruna', 'Graziela', 'Johnny', 'Ant√¥nio Gustavo'];
    }
    // externa
    if (is3) return ['Ana Leya', 'Wanderley', 'Graziela', 'Johnny', 'Ant√¥nio Gustavo'];
    if (is1 || is2 || is4) return ['Isabelle', 'Graziela', 'Johnny', 'Ant√¥nio Gustavo'];
    return ['Isabelle', 'Graziela', 'Johnny', 'Ant√¥nio Gustavo'];
}

function normalizeNomeResponsavel(s) {
    return String(s || '').trim().normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
}

function getAllowedPrevious(escalonamentoAtual, tipo, revenda, dias) {
    const chain = getEscalonamentoChain(tipo, revenda);
    const normChain = chain.map(normalizeNomeResponsavel);
    const idx = normChain.indexOf(normalizeNomeResponsavel(escalonamentoAtual));
    if (idx <= 0) return null;
    return chain[idx - 1];
}

function getPrevEscalonamentoByDias(tipo, dias, revenda) {
    try {
        let prevDias = Number.isFinite(dias) ? Math.max(0, Math.floor(dias) - 1) : 0;
        return getEscalonamento(tipo, prevDias, revenda);
    } catch(_) { return null; }
}
                // 26‚Äì50 dias
                if (dias <= 50) {
                    if (revendaNum === '3') {
                        if (dias <= 35) return 'Wanderley';
                        return 'Graziela';
                    }
                    // Revendas 1, 2 e 4
                    return 'Graziela';
                }
                // 50‚Äì90 dias
                if (dias <= 90) return 'Johnny';
                // 90+ dias
                return 'Ant√¥nio Gustavo';
            }

            // Externa e Interna com regra por faixas de dias
            // 0‚Äì10 dias: respons√°veis de primeira linha (Isabelle/Ana Leya/Bruna)
            if (dias <= 10) {
                if (tab === 'externa') {
                    if (['1', '2', '4'].includes(revendaNum)) return 'Isabelle';
                    if (revendaNum === '3') return 'Ana Leya';
                    return 'Isabelle';
                }
                if (tab === 'interna') {
                    if (revendaNum === '3') return 'Ana Leya';
                    if (['1', '2', '4'].includes(revendaNum)) return 'Bruna';
                    return 'Bruna';
                }
            }

            // 11‚Äì15 dias: Wanderley (revenda 3), caso contr√°rio segue para Graziela
            if (dias <= 15) {
                if (revendaNum === '3') return 'Wanderley';
                return 'Graziela';
            }

            // 16‚Äì20 dias: Graziela
            if (dias <= 20) return 'Graziela';
            // 21‚Äì30 dias: passa para Johnny
            if (dias <= 30) return 'Johnny';
            // 30+ dias: passa para Ant√¥nio Gustavo
            return 'Ant√¥nio Gustavo';
        }
        
        function showLoading(tab) {
            let tbody = document.getElementById(`tbody-${tab}`);
            if (!tbody) {
                tbody = document.getElementById(`tbody-transferencia-${tab}`);
            }
            if (tbody) {
                tbody.innerHTML = `<tr><td colspan="15"><div class="loading"><div class="spinner"></div></div></td></tr>`;
            }
        }
        
        function showErrorMessage(msg) {
            const el = document.getElementById('error-message');
            if (el) {
                el.textContent = msg;
                el.style.display = 'block';
            }
            console.error(msg);
        }

        function showSuccessMessage(msg) {
            const el = document.getElementById('success-message');
            const textEl = document.getElementById('success-message-text');
            if (el) {
                if (textEl) textEl.textContent = msg;
                el.style.display = 'flex';
            }
            console.log(msg);
        }

        function hideMessages() {
            const err = document.getElementById('error-message');
            const ok = document.getElementById('success-message');
            if (err) err.style.display = 'none';
            if (ok) ok.style.display = 'none';
        }
        
        // --- CORRE√á√ÉO DOS TOTAIS ---
        function updateTotals(tab) {
            const data = osData[tab] || [];
            const filteredData = applyFilters(tab, data);
            
            // Calcula totais apenas dos dados filtrados
            const totalPecas = filteredData.reduce((sum, os) => sum + (parseFloat(os['Total Pecas']) || 0), 0);
            const totalServico = filteredData.reduce((sum, os) => sum + (parseFloat(os['Total Servico']) || 0), 0);
            const totalOS = filteredData.reduce((sum, os) => sum + (parseFloat(os['Total OS']) || 0), 0);
            
            // Formata valores
            const formatCurrency = (value) => {
                return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
            };
            
            // Atualiza elementos HTML
            const totalPecasEl = document.getElementById(`total-pecas-${tab}`);
            if (totalPecasEl) totalPecasEl.textContent = formatCurrency(totalPecas);

            const totalServicoEl = document.getElementById(`total-servico-${tab}`);
            if (totalServicoEl) totalServicoEl.textContent = formatCurrency(totalServico);

            const totalOsEl = document.getElementById(`total-os-${tab}`);
            if (totalOsEl) totalOsEl.textContent = formatCurrency(totalOS);

            const totalGeralEl = document.getElementById(`total-geral-${tab}`);
            if (totalGeralEl) totalGeralEl.textContent = `Total Geral de OS: ${filteredData.length}`;
        }
        
        // --- FUN√á√ïES DO DASHBOARD - ATUALIZADAS ---
        async function loadDashboardData() {
            try {
                const { data, error } = await supabase.from(tabelaBase).select('*');
                if (error) throw error;
                
                // Aplica filtros do dashboard
                const filteredData = applyDashboardFilters(data || []);
                
                // Atualiza totais do dashboard
                updateDashboardTotals(filteredData);
                
                // Gera gr√°ficos
                generateCharts(filteredData);
            } catch (error) {
                console.error('Erro ao carregar dados do dashboard:', error);
            }
        }
        
        function applyDashboardFilters(data) {
            const revEl = document.getElementById('dashboard-filter-revenda');
            const sitEl = document.getElementById('dashboard-filter-situacao');
            const staEl = document.getElementById('dashboard-filter-status');
            const escEl = document.getElementById('dashboard-filter-escalonamento');
            const tipoEl = document.getElementById('dashboard-filter-tipo');
            const revenda = revEl ? revEl.value : '';
            const situacao = sitEl ? sitEl.value : '';
            const status = staEl ? staEl.value : '';
            const escalonamento = escEl ? escEl.value : '';
            const tipo = tipoEl ? tipoEl.value : '';
            
            return data.filter(os => {
                // Filtro de revenda
                if (revenda && String(os.Revenda) !== String(revenda)) return false;
                
                // Filtro de situa√ß√£o OS
                if (situacao && os['Situacao OS'] !== situacao) return false;
                
                // Filtro de status
                const osStatus = extrairStatusDaObservacao(os.Observacao);
                if (status && osStatus !== status) return false;
                
                // Filtro de escalonamento
                const diasEmAberto = calcularDiasEmAberto(os);
                const osEscalonamento = getEscalonamento(os.Tipo?.toLowerCase() || 'externa', diasEmAberto, os.Revenda);
                if (escalonamento && osEscalonamento !== escalonamento) return false;
                
                // Filtro de tipo de OS
                if (tipo && os.Tipo !== tipo) return false;
                
                return true;
            });
        }
        
        function updateDashboardTotals(data) {
            const totalPecas = data.reduce((sum, os) => sum + (parseFloat(os['Total Pecas']) || 0), 0);
            const totalServico = data.reduce((sum, os) => sum + (parseFloat(os['Total Servico']) || 0), 0);
            const totalOS = data.reduce((sum, os) => sum + (parseFloat(os['Total OS']) || 0), 0);
            
            const formatCurrency = (value) => {
                return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
            };
            
            document.getElementById('dashboard-total-pecas').textContent = formatCurrency(totalPecas);
            document.getElementById('dashboard-total-servico').textContent = formatCurrency(totalServico);
            document.getElementById('dashboard-total-os').textContent = formatCurrency(totalOS);
            document.getElementById('dashboard-total-geral').textContent = data.length;
        }
        
        function generateCharts(data) {
            // Destruir gr√°ficos existentes antes de criar novos
            const chartIds = [
                'chart-os-status', 'chart-os-revenda', 
                'chart-os-dias-garantia', 'chart-os-dias-todas', 'chart-os-escalonamento', 
                'chart-os-tipo', 'chart-valores-tipo'
            ];
            
            chartIds.forEach(chartId => {
                const chartInstance = Chart.getChart(chartId);
                if (chartInstance) {
                    chartInstance.destroy();
                }
            });
            
            // Gr√°fico de OS por Status - COM R√ìTULOS (AGORA MAIS LARGO)
            const statusCount = {};
            data.forEach(os => {
                const status = extrairStatusDaObservacao(os.Observacao);
                statusCount[status] = (statusCount[status] || 0) + 1;
            });
            
            const statusChart = new Chart(document.getElementById('chart-os-status'), {
                type: 'bar',
                data: {
                    labels: Object.keys(statusCount),
                    datasets: [{
                        label: 'Quantidade de OS',
                        data: Object.values(statusCount),
                        backgroundColor: '#FCB026'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Quantidade: ${context.raw}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantidade de OS'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Status'
                            }
                        }
                    }
                }
            });
            
            // Gr√°fico de OS por Revenda - COM R√ìTULOS
            const revendaCount = {};
            data.forEach(os => {
                const revenda = revendasMap[os.Revenda] || os.Revenda;
                revendaCount[revenda] = (revendaCount[revenda] || 0) + 1;
            });
            
            const revendaChart = new Chart(document.getElementById('chart-os-revenda'), {
                type: 'pie',
                data: {
                    labels: Object.keys(revendaCount),
                    datasets: [{
                        data: Object.values(revendaCount),
                        backgroundColor: ['#FCB026', '#28a745', '#17a2b8', '#6f42c1', '#fd7e14']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // NOVO: Gr√°fico de OS por Dias (apenas Garantia)
            const garantiaData = data.filter(os => os.Tipo === 'Garantia');
            const diasRangesGarantia = ['0-25', '26-35', '36-50', '51-90', '90+'];
            const diasCountGarantia = {
                '0-25': 0,
                '26-35': 0,
                '36-50': 0,
                '51-90': 0,
                '90+': 0
            };
            
            garantiaData.forEach(os => {
                const dias = calcularDiasEmAberto(os);
                if (dias <= 25) diasCountGarantia['0-25']++;
                else if (dias <= 35) diasCountGarantia['26-35']++;
                else if (dias <= 50) diasCountGarantia['36-50']++;
                else if (dias <= 90) diasCountGarantia['51-90']++;
                else diasCountGarantia['90+']++;
            });
            
            const diasGarantiaChart = new Chart(document.getElementById('chart-os-dias-garantia'), {
                type: 'bar',
                data: {
                    labels: diasRangesGarantia,
                    datasets: [{
                        label: 'Quantidade de OS (Garantia)',
                        data: Object.values(diasCountGarantia),
                        backgroundColor: '#17a2b8'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Quantidade: ${context.raw}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantidade de OS'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Faixa de Dias (Garantia)'
                            }
                        }
                    }
                }
            });
            
            // NOVO: Gr√°fico de OS por Dias (Todas, Externa, Interna)
            const tiposParaGrafico = ['Externa', 'Interna'];
            const diasRangesTodas = ['0-10', '11-15', '16-20', '21-30', '30+'];
            
            // Preparar dados para o gr√°fico
            const datasetsTodas = tiposParaGrafico.map(tipo => {
                const osDoTipo = data.filter(os => os.Tipo === tipo);
                const diasCount = {
                    '0-10': 0,
                    '11-15': 0,
                    '16-20': 0,
                    '21-30': 0,
                    '30+': 0
                };
                
                osDoTipo.forEach(os => {
                    const dias = calcularDiasEmAberto(os);
                    if (dias <= 10) diasCount['0-10']++;
                    else if (dias <= 15) diasCount['11-15']++;
                    else if (dias <= 20) diasCount['16-20']++;
                    else if (dias <= 30) diasCount['21-30']++;
                    else diasCount['30+']++;
                });
                
                return {
                    label: tipo,
                    data: Object.values(diasCount),
                    backgroundColor: tipo === 'Externa' ? '#FCB026' : '#28a745'
                };
            });
            
            // Adicionar dados de "Todas" (Externa + Interna)
            const todasData = data.filter(os => tiposParaGrafico.includes(os.Tipo));
            const diasCountTodas = {
                '0-10': 0,
                '11-15': 0,
                '16-20': 0,
                '21-30': 0,
                '30+': 0
            };
            
            todasData.forEach(os => {
                const dias = calcularDiasEmAberto(os);
                if (dias <= 10) diasCountTodas['0-10']++;
                else if (dias <= 15) diasCountTodas['11-15']++;
                else if (dias <= 20) diasCountTodas['16-20']++;
                else if (dias <= 30) diasCountTodas['21-30']++;
                else diasCountTodas['30+']++;
            });
            
            datasetsTodas.unshift({
                label: 'Todas',
                data: Object.values(diasCountTodas),
                backgroundColor: '#6f42c1'
            });
            
            const diasTodasChart = new Chart(document.getElementById('chart-os-dias-todas'), {
                type: 'bar',
                data: {
                    labels: diasRangesTodas,
                    datasets: datasetsTodas
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantidade de OS'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Faixa de Dias'
                            }
                        }
                    }
                }
            });
            
            // Gr√°fico de OS por Escalonamento - COM R√ìTULOS
            const escalonamentoCount = {};
            data.forEach(os => {
                const dias = calcularDiasEmAberto(os);
                const escalonamento = getEscalonamento(os.Tipo?.toLowerCase() || 'externa', dias, os.Revenda);
                escalonamentoCount[escalonamento] = (escalonamentoCount[escalonamento] || 0) + 1;
            });
            
            const escalonamentoChart = new Chart(document.getElementById('chart-os-escalonamento'), {
                type: 'pie',
                data: {
                    labels: Object.keys(escalonamentoCount),
                    datasets: [{
                        data: Object.values(escalonamentoCount),
                        backgroundColor: ['#FCB026', '#28a745', '#17a2b8', '#6f42c1', '#fd7e14', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Gr√°fico de OS por Tipo - COM R√ìTULOS
            const tipoCount = {};
            data.forEach(os => {
                const tipo = os.Tipo || 'N√£o especificado';
                tipoCount[tipo] = (tipoCount[tipo] || 0) + 1;
            });
            
            const tipoChart = new Chart(document.getElementById('chart-os-tipo'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(tipoCount),
                    datasets: [{
                        data: Object.values(tipoCount),
                        backgroundColor: ['#FCB026', '#28a745', '#17a2b8']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // NOVO GR√ÅFICO: Valores por Tipo de OS
            const valorEl = document.getElementById('valor-filter-select');
            const valorFilter = valorEl ? valorEl.value : 'todas';
            const tipos = ['Externa', 'Interna', 'Garantia'];
            
            const valoresData = tipos.map(tipo => {
                const osDoTipo = data.filter(os => os.Tipo === tipo);
                let valorTotal = 0;
                
                if (valorFilter === 'todas') {
                    valorTotal = osDoTipo.reduce((sum, os) => sum + (parseFloat(os['Total OS']) || 0), 0);
                } else if (valorFilter === 'pecas') {
                    valorTotal = osDoTipo.reduce((sum, os) => sum + (parseFloat(os['Total Pecas']) || 0), 0);
                } else if (valorFilter === 'servicos') {
                    valorTotal = osDoTipo.reduce((sum, os) => sum + (parseFloat(os['Total Servico']) || 0), 0);
                }
                
                return valorTotal;
            });

            const valoresTipoChart = new Chart(document.getElementById('chart-valores-tipo'), {
                type: 'bar',
                data: {
                    labels: tipos,
                    datasets: [{
                        label: `Valor Total (${valorFilter === 'todas' ? 'Todas' : valorFilter === 'pecas' ? 'Pe√ßas' : 'Servi√ßos'})`,
                        data: valoresData,
                        backgroundColor: ['#FCB026', '#28a745', '#17a2b8'],
                        borderColor: ['#E5B000', '#218838', '#138496'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw || 0;
                                    return `Valor: R$ ${value.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Valor (R$)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Tipo de OS'
                            }
                        }
                    }
                }
            });
            
            console.log('Gr√°ficos gerados com sucesso para', data.length, 'OS');
        }

        // --- FUN√á√ïES PARA A ABA DE ALERTAS ---
        const TABELA_ALERTAS_CONFIG = 'alertas_config';
        const TABELA_NOTIFICACOES = 'historico_notificacoes';

        async function fetchAlertasConfigSupabase() {
            try {
                const { data, error } = await supabase
                    .from(TABELA_ALERTAS_CONFIG)
                    .select('*')
                    .order('updated_at', { ascending: false });
                if (error) throw error;
                if (!data || data.length === 0) {
                    return JSON.parse(localStorage.getItem('alertasConfig')) || [];
                }
                const byUser = new Map();
                (data||[]).forEach(a => {
                    const k = a.usuario || '';
                    if (!k) return;
                    const prev = byUser.get(k);
                    if (!prev) byUser.set(k, a); else {
                        const tPrev = prev.updated_at ? Date.parse(prev.updated_at) : 0;
                        const tCur = a.updated_at ? Date.parse(a.updated_at) : 0;
                        if (tCur >= tPrev) byUser.set(k, a);
                    }
                });
                return Array.from(byUser.values());
            } catch (_) {
                return JSON.parse(localStorage.getItem('alertasConfig')) || [];
            }
        }

        async function upsertAlertaSupabase(alerta) {
            try {
                const payload = {
                    usuario: alerta.usuario,
                    email: alerta.email,
                    dias: alerta.dias,
                    ativo: alerta.ativo !== false,
                    updated_at: new Date().toISOString()
                };
                const { error } = await supabase
                    .from(TABELA_ALERTAS_CONFIG)
                    .upsert(payload, { onConflict: 'usuario' })
                    .select();
                if (error) throw error;
                return true;
            } catch (_) {
                const alertas = JSON.parse(localStorage.getItem('alertasConfig')) || [];
                const i = alertas.findIndex(a => a.usuario === alerta.usuario);
                if (i >= 0) alertas[i] = alerta; else alertas.push(alerta);
                localStorage.setItem('alertasConfig', JSON.stringify(alertas));
                return true;
            }
        }

        async function deleteAlertaSupabase(usuario) {
            try {
                const { error } = await supabase
                    .from(TABELA_ALERTAS_CONFIG)
                    .delete()
                    .eq('usuario', usuario);
                if (error) throw error;
                return true;
            } catch (_) {
                const alertas = JSON.parse(localStorage.getItem('alertasConfig')) || [];
                const i = alertas.findIndex(a => a.usuario === usuario);
                if (i >= 0) alertas.splice(i, 1);
                localStorage.setItem('alertasConfig', JSON.stringify(alertas));
                return true;
            }
        }

        async function fetchHistoricoNotificacoesSupabase(limit = 100) {
            try {
                const { data, error } = await supabase
                    .from(TABELA_NOTIFICACOES)
                    .select('*')
                    .order('data', { ascending: false })
                    .limit(limit);
                if (error) throw error;
                if (!data || data.length === 0) {
                    return JSON.parse(localStorage.getItem('historicoNotificacoes')) || [];
                }
                return data;
            } catch (_) {
                return JSON.parse(localStorage.getItem('historicoNotificacoes')) || [];
            }
        }

        async function insertHistoricoNotificacaoSupabase(record) {
            const payload = {
                tipo: record.tipo,
                titulo: record.titulo,
                mensagem: record.mensagem,
                destinatario: record.destinatario,
                usuario: record.usuario,
                data: new Date().toISOString(),
                enviado: !!record.enviado,
                erro: record.erro || null,
                quantidadeos: (record.quantidadeOS ?? record.quantidadeos ?? 0)
            };
            try {
                const { error } = await supabase
                    .from(TABELA_NOTIFICACOES)
                    .insert(payload)
                    .select();
                if (error) throw error;
                return true;
            } catch (e) {
                try {
                    console.error('Falha ao salvar no Supabase (historico_notificacoes):', e);
                    const msg = e?.message || e?.details || e?.hint || JSON.stringify(e);
                    alert('Falha ao salvar hist√≥rico no Supabase: ' + msg + '\nUsando armazenamento local tempor√°rio.');
                } catch(_) {}
                const notificacoes = JSON.parse(localStorage.getItem('historicoNotificacoes')) || [];
                notificacoes.unshift({ ...payload, quantidadeOS: payload.quantidadeos, data: new Date().toLocaleString('pt-BR') });
                localStorage.setItem('historicoNotificacoes', JSON.stringify(notificacoes));
                return true;
            }
        }

        async function shouldSkipNotification({ tipo, usuario, destinatario, titulo, mensagem, windowMinutes = 30 }) {
            try {
                const sinceIso = new Date(Date.now() - windowMinutes * 60 * 1000).toISOString();
                let q = supabase
                    .from(TABELA_NOTIFICACOES)
                    .select('id,tipo,usuario,destinatario,titulo,mensagem,data,enviado')
                    .gte('data', sinceIso)
                    .eq('tipo', tipo)
                    .eq('usuario', usuario)
                    .eq('destinatario', destinatario)
                    .order('data', { ascending: false })
                    .limit(10);
                const { data, error } = await q;
                const norm = s => String(s||'').replace(/\s+/g,' ').trim();
                if (!error && Array.isArray(data)) {
                    const found = data.some(r => norm(r.titulo) === norm(titulo) && norm(r.mensagem) === norm(mensagem) && r.enviado);
                    if (found) return true;
                }
            } catch(_) {}
            try {
                const local = JSON.parse(localStorage.getItem('historicoNotificacoes') || '[]');
                const cutoff = Date.now() - windowMinutes * 60 * 1000;
                const norm = s => String(s||'').replace(/\s+/g,' ').trim();
                const foundLocal = (local||[]).some(r => {
                    const d = new Date(r.data);
                    const okTime = d instanceof Date && !isNaN(d) ? (d.getTime() >= cutoff) : true;
                    return okTime && r.tipo === tipo && r.usuario === usuario && r.destinatario === destinatario && norm(r.titulo) === norm(titulo) && norm(r.mensagem) === norm(mensagem) && r.enviado;
                });
                if (foundLocal) return true;
            } catch(_) {}
            return false;
        }

        function extractOSNumbersFromText(text) {
            try {
                const s = String(text || '');
                const matches = s.match(/\bOS\s*(\d+)\b/gi) || [];
                const nums = matches.map(m => (m.match(/\d+/) || [''])[0]).filter(Boolean);
                const uniq = Array.from(new Set(nums)).sort((a,b) => a.localeCompare(b));
                return uniq;
            } catch(_) { return []; }
        }

        async function shouldSkipNotificationByOSSet({ tipo, usuario, destinatario, osNumbers, windowMinutes = 1440 }) {
            try {
                const qb = supabase
                    .from(TABELA_NOTIFICACOES)
                    .select('id,tipo,usuario,destinatario,mensagem,data,enviado')
                    .in('tipo', [tipo, `${tipo}_pre`])
                    .eq('usuario', usuario)
                    .eq('destinatario', destinatario)
                    .order('data', { ascending: false })
                    .limit(300);
                if (windowMinutes != null) {
                    const sinceIso = new Date(Date.now() - windowMinutes * 60 * 1000).toISOString();
                    qb.gte('data', sinceIso);
                }
                const { data, error } = await qb;
                if (!error && Array.isArray(data)) {
                    const target = Array.from(new Set(osNumbers || [])).sort((a,b)=>a.localeCompare(b)).join(',');
                    const found = data.some(r => {
                        const cur = extractOSNumbersFromText(r.mensagem).join(',');
                        return cur === target;
                    });
                    if (found) return true;
                }
            } catch(_) {}
            try {
                const local = JSON.parse(localStorage.getItem('historicoNotificacoes') || '[]');
                const target = Array.from(new Set(osNumbers || [])).sort((a,b)=>a.localeCompare(b)).join(',');
                    const foundLocal = (local||[]).some(r => {
                        const d = new Date(r.data);
                        const okTime = windowMinutes == null ? true : (d instanceof Date && !isNaN(d) ? (d.getTime() >= Date.now() - windowMinutes * 60 * 1000) : true);
                        const cur = extractOSNumbersFromText(r.mensagem).join(',');
                        return okTime && (r.tipo === tipo || r.tipo === `${tipo}_pre`) && r.usuario === usuario && r.destinatario === destinatario && cur === target;
                    });
                if (foundLocal) return true;
            } catch(_) {}
            return false;
        }

        function sleep(ms) { return new Promise(res => setTimeout(res, ms)); }

        async function getPreviouslyNotifiedOSNumbers({ tipo, usuario, destinatario, windowMinutes = null, limit = 500 }) {
            try {
                const qb = supabase
                    .from(TABELA_NOTIFICACOES)
                    .select('mensagem,data')
                    .eq('tipo', tipo)
                    .eq('usuario', usuario)
                    .eq('destinatario', destinatario)
                    .order('data', { ascending: false })
                    .limit(limit);
                if (windowMinutes != null) {
                    const sinceIso = new Date(Date.now() - windowMinutes * 60 * 1000).toISOString();
                    qb.gte('data', sinceIso);
                }
                const { data, error } = await qb;
                const set = new Set();
                if (!error && Array.isArray(data)) {
                    data.forEach(r => {
                        extractOSNumbersFromText(r.mensagem).forEach(n => set.add(n));
                    });
                }
                try {
                    const local = JSON.parse(localStorage.getItem('historicoNotificacoes') || '[]');
                    (local||[]).filter(r => r.tipo === tipo && r.usuario === usuario && r.destinatario === destinatario).forEach(r => {
                        extractOSNumbersFromText(r.mensagem).forEach(n => set.add(n));
                    });
                } catch(_) {}
                return set;
            } catch(_) {
                return new Set();
            }
        }

        function isUserSendLocked({ tipo, usuario, windowMinutes = 1 }) {
            try {
                const key = `sendLock:${tipo}:${usuario}`;
                const raw = localStorage.getItem(key);
                if (!raw) return false;
                const ts = parseInt(raw, 10);
                return !isNaN(ts) && (Date.now() - ts) < windowMinutes * 60 * 1000;
            } catch(_) { return false; }
        }
        function setUserSendLock({ tipo, usuario }) {
            try {
                const key = `sendLock:${tipo}:${usuario}`;
                localStorage.setItem(key, String(Date.now()));
            } catch(_) {}
        }

        async function shouldCooldownUserSend({ tipo, usuario, destinatario, minutes = 60 }) {
            try {
                const { data, error } = await supabase
                    .from(TABELA_NOTIFICACOES)
                    .select('data,enviado')
                    .eq('tipo', tipo)
                    .eq('usuario', usuario)
                    .eq('destinatario', destinatario)
                    .order('data', { ascending: false })
                    .limit(1);
                if (!error && Array.isArray(data) && data.length > 0) {
                    const last = new Date(data[0].data).getTime();
                    if (!isNaN(last) && data[0].enviado && (Date.now() - last) < minutes * 60 * 1000) return true;
                }
            } catch(_) {}
            return false;
        }

        async function shouldCooldownAnySend({ usuario, destinatario, minutes = 60 }) {
            try {
                const { data, error } = await supabase
                    .from(TABELA_NOTIFICACOES)
                    .select('data,enviado')
                    .eq('usuario', usuario)
                    .eq('destinatario', destinatario)
                    .order('data', { ascending: false })
                    .limit(1);
                if (!error && Array.isArray(data) && data.length > 0) {
                    const last = new Date(data[0].data).getTime();
                    if (!isNaN(last) && data[0].enviado && (Date.now() - last) < minutes * 60 * 1000) return true;
                }
            } catch(_) {}
            return false;
        }
        async function importLocalToSupabase() {
            try {
                const localAlertas = JSON.parse(localStorage.getItem('alertasConfig')) || [];
                for (const a of localAlertas) {
                    await upsertAlertaSupabase({ usuario: a.usuario, email: a.email, dias: parseInt(a.dias), ativo: a.ativo !== false });
                }
                const localHistorico = JSON.parse(localStorage.getItem('historicoNotificacoes')) || [];
                for (const n of localHistorico) {
                    await insertHistoricoNotificacaoSupabase({ tipo: n.tipo || 'importado', titulo: n.titulo || '', mensagem: n.mensagem || '', destinatario: n.destinatario || '', usuario: n.usuario || '', enviado: !!n.enviado, erro: n.erro || null, quantidadeOS: n.quantidadeOS || 0 });
                }
                const alertas = await fetchAlertasConfigSupabase();
                const notificacoes = await fetchHistoricoNotificacoesSupabase();
                renderAlertasAtivos(alertas);
                renderHistoricoAlertas(notificacoes);
                alert(`Importa√ß√£o conclu√≠da: ${localAlertas.length} alertas, ${localHistorico.length} notifica√ß√µes`);
            } catch (e) {
                alert('Falha na importa√ß√£o: ' + (e?.message || 'Erro'));
            }
        }
        async function seedAlertasIfEmpty() {
            try {
                const supa = await fetchAlertasConfigSupabase();
                if (supa && supa.length > 0) return supa;
                const local = JSON.parse(localStorage.getItem('alertasConfig')) || [];
                if (!local || local.length === 0) return supa || [];
                for (const a of local) {
                    await upsertAlertaSupabase({ usuario: a.usuario, email: a.email, dias: parseInt(a.dias), ativo: a.ativo !== false });
                }
                const loaded = await fetchAlertasConfigSupabase();
                return loaded || [];
            } catch (_) {
                return JSON.parse(localStorage.getItem('alertasConfig')) || [];
            }
        }
        async function seedHistoricoIfEmpty() {
            try {
                const supa = await fetchHistoricoNotificacoesSupabase();
                if (supa && supa.length > 0) return supa;
                const local = JSON.parse(localStorage.getItem('historicoNotificacoes')) || [];
                if (!local || local.length === 0) return supa || [];
                for (const n of local) {
                    await insertHistoricoNotificacaoSupabase({ tipo: n.tipo || 'importado', titulo: n.titulo || '', mensagem: n.mensagem || '', destinatario: n.destinatario || '', usuario: n.usuario || '', enviado: !!n.enviado, erro: n.erro || null, quantidadeOS: n.quantidadeOS || 0 });
                }
                const loaded = await fetchHistoricoNotificacoesSupabase();
                return loaded || [];
            } catch (_) {
                return JSON.parse(localStorage.getItem('historicoNotificacoes')) || [];
            }
        }
        async function loadAlertas() {
            // S√≥ carrega se tiver acesso liberado
            if (!acessoAlertasLiberado) {
                abrirModalSenha();
                return;
            }
            let alertas = await fetchAlertasConfigSupabase();
            let notificacoes = await fetchHistoricoNotificacoesSupabase();
            if (!alertas || alertas.length === 0) alertas = await seedAlertasIfEmpty();
            if (!notificacoes || notificacoes.length === 0) notificacoes = await seedHistoricoIfEmpty();

            renderAlertasAtivos(alertas);
            renderHistoricoAlertas(notificacoes);
        }

        // Envia um e-mail de teste com os dados selecionados
        async function testarEnvioAlerta() {
            try {
                if (!EMAIL_SENDING_ENABLED) {
                    alert('Envio de e-mail est√° desativado no modo de ajustes.');
                    return;
                }
                if (!acessoAlertasLiberado) {
                    alert('Acesso negado. Digite a senha para usar os alertas.');
                    return;
                }
                const usuarioEl = document.getElementById('alerta-usuario');
                const emailEl = document.getElementById('alerta-email');
            const usuario = usuarioEl ? usuarioEl.value : '';
            const email = emailEl ? emailEl.value.trim() : '';
            if (!usuario || !email) {
                alert('Selecione um usu√°rio e informe o e-mail para teste.');
                return;
            }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i.test(email)) {
                alert('E-mail inv√°lido. Verifique o endere√ßo.');
                return;
            }
            const assunto = 'üß™ Teste de envio de Alerta';
            const mensagem = `Prezado(a) ${usuario},\n\nEste √© um e-mail de teste do Sistema de Controle de OS.\nSe voc√™ recebeu este e-mail, a configura√ß√£o do EmailJS est√° OK.\n\nAtenciosamente,\nSistema de Controle de OS`;
            const resultado = await enviarEmailReal(email, assunto, mensagem);
                if (resultado.success) {
                    alert('E-mail de teste enviado com sucesso!');
                } else {
                    alert('Falha ao enviar e-mail de teste: ' + (resultado.error || 'Erro desconhecido'));
                }
                await insertHistoricoNotificacaoSupabase({
                    tipo: 'teste_alerta',
                    titulo: assunto,
                    mensagem,
                    destinatario: email,
                    usuario,
                    enviado: !!resultado.success,
                    erro: resultado.error || null,
                    quantidadeOS: 0
                });
                await seedHistoricoIfEmpty();
                const notificacoes = await fetchHistoricoNotificacoesSupabase();
                renderHistoricoAlertas(notificacoes);
            } catch (err) {
                console.error('Erro no teste de envio:', err);
                alert('Erro inesperado no teste: ' + (err?.message || JSON.stringify(err)));
            }
        }

        function renderAlertasAtivos(alertas) {
            const container = document.getElementById('alertas-ativos');
            
            if (alertas.length === 0) {
                container.innerHTML = '<div class="empty-state">Nenhum alerta configurado</div>';
                return;
            }
            
            container.innerHTML = alertas.map((alerta, index) => `
                <div class="alert-item">
                    <div class="alert-info">
                        <strong>${alerta.usuario}</strong><br>
                        <small>E-mail: ${alerta.email} | Dias para alerta: ${alerta.dias}</small>
                    </div>
                    <div class="alert-actions">
                        <span class="alert-status ${alerta.ativo ? 'alert-active' : 'alert-inactive'}">${alerta.ativo ? 'Ativo' : 'Inativo'}</span>
                        <button class="btn btn-warning btn-sm" onclick="editarAlerta(${index})">Editar</button>
                        <button class="btn btn-danger btn-sm" onclick="removerAlerta(${index})">Remover</button>
                    </div>
                </div>
            `).join('');
        }
        
        function renderHistoricoAlertas(notificacoes) {
            const container = document.getElementById('historico-alertas');
            
            if (notificacoes.length === 0) {
                container.innerHTML = '<div class="empty-state">Nenhuma notifica√ß√£o enviada</div>';
                return;
            }
            
            function formatarDataBr(v) {
                try {
                    const d = new Date(v);
                    if (isNaN(d)) return String(v);
                    const pad = n => String(n).padStart(2,'0');
                    return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}, ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
                } catch(_) { return String(v); }
            }

            container.innerHTML = notificacoes.map(notificacao => `
                <div class="alert-item">
                    <div class="alert-info">
                        <strong>${notificacao.titulo}</strong><br>
                        <small>Para: ${notificacao.destinatario} | ${formatarDataBr(notificacao.data)} | ${notificacao.enviado ? 'Enviado' : 'Falha no envio'}</small>
                        <p>${notificacao.mensagem}</p>
                    </div>
                </div>
            `).join('');
        }

        async function showUserEventNotificationsIfAny() {
            try {
                if (sessionStorage.getItem('userEventNoticeShown') === 'true') return;
                const u = getCurrentUserInfo();
                if (!u) return;
                const nomeRaw = (u.nome_completo || u.usuario || '').trim();
                if (!nomeRaw) return;
                const normalize = (s) => String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
                const buildNameParts = (raw) => {
                    const byDot = raw.includes('.') ? raw.split('.') : raw.split(' ');
                    const parts = byDot.filter(Boolean).map(p => p.trim());
                    const full = parts.map(p=> p.charAt(0).toUpperCase()+p.slice(1)).join(' ');
                    const first = parts[0] ? parts[0].charAt(0).toUpperCase()+parts[0].slice(1) : '';
                    const last = parts.length>1 ? parts[parts.length-1].charAt(0).toUpperCase()+parts[parts.length-1].slice(1) : '';
                    return { full, first, last };
                };
                const { full: consultorFull, first: consultorFirst, last: consultorLast } = buildNameParts(nomeRaw);
                const table = (typeof tabelaBase !== 'undefined' && tabelaBase) ? tabelaBase : 'Base_OS';
                let data = [];
                let error = null;
                try {
                    // Consulta mais robusta usando OR por m√∫ltiplas varia√ß√µes do nome
                    const clause = [consultorFull, consultorFirst, consultorLast]
                        .filter(Boolean)
                        .map(k => `Consultor.ilike.%${k}%`) // Supabase 'or' syntax
                        .join(',');
                    const q = clause ? supabase.from(table).select('*').or(clause) : supabase.from(table).select('*');
                    const resp = await q;
                    data = resp.data || [];
                    error = resp.error || null;
                } catch (e) { error = e; }
                if (error) {
                    try {
                        const resp2 = await supabase.from(table).select('*');
                        data = resp2.data || [];
                    } catch(_) { data = []; }
                }
                const parados = [];
                const atrasados = [];
                const isParado = (st) => {
                    const s = String(st || '').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
                    return s === 'parado' || s === 'aguardando' || s.includes('pendente');
                };
                (data||[]).forEach(os => {
                    const consultorCell = normalize(os.Consultor);
                    const matchFull = consultorFull ? consultorCell.includes(normalize(consultorFull)) : false;
                    const matchFirst = consultorFirst ? consultorCell.includes(normalize(consultorFirst)) : false;
                    const matchLast = consultorLast ? consultorCell.includes(normalize(consultorLast)) : false;
                    const matchesUser = matchFull || (matchFirst && matchLast) || matchFirst || matchLast;
                    if (!matchesUser) return;
                    const st = (extrairStatusDaObservacao(os.Observacao)||'').toLowerCase();
                    const dias = calcularDiasEmAberto(os);
                    const tab = (os.Tipo||'externa').toLowerCase();
                    const esc = getEscalonamento(tab, dias, os.Revenda);
                    const limit = getEscalonamentoLimit(tab, esc, os.Revenda);
                    if (isParado(st)) parados.push(os);
                    if (dias >= limit) atrasados.push(os);
                });
                const pCount = parados.length;
                const aCount = atrasados.length;
                if (pCount===0 && aCount===0) return;
                let container = document.getElementById('dashboard-notification-cards');
                if (!container) {
                    const dash = document.getElementById('dashboard');
                    const filtersEl = dash ? dash.querySelector('.dashboard-filters') : null;
                    container = document.createElement('div');
                    container.id = 'dashboard-notification-cards';
                    container.className = 'dashboard-grid';
                    if (dash && filtersEl) dash.insertBefore(container, filtersEl); else document.body.appendChild(container);
                }
                container.innerHTML = '';
                const numerosParados = parados.slice(0,12).map(os => os['Numero OS'] || os['Nro OS'] || '').filter(Boolean);
                const numerosAtrasados = atrasados.slice(0,12).map(os => os['Numero OS'] || os['Nro OS'] || '').filter(Boolean);

                if (pCount > 0) {
                    const cardParados = document.createElement('div');
                    cardParados.className = 'dashboard-card';
                    cardParados.style.borderLeft = '4px solid #ffc107';
                    cardParados.innerHTML = `<h3>üîî Eventos Parados</h3>
                    <div style="margin-bottom:8px;"><strong>${consultorFull || nomeRaw}</strong></div>
                    <div style="font-size:28px; font-weight:700; color:#333;">${pCount}</div>
                    <div style="font-size:12px; color:#555; margin-top:6px;">OS: ${numerosParados.join(', ')}</div>
                    <div style="margin-top:10px; display:flex; gap:8px;">
                        <button class="btn btn-primary" id="btn-ver-parados">Ver OS</button>
                    </div>`;
                    container.appendChild(cardParados);
                    const btnParados = cardParados.querySelector('#btn-ver-parados');
                    if (btnParados) btnParados.addEventListener('click', () => { try { mostrarModalListaOS(numerosParados); } catch(_) {} });
                }

                if (aCount > 0) {
                    const cardAtrasados = document.createElement('div');
                    cardAtrasados.className = 'dashboard-card';
                    cardAtrasados.style.borderLeft = '4px solid #dc3545';
                    cardAtrasados.innerHTML = `<h3>‚è∞ Eventos Fora do Prazo</h3>
                    <div style="margin-bottom:8px;"><strong>${consultorFull || nomeRaw}</strong></div>
                    <div style="font-size:28px; font-weight:700; color:#333;">${aCount}</div>
                    <div style="font-size:12px; color:#555; margin-top:6px;">OS: ${numerosAtrasados.join(', ')}</div>
                    <div style="margin-top:10px; display:flex; gap:8px;">
                        <button class="btn btn-primary" id="btn-ver-atrasados">Ver OS</button>
                    </div>`;
                    container.appendChild(cardAtrasados);
                    const btnAtrasados = cardAtrasados.querySelector('#btn-ver-atrasados');
                    if (btnAtrasados) btnAtrasados.addEventListener('click', () => { try { mostrarModalListaOS(numerosAtrasados); } catch(_) {} });
                }
                sessionStorage.setItem('userEventNoticeShown', 'true');
            } catch(_) {}
        }
        
        async function configurarAlerta() {
            // Verifica se tem acesso
            if (!acessoAlertasLiberado) {
                abrirModalSenha();
                return;
            }
            
            const usuarioEl = document.getElementById('alerta-usuario');
            const emailEl = document.getElementById('alerta-email');
            const diasEl = document.getElementById('alerta-dias');
            const usuario = usuarioEl ? usuarioEl.value : '';
            const email = emailEl ? emailEl.value.trim() : '';
            const dias = diasEl ? diasEl.value : '';
            
            if (!usuario || !email || !dias) {
                alert('Preencha todos os campos!');
                return;
            }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i.test(email)) {
                alert('E-mail inv√°lido. Verifique o endere√ßo.');
                return;
            }
            await upsertAlertaSupabase({
                usuario,
                email,
                dias: parseInt(dias),
                ativo: true
            });
            
            // Atualiza a lista
            const alertasAtualizados = await fetchAlertasConfigSupabase();
            renderAlertasAtivos(alertasAtualizados);
            
            alert('Alerta configurado com sucesso!');
            
            // Limpa os campos
            if (usuarioEl) usuarioEl.value = '';
            if (emailEl) emailEl.value = '';
            if (diasEl) diasEl.value = '5';
        }
        
        async function editarAlerta(index) {
            // Verifica se tem acesso
            if (!acessoAlertasLiberado) {
                abrirModalSenha();
                return;
            }
            
            const alertas = await fetchAlertasConfigSupabase();
            const alerta = alertas[index];
            
            const usuarioEl = document.getElementById('alerta-usuario');
            const emailEl = document.getElementById('alerta-email');
            const diasEl = document.getElementById('alerta-dias');
            if (usuarioEl) usuarioEl.value = alerta.usuario;
            if (emailEl) emailEl.value = alerta.email;
            if (diasEl) diasEl.value = alerta.dias;
            
            const lista = await fetchAlertasConfigSupabase();
            renderAlertasAtivos(lista);
        }
        
        async function removerAlerta(index) {
            // Verifica se tem acesso
            if (!acessoAlertasLiberado) {
                abrirModalSenha();
                return;
            }
            
            if (!confirm('Deseja realmente remover este alerta?')) return;
            
            const alertas = await fetchAlertasConfigSupabase();
            const alvo = alertas[index];
            if (alvo && alvo.usuario) await deleteAlertaSupabase(alvo.usuario);
            const lista = await fetchAlertasConfigSupabase();
            renderAlertasAtivos(lista);
        }

        // Adicionar evento de tecla Enter no campo de senha
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('password-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    verificarSenha();
                }
            });
        });

    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.custom-select').forEach(setupCustomSelect);
        });

        function setupCustomSelect(selectElement) {
            const wrapper = selectElement.parentElement;
            const selected = document.createElement('div');
            selected.className = 'select-selected';
            selected.innerHTML = selectElement.options[selectElement.selectedIndex].innerHTML;
            wrapper.appendChild(selected);

            const items = document.createElement('div');
            items.className = 'select-items select-hide';
            for (let i = 0; i < selectElement.length; i++) {
                const option = document.createElement('div');
                option.innerHTML = selectElement.options[i].innerHTML;
                option.addEventListener('click', function() {
                    selectElement.selectedIndex = i;
                    selected.innerHTML = this.innerHTML;
                    closeAllSelect();
                });
                items.appendChild(option);
            }
            wrapper.appendChild(items);

            selected.addEventListener('click', function(e) {
                e.stopPropagation();
                closeAllSelect(this);
                items.classList.toggle('select-hide');
                this.classList.toggle('select-arrow-active');
            });
        }

        function closeAllSelect(elmnt) {
            const items = document.getElementsByClassName('select-items');
            const selected = document.getElementsByClassName('select-selected');
            for (let i = 0; i < selected.length; i++) {
                if (elmnt !== selected[i]) {
                    selected[i].classList.remove('select-arrow-active');
                }
            }
            for (let i = 0; i < items.length; i++) {
                if (elmnt !== selected[i]) {
                    items[i].classList.add('select-hide');
                }
            }
        }

        document.addEventListener('click', closeAllSelect);

        // --- Retornar ao respons√°vel ---
        const MANAGERS = ['Isabelle', 'Ana Leya', 'Bruna', 'Johnny', 'Graziela', 'Ant√¥nio Gustavo', 'Wanderley'];

        function parseTransferInfo(text) {
            if (!text) return null;
            const match = text.match(/\(Transferido de (.+?) para (.+?)\)/);
            if (match) {
                return { from: match[1], to: match[2] };
            }
            return null;
        }

        function retornarResponsavel(tab) {
            const checkboxes = document.querySelectorAll(`.transfer-checkbox-${tab}:checked`);
            if (checkboxes.length === 0) {
                alert('Selecione pelo menos uma OS para retornar.');
                return;
            }

            const keys = Array.from(checkboxes).map(cb => cb.value);
            let updated = 0;

            keys.forEach(key => {
                const os = findOSByKey(key);
                if (!os) return;
                const info = parseTransferInfo(os.Observacao || '');
                const dias = calcularDiasEmAberto(os);
                const currentEsc = getEscalonamento(tab, dias, os.Revenda);

                // Restringe retorno apenas quando o escalonamento atual √© de um gestor
                if (!MANAGERS.includes(currentEsc)) return;

                const from = info ? info.from : currentEsc;
                const to = info ? info.to : currentEsc;

                const observacaoBase = extrairObservacaoSemStatus(os.Observacao) || '';
                os.Observacao = `(Retornado para ${from} de ${to}) ${observacaoBase}`.trim();
                updated++;
            });

            if (updated > 0) {
                saveOSData();
                populateTransferenciaTables();
                filterAndDisplayData(tab);
                alert(`${updated} OS(s) retornada(s) ao respons√°vel.`);
            } else {
                alert('Nenhuma OS eleg√≠vel para retorno (somente gestores).');
            }
        }
    </script>
</body>
</html>

            <div class="tab-content" id="transferencia-escalonamento">
                <div class="tabs-container">
                    <div class="tabs">
                        <div class="tab active" data-tab="transferencia-externa">Externa</div>
                        <div class="tab" data-tab="transferencia-interna">Interna</div>
                        <div class="tab" data-tab="transferencia-garantia">Garantia</div>
                    </div>

                    <div class="tab-content active" id="transferencia-externa">
                        <div class="filters">
                            <div class="filter-group">
                                <label for="transfer-to-externa">Transferir para:</label>
                                <div class="custom-select-wrapper">
                                    <select id="transfer-to-externa" class="custom-select">
                                        <option value="Isabelle">Isabelle</option>
                                        <option value="Ana Leya">Ana Leya</option>
                                        <option value="Bruna">Bruna</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary" onclick="transferirEscalonamento('externa')">Transferir</button>
                                <button class="btn btn-secondary" onclick="retornarResponsavel('externa')">Retornar ao respons√°vel</button>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Revenda</label>
                                <select class="filter-select" id="transfer-filter-revenda-externa">
                                    <option value="">Todos</option>
                                    <option value="1">Recife</option>
                                    <option value="2">Natal</option>
                                    <option value="3">Fortaleza</option>
                                    <option value="4">Petrolina</option>
                                </select>
                                <label class="filter-label">Situa√ß√£o OS</label>
                                <select class="filter-select" id="transfer-filter-status-externa">
                                    <option value="Aberta" selected>Aberta</option>
                                    <option value="Fechada">Fechada</option>
                                    <option value="Todos">Todos</option>
                                </select>
                            </div>
                        </div>
                        <table id="table-transferencia-externa">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="select-all-transferencia-externa"></th>
                                    <th>Revenda</th>
                                    <th>Nro. OS</th>
                                    <th>Situa√ß√£o OS</th>
                                    <th>Data Abertura</th>
                                    <th>Dias</th>
                                    <th>Status</th>
                                    <th>Escalonamento</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-transferencia-externa">
                                <!-- Dados da OS Externa para transfer√™ncia -->
                            </tbody>
                        </table>
                    </div>
                    <div class="tab-content" id="transferencia-interna">
                        <div class="filters">
                            <div class="filter-group">
                                <label for="transfer-to-interna">Transferir para:</label>
                                <div class="custom-select-wrapper">
                                    <select id="transfer-to-interna" class="custom-select">
                                        <option value="Isabelle">Isabelle</option>
                                        <option value="Ana Leya">Ana Leya</option>
                                        <option value="Bruna">Bruna</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary" onclick="transferirEscalonamento('interna')">Transferir</button>
                                <button class="btn btn-secondary" onclick="retornarResponsavel('interna')">Retornar ao respons√°vel</button>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Revenda</label>
                                <select class="filter-select" id="transfer-filter-revenda-interna">
                                    <option value="">Todos</option>
                                    <option value="1">Recife</option>
                                    <option value="2">Natal</option>
                                    <option value="3">Fortaleza</option>
                                    <option value="4">Petrolina</option>
                                </select>
                                <label class="filter-label">Situa√ß√£o OS</label>
                                <select class="filter-select" id="transfer-filter-status-interna">
                                    <option value="Aberta" selected>Aberta</option>
                                    <option value="Fechada">Fechada</option>
                                    <option value="Todos">Todos</option>
                                </select>
                            </div>
                        </div>
                        <table id="table-transferencia-interna">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="select-all-transferencia-interna"></th>
                                    <th>Revenda</th>
                                    <th>Nro. OS</th>
                                    <th>Situa√ß√£o OS</th>
                                    <th>Data Abertura</th>
                                    <th>Dias</th>
                                    <th>Status</th>
                                    <th>Escalonamento</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-transferencia-interna">
                                <!-- Dados da OS Interna para transfer√™ncia -->
                            </tbody>
                        </table>
                    </div>
                    <div class="tab-content" id="transferencia-garantia">
                        <div class="filters">
                            <div class="filter-group">
                                <label for="transfer-to-garantia">Transferir para:</label>
                                <div class="custom-select-wrapper">
                                    <select id="transfer-to-garantia" class="custom-select">
                                        <option value="Fl√°via">Fl√°via</option>
                                        <option value="Giovana">Giovana</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary" onclick="transferirEscalonamento('garantia')">Transferir</button>
                                <button class="btn btn-secondary" onclick="retornarResponsavel('garantia')">Retornar ao respons√°vel</button>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Revenda</label>
                                <select class="filter-select" id="transfer-filter-revenda-garantia">
                                    <option value="">Todos</option>
                                    <option value="1">Recife</option>
                                    <option value="2">Natal</option>
                                    <option value="3">Fortaleza</option>
                                    <option value="4">Petrolina</option>
                                </select>
                                <label class="filter-label">Situa√ß√£o OS</label>
                                <select class="filter-select" id="transfer-filter-status-garantia">
                                    <option value="Aberta" selected>Aberta</option>
                                    <option value="Fechada">Fechada</option>
                                    <option value="Todos">Todos</option>
                                </select>
                            </div>
                        </div>
                        <table id="table-transferencia-garantia">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="select-all-transferencia-garantia"></th>
                                    <th>Revenda</th>
                                    <th>Nro. OS</th>
                                    <th>Situa√ß√£o OS</th>
                                    <th>Data Abertura</th>
                                    <th>Dias</th>
                                    <th>Status</th>
                                    <th>Escalonamento</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-transferencia-garantia">
                                <!-- Dados da OS Garantia para transfer√™ncia -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        <script>
        async function verificarAlertasUnificados() {
            try {
                const { data, error } = await supabase.from(tabelaBase).select('*');
                if (error) throw error;
                let alertas = await fetchAlertasConfigSupabase();
                if (!alertas || alertas.length === 0) {
                    try { alertas = await seedAlertasIfEmpty(); } catch(_) {}
                }
                const notificacoes = await fetchHistoricoNotificacoesSupabase();
                const historicoAtual = {};
                const processed = new Set();
                // estado atual para detectar mudan√ßas de escalonamento
                data.forEach(os => {
                    const situacao = String(os['Situacao OS'] || '').toLowerCase();
                    if (!situacao.includes('abert')) return;
                    const dias = calcularDiasEmAberto(os);
                    const escalonamentoAtual = getEscalonamento(os.Tipo?.toLowerCase() || 'externa', dias, os.Revenda);
                    historicoAtual[os.Chave || os.Cahve] = escalonamentoAtual;
                });

                for (const alerta of alertas) {
                    if (!alerta.ativo) continue;
                    if (isExcludedAlertUser(alerta.usuario) || isExcludedAlertUser(alerta.email)) continue;
                    const key = `${alerta.usuario}|${alerta.email}`;
                    if (processed.has(key)) continue;

                    // Pr√≥ximas de escalonamento
                    const osProximas = data.filter(os => {
                        const dias = calcularDiasEmAberto(os);
                        const tipo = os.Tipo?.toLowerCase() || 'externa';
                        const atual = getEscalonamento(tipo, dias, os.Revenda);
                        const proximo = getProximoEscalonamento(tipo, dias, os.Revenda);
                        const situacao = String(os['Situacao OS'] || '').toLowerCase();
                        if (!situacao.includes('abert')) return false;
                        if (normalizeNomeResponsavel(alerta.usuario) === normalizeNomeResponsavel('Ant√¥nio Gustavo')) {
                            return atual !== alerta.usuario && proximo === alerta.usuario && dias >= (getLimiteEscalonamento(tipo, alerta.usuario) - parseInt(alerta.dias));
                        }
                        return atual === alerta.usuario && proximo !== alerta.usuario && dias >= (getLimiteEscalonamento(tipo, alerta.usuario) - parseInt(alerta.dias));
                    });
                    // Excluir j√° notificados neste tipo
                    let osProximasNovas = [];
                    if (osProximas.length) {
                        const prevSetP = await getPreviouslyNotifiedOSNumbers({ tipo: 'alerta_escalonamento_proximo', usuario: alerta.usuario, destinatario: alerta.email, windowMinutes: null, limit: 500 });
                        osProximasNovas = osProximas.filter(os => {
                            const n = String(os['Numero OS']||'').trim();
                            return n && !prevSetP.has(n);
                        });
                    }

                    // Novas escalonadas
                    const osEscalonadas = data.filter(os => {
                        const dias = calcularDiasEmAberto(os);
                        const tipo = os.Tipo?.toLowerCase() || 'externa';
                        const atual = getEscalonamento(tipo, dias, os.Revenda);
                        const anterior = historicoEscalonamento[os.Chave || os.Cahve];
                        const situacao = String(os['Situacao OS'] || '').toLowerCase();
                        if (!situacao.includes('abert')) return false;
                        const allowedPrevious = getAllowedPrevious(alerta.usuario, tipo, os.Revenda, dias);
                        let prevOk = false;
                        if (allowedPrevious) {
                            const anteriorNorm = normalizeNomeResponsavel(anterior);
                            const allowedNorm = normalizeNomeResponsavel(allowedPrevious);
                            if (anteriorNorm) {
                                prevOk = anteriorNorm === allowedNorm;
                            } else {
                                const prevByDias = getPrevEscalonamentoByDias(tipo, dias, os.Revenda);
                                prevOk = normalizeNomeResponsavel(prevByDias) === allowedNorm;
                            }
                        } else {
                            prevOk = normalizeNomeResponsavel(anterior) !== normalizeNomeResponsavel(alerta.usuario);
                        }
                        return normalizeNomeResponsavel(atual) === normalizeNomeResponsavel(alerta.usuario) && prevOk;
                    });
                    let osEscalonadasNovas = [];
                    if (osEscalonadas.length) {
                        const prevSetE = await getPreviouslyNotifiedOSNumbers({ tipo: 'nova_os_escalonada', usuario: alerta.usuario, destinatario: alerta.email, windowMinutes: null, limit: 500 });
                        osEscalonadasNovas = osEscalonadas.filter(os => {
                            const n = String(os['Numero OS']||'').trim();
                            return n && !prevSetE.has(n);
                        });
                    }

                    const totalNovas = osEscalonadasNovas.length;
                    const totalProx = osProximasNovas.length;
                    if (totalNovas === 0 && totalProx === 0) continue;

                    const setAll = Array.from(new Set(
                        osEscalonadasNovas.concat(osProximasNovas).map(os => String(os['Numero OS']||'').trim()).filter(Boolean)
                    ));
                    const fpAll = setAll.slice().sort((a,b)=>a.localeCompare(b)).join(',');
                    const titulo = `Alerta de Escalonamento - Sistema OS NORMAQ`;
                    let msgText = `Prezado(a) ${alerta.usuario},\n\n`;
                    let msgHtml = `<p>Prezado(a) ${alerta.usuario},</p>`;
                    if (totalNovas) {
                        msgText += `Voc√™ recebeu ${totalNovas} nova(s) OS escalonada(s):\n\n`;
                        msgHtml += `<p>Voc√™ recebeu <strong>${totalNovas}</strong> nova(s) OS escalonada(s):</p><ul>`;
                        osEscalonadasNovas.forEach(os => {
                            const anterior = historicoEscalonamento[os.Chave || os.Cahve] || 'N/A';
                            const dias = calcularDiasEmAberto(os);
                            msgText += `‚Ä¢ OS ${os['Numero OS']} - ${os.Cliente || 'N/A'} (Tipo: ${os.Tipo || '‚Äî'})\n  Respons√°vel anterior: ${anterior}\n  Dias em aberto: ${dias} dias\n\n`;
                            msgHtml += `<li><strong>OS ${os['Numero OS']}</strong> - ${os.Cliente || 'N/A'} <em>(Tipo: ${os.Tipo || '‚Äî'})</em><br><small>Respons√°vel anterior: ${anterior} ‚Ä¢ Dias em aberto: ${dias} dias</small></li>`;
                        });
                        msgHtml += `</ul>`;
                    }
                    if (totalProx) {
                        msgText += `Voc√™ possui ${totalProx} OS pr√≥xima(s) de escalonamento:\n\n`;
                        msgHtml += `<p>Voc√™ possui <strong>${totalProx}</strong> OS pr√≥xima(s) de escalonamento:</p><ul>`;
                        osProximasNovas.forEach(os => {
                            const tipo = os.Tipo?.toLowerCase() || 'externa';
                            const dias = calcularDiasEmAberto(os);
                            const proximo = getProximoEscalonamento(tipo, dias, os.Revenda);
                            const falta = getLimiteEscalonamento(tipo, alerta.usuario) - dias;
                            msgText += `‚Ä¢ OS ${os['Numero OS']} - ${os.Cliente || 'N/A'} (Tipo: ${os.Tipo || '‚Äî'} | Pr√≥ximo: ${proximo} | Dias: ${falta})\n`;
                            msgHtml += `<li><strong>OS ${os['Numero OS']}</strong> - ${os.Cliente || 'N/A'} <em>(Tipo: ${os.Tipo || '‚Äî'} | Pr√≥ximo: ${proximo} | Dias: ${falta})</em></li>`;
                        });
                        msgHtml += `</ul>`;
                    }
                    msgText += `Por favor, verifique e assuma as a√ß√µes necess√°rias.\nAtenciosamente,\nSistema de Controle de OS`;
                    msgHtml += `<p>Por favor, verifique e assuma as a√ß√µes necess√°rias.</p><p><strong>Atenciosamente,</strong><br>Sistema de Controle de OS</p>`;

                    // Pr√©-registro para evitar corrida entre clientes: grava fingerprint imediatamente
                    try {
                        const regPre = { tipo: 'alerta_unico_usuario_pre', titulo, mensagem: `${msgText}\nFP[os=${fpAll}]`, destinatario: alerta.email, usuario: alerta.usuario, enviado: false, erro: null, quantidadeOS: setAll.length };
                        await insertHistoricoNotificacaoSupabase(regPre);
                    } catch(_) {}

                    const cooldownAny = await shouldCooldownAnySend({ usuario: alerta.usuario, destinatario: alerta.email, minutes: 60 });
                    let skip = cooldownAny
                        || await isUserSendLocked({ tipo: 'alerta_unico_usuario', usuario: alerta.usuario, windowMinutes: 2 })
                        || await shouldSkipNotificationByOSSet({ tipo: 'alerta_unico_usuario', usuario: alerta.usuario, destinatario: alerta.email, osNumbers: setAll, windowMinutes: null })
                        || await shouldSkipNotification({ tipo: 'alerta_unico_usuario', usuario: alerta.usuario, destinatario: alerta.email, titulo, mensagem: msgText, windowMinutes: 180 });
                    if (!skip) {
                        setUserSendLock({ tipo: 'alerta_unico_usuario', usuario: alerta.usuario });
                        await sleep(500 + Math.floor(Math.random()*2500));
                        const recheck = await shouldSkipNotificationByOSSet({ tipo: 'alerta_unico_usuario', usuario: alerta.usuario, destinatario: alerta.email, osNumbers: setAll, windowMinutes: null })
                            || await shouldSkipNotification({ tipo: 'alerta_unico_usuario', usuario: alerta.usuario, destinatario: alerta.email, titulo, mensagem: msgText, windowMinutes: 180 });
                        if (recheck) skip = true;
                    }

                    const resultadoEnvio = skip ? { success: false, error: 'duplicate-skip' } : await enviarEmailReal(alerta.email, titulo, msgHtml);
                    // Registrar hist√≥rico por tipo, para manter rastreabilidade
                    if (totalNovas) {
                        const fpE = osEscalonadasNovas.map(os => String(os['Numero OS']||'').trim()).filter(Boolean).sort((a,b)=>a.localeCompare(b)).join(',');
                        const regE = { tipo: 'nova_os_escalonada', titulo: 'üîÑ Nova OS Escalonada para Voc√™', mensagem: `${msgText}\nFP[os=${fpE}]`, destinatario: alerta.email, usuario: alerta.usuario, enviado: !!resultadoEnvio.success, erro: resultadoEnvio.error || null, quantidadeOS: totalNovas };
                        notificacoes.push({ ...regE, data: new Date().toLocaleString('pt-BR') });
                        await insertHistoricoNotificacaoSupabase(regE);
                    }
                    if (totalProx) {
                        const fpP = osProximasNovas.map(os => String(os['Numero OS']||'').trim()).filter(Boolean).sort((a,b)=>a.localeCompare(b)).join(',');
                        const regP = { tipo: 'alerta_escalonamento_proximo', titulo: '‚ö†Ô∏è Alerta: OS Pr√≥xima de Escalonamento', mensagem: `${msgText}\nFP[os=${fpP}]`, destinatario: alerta.email, usuario: alerta.usuario, enviado: !!resultadoEnvio.success, erro: resultadoEnvio.error || null, quantidadeOS: totalProx };
                        notificacoes.push({ ...regP, data: new Date().toLocaleString('pt-BR') });
                        await insertHistoricoNotificacaoSupabase(regP);
                    }
                    // tamb√©m registra o agregado para fingerprint futuro
                    const regAll = { tipo: 'alerta_unico_usuario', titulo, mensagem: `${msgText}\nFP[os=${fpAll}]`, destinatario: alerta.email, usuario: alerta.usuario, enviado: !!resultadoEnvio.success, erro: resultadoEnvio.error || null, quantidadeOS: setAll.length };
                    notificacoes.push({ ...regAll, data: new Date().toLocaleString('pt-BR') });
                    await insertHistoricoNotificacaoSupabase(regAll);

                    processed.add(key);
                }

                // Atualiza hist√≥rico de escalonamento e UI
                historicoEscalonamento = historicoAtual;
                localStorage.setItem('historicoEscalonamento', JSON.stringify(historicoEscalonamento));
                const historicoFinal = await fetchHistoricoNotificacoesSupabase();
                renderHistoricoAlertas(historicoFinal);
            } catch (e) {
                console.error('Erro no alerta unificado:', e);
            }
        }
        </script>
